{% comment %}
  Invicta Tools – Card Product (v2.0 · Search Results Upgrade)
  ------------------------------------------------------------
  IMPROVEMENTS:
  • Star ratings display (uses product metafield or Judge.me)
  • SALE badge on discounted products
  • Quick-add to cart button on hover
  • Improved sale price visibility (larger strikethrough)
  • Clean, accessible structure
{% endcomment %}

{% liquid
  assign product = card_product | default: product
%}

{% if product %}
  <div class="invicta-card-wrapper card-wrapper" data-product-id="{{ product.id }}">
    <div class="invicta-card">

      {%- comment -%} IMAGE BLOCK {%- endcomment -%}
      <a href="{{ product.url }}" class="invicta-card-image-wrapper">
        {% assign featured = product.featured_media %}
        {% if featured %}
          {{ featured
            | image_url: width: 700
            | image_tag:
              loading: 'lazy',
              class: 'invicta-card-image',
              alt: product.title | escape
          }}
        {% else %}
          {%- comment -%} FIX: Use asset URL instead of invalid placeholder_svg_tag {%- endcomment -%}
          <img 
            src="{{ 'placeholder-image.svg' | asset_url }}" 
            class="invicta-card-image" 
            alt="Product image placeholder"
            loading="lazy"
            width="700"
            height="700"
          >
        {% endif %}

        {%- comment -%} SALE BADGE — top left corner {%- endcomment -%}
        {% if product.compare_at_price > product.price %}
          {% assign savings_percent = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round %}
          <span class="invicta-card-sale-badge">
            SAVE {{ savings_percent }}%
          </span>
        {% endif %}

  
      </a>

      {%- comment -%}
        BRAND PILL ROW — sits BEFORE padded .invicta-card-content
        This ensures:
        • perfect mask alignment
        • no double padding
        • correct overlap (~50%) of divider
      {%- endcomment -%}
      {% if product.vendor %}
        <div class="invicta-card-brand-row">
          {% render 'invicta-brand-pill',
            product: product,
            context: 'card',
            size: 'md',
            show_badge: true,
            show_score_bar: true
          %}
        </div>
      {% endif %}

      {%- comment -%} CONTENT AREA {%- endcomment -%}
      <div class="invicta-card-content">

        <h3 class="invicta-card-title">
          <a href="{{ product.url }}">
            {{ product.title }}
          </a>
        </h3>

        {%- comment -%} STAR RATINGS — Judge.me or metafield {%- endcomment -%}
        {% liquid
          assign rating_value = product.metafields.reviews.rating.value | default: product.metafields.judgeme.rating | default: nil
          assign rating_count = product.metafields.reviews.rating_count.value | default: product.metafields.judgeme.review_count | default: 0
        %}
        {% if rating_value != nil and rating_value > 0 %}
          {%- liquid
            assign full_stars = rating_value | floor
            assign half_star = rating_value | modulo: 1
            assign half_star_position = full_stars | plus: 1
          -%}
          <div class="invicta-card-rating" aria-label="Rated {{ rating_value }} out of 5 stars">
            <div class="invicta-card-stars">
              {%- comment -%} Render 5 stars {%- endcomment -%}
              {% for i in (1..5) %}
                {%- liquid
                  assign is_full = false
                  assign is_half = false
                  if i <= full_stars
                    assign is_full = true
                  elsif i == half_star_position and half_star >= 0.5
                    assign is_half = true
                  endif
                -%}
                {% if is_full %}
                  <svg class="star star--full" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                {% elsif is_half %}
                  <svg class="star star--half" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><defs><linearGradient id="half-{{ product.id }}"><stop offset="50%" stop-color="currentColor"/><stop offset="50%" stop-color="#d1d5db"/></linearGradient></defs><path fill="url(#half-{{ product.id }})" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                {% else %}
                  <svg class="star star--empty" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#d1d5db"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                {% endif %}
              {% endfor %}
            </div>
            {% if rating_count > 0 %}
              <span class="invicta-card-rating-count">({{ rating_count }})</span>
            {% endif %}
          </div>
        {% endif %}

        {%- comment -%} PRICE LOGIC — Enhanced sale display {%- endcomment -%}
        {% liquid
          assign main_price    = product.price
          assign compare_price = product.compare_at_price
          assign on_sale       = false
          if compare_price > main_price
            assign on_sale = true
          endif
        %}

        <div class="invicta-price-row{% if on_sale %} invicta-price-row--sale{% endif %}">
          <span class="invicta-price-main{% if on_sale %} invicta-price-main--sale{% endif %}">
            {{ main_price | money }}
          </span>

          {% if on_sale %}
            <span class="invicta-price-compare">
              {{ compare_price | money }}
            </span>
          {% endif %}
        </div>

        {%- comment -%} DUAL BUTTON ROW {%- endcomment -%}
        <div class="invicta-card-buttons">
          <a href="{{ product.url }}" class="invicta-btn invicta-btn--outline">
            See More
          </a>
          {% if product.available %}
            <button
              type="button"
              class="invicta-btn invicta-btn--solid invicta-quick-add-pill"
              data-variant-id="{{ product.selected_or_first_available_variant.id }}"
              data-product-url="{{ product.url }}"
              aria-label="Add {{ product.title | escape }} to cart"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
              </svg>
              <span>Add</span>
            </button>
          {% else %}
            <span class="invicta-btn invicta-btn--disabled">
              Sold Out
            </span>
          {% endif %}
        </div>

      </div> <!-- /.invicta-card-content -->

    </div> <!-- /.invicta-card -->
  </div> <!-- /.invicta-card-wrapper -->
{% endif %}