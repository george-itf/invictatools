{% comment %}
  ==========================================================================
   INVICTA BRAND PILL ENGINE — v5.1 (WITH DOT MODE)
  --------------------------------------------------------------------------
   • Logos loaded from theme assets as {brand_key}.svg
   • Uses background-image logo (mobile-safe) + invisible <img> for SEO/preload
   • If the asset fails, falls back to readable text
   • NEW: type: 'dot' renders just a coloured circle (for filter buttons)
   
   USAGE:
   {% render 'invicta-brand-pill', vendor: 'Makita' %}
   {% render 'invicta-brand-pill', vendor: collection.handle, url: collection.url %}
   {% render 'invicta-brand-pill', product: product, pill_size: 'lg' %}
   {% render 'invicta-brand-pill', vendor: 'DeWalt', type: 'dot' %}
   {% render 'invicta-brand-pill', vendor: 'DeWalt', type: 'text-only' %}
  ==========================================================================
{% endcomment %}

{%- liquid
  # =========================================================================
  # STEP 1: GET VENDOR NAME
  # =========================================================================
  assign brand_product = product | default: card_product

  if brand_product
    assign vendor_raw = brand_product.vendor | default: vendor
  else
    assign vendor_raw = vendor
  endif

  assign vendor_raw = vendor_raw | strip
  assign vendor_clean = vendor_raw | downcase
  assign brand_key = vendor_clean
  assign brand_display = vendor_raw

  # =========================================================================
  # STEP 2: NORMALISE BRAND KEY
  # =========================================================================
  if vendor_clean contains 'dewalt'
    assign brand_key = 'dewalt'
  elsif vendor_clean contains 'makita'
    assign brand_key = 'makita'
  elsif vendor_clean contains 'milwaukee'
    assign brand_key = 'milwaukee'
  elsif vendor_clean contains 'hikoki'
    assign brand_key = 'hikoki'
  elsif vendor_clean contains 'stanley'
    assign brand_key = 'stanley'
  elsif vendor_clean contains 'faithfull'
    assign brand_key = 'faithfull'
  elsif vendor_clean contains 'irwin' or vendor_clean contains 'marples' or vendor_clean contains 'vise-grip' or vendor_clean contains 'quick-grip'
    assign brand_key = 'irwin'
  elsif vendor_clean contains 'bosch'
    assign brand_key = 'bosch'
  elsif vendor_clean contains 'metabo'
    assign brand_key = 'metabo'
  elsif vendor_clean contains 'einhell'
    assign brand_key = 'einhell'
  elsif vendor_clean contains 'panasonic'
    assign brand_key = 'panasonic'
  elsif vendor_clean contains 'paslode'
    assign brand_key = 'paslode'
  elsif vendor_clean contains 'soudal'
    assign brand_key = 'soudal'
  elsif vendor_clean contains 'sealey'
    assign brand_key = 'sealey'
  elsif vendor_clean == 'ox' or vendor_clean contains 'ox tools'
    assign brand_key = 'ox'
  elsif vendor_clean contains 'evostik' or vendor_clean contains 'evo-stik' or vendor_clean contains 'evo stik'
    assign brand_key = 'evostik'
  elsif vendor_clean contains 'ob1' or vendor_clean contains 'ob-1'
    assign brand_key = 'ob1'
  elsif vendor_clean contains 'ct1'
    assign brand_key = 'ct1'
  elsif vendor_clean contains 'everbuild'
    assign brand_key = 'everbuild'
  elsif vendor_clean contains 'siroflex'
    assign brand_key = 'siroflex'
  elsif vendor_clean contains 'timco'
    assign brand_key = 'timco'
  elsif vendor_clean contains 'bahco'
    assign brand_key = 'bahco'
  elsif vendor_clean contains 'wera'
    assign brand_key = 'wera'
  elsif vendor_clean contains 'knipex'
    assign brand_key = 'knipex'
  elsif vendor_clean contains 'trend'
    assign brand_key = 'trend'
  elsif vendor_clean contains 'lamello'
    assign brand_key = 'lamello'
  elsif vendor_clean contains 'kamtec'
    assign brand_key = 'kamtec'
  elsif vendor_clean contains 'premier' and vendor_clean contains 'diamond'
    assign brand_key = 'pdp'
  elsif vendor_clean == 'pdp'
    assign brand_key = 'pdp'
  elsif vendor_clean contains 'sitetuff' or vendor_clean contains 'site tuff'
    assign brand_key = 'sitetuff'
  elsif vendor_clean contains 'roughneck'
    assign brand_key = 'roughneck'
  elsif vendor_clean contains 'estwing'
    assign brand_key = 'estwing'
  elsif vendor_clean contains 'starrett'
    assign brand_key = 'starrett'
  elsif vendor_clean contains 'stabila'
    assign brand_key = 'stabila'
  elsif vendor_clean contains 'hultafors'
    assign brand_key = 'hultafors'
  elsif vendor_clean contains 'draper'
    assign brand_key = 'draper'
  elsif vendor_clean contains 'silverline'
    assign brand_key = 'silverline'
  elsif vendor_clean contains 'bluespot'
    assign brand_key = 'bluespot'
  elsif vendor_clean contains 'forgefix'
    assign brand_key = 'forgefix'
  elsif vendor_clean contains 'rawlplug'
    assign brand_key = 'rawlplug'
  elsif vendor_clean contains 'fischer'
    assign brand_key = 'fischer'
  elsif vendor_clean contains 'gorilla'
    assign brand_key = 'gorilla'
  elsif vendor_clean contains 'loctite'
    assign brand_key = 'loctite'
  elsif vendor_clean contains 'bostik'
    assign brand_key = 'bostik'
  elsif vendor_clean contains 'bostitch'
    assign brand_key = 'bostitch'
  elsif vendor_clean contains 'senco'
    assign brand_key = 'senco'
  elsif vendor_clean contains 'tacwise'
    assign brand_key = 'tacwise'
  elsif vendor_clean contains 'ridgid'
    assign brand_key = 'ridgid'
  elsif vendor_clean contains 'record power'
    assign brand_key = 'recordpower'
  elsif vendor_clean contains 'flex power' or vendor_clean == 'flex'
    assign brand_key = 'flex'
  elsif vendor_clean contains 'evolution'
    assign brand_key = 'evolution'
  elsif vendor_clean contains 'black' and vendor_clean contains 'decker'
    assign brand_key = 'blackdecker'
  elsif vendor_clean contains 'karcher'
    assign brand_key = 'karcher'
  elsif vendor_clean contains 'nilfisk'
    assign brand_key = 'nilfisk'
  elsif vendor_clean contains 'wd-40' or vendor_clean contains 'wd40'
    assign brand_key = 'wd40'
  elsif vendor_clean contains 'yale'
    assign brand_key = 'yale'
  elsif vendor_clean contains 'bessey'
    assign brand_key = 'bessey'
  elsif vendor_clean contains 'marshalltown'
    assign brand_key = 'marshalltown'
  elsif vendor_clean contains 'monument'
    assign brand_key = 'monument'
  elsif vendor_clean contains 'kapro'
    assign brand_key = 'kapro'
  elsif vendor_clean contains 'ledlenser' or vendor_clean contains 'led lenser'
    assign brand_key = 'ledlenser'
  elsif vendor_clean contains 'brennenstuhl'
    assign brand_key = 'brennenstuhl'
  elsif vendor_clean contains 'scan'
    assign brand_key = 'scan'
  elsif vendor_clean contains 'dickies'
    assign brand_key = 'dickies'
  elsif vendor_clean contains 'teng'
    assign brand_key = 'teng'
  elsif vendor_clean contains 'facom'
    assign brand_key = 'facom'
  elsif vendor_clean contains 'wiha'
    assign brand_key = 'wiha'
  elsif vendor_clean contains 'fiskars'
    assign brand_key = 'fiskars'
  elsif vendor_clean contains 'rubi'
    assign brand_key = 'rubi'
  elsif vendor_clean contains 'purdy'
    assign brand_key = 'purdy'
  elsif vendor_clean contains 'ronseal'
    assign brand_key = 'ronseal'
  elsif vendor_clean contains 'cuprinol'
    assign brand_key = 'cuprinol'
  elsif vendor_clean contains 'zinsser'
    assign brand_key = 'zinsser'
  elsif vendor_clean contains 'hammerite'
    assign brand_key = 'hammerite'
  elsif vendor_clean contains 'geocel'
    assign brand_key = 'geocel'
  elsif vendor_clean contains 'unibond'
    assign brand_key = 'unibond'
  elsif vendor_clean contains 'araldite'
    assign brand_key = 'araldite'
  elsif vendor_clean contains 'norton'
    assign brand_key = 'norton'
  elsif vendor_clean contains 'flexovit'
    assign brand_key = 'flexovit'
  elsif vendor_clean contains 'marcrist'
    assign brand_key = 'marcrist'
  elsif vendor_clean contains 'abracs'
    assign brand_key = 'abracs'
  elsif vendor_clean contains 'mexco'
    assign brand_key = 'mexco'
  elsif vendor_clean contains 'freud'
    assign brand_key = 'freud'
  elsif vendor_clean contains 'lenox'
    assign brand_key = 'lenox'
  elsif vendor_clean contains 'olympia'
    assign brand_key = 'olympia'
  elsif vendor_clean contains 'r.s.t' or vendor_clean == 'rst'
    assign brand_key = 'rst'
  elsif vendor_clean contains 'gripit'
    assign brand_key = 'gripit'
  elsif vendor_clean contains 'jubilee'
    assign brand_key = 'jubilee'
  elsif vendor_clean contains 'rapid'
    assign brand_key = 'rapid'
  elsif vendor_clean contains 'arrow'
    assign brand_key = 'arrow'
  elsif vendor_clean contains 'abus'
    assign brand_key = 'abus'
  elsif vendor_clean contains 'squire'
    assign brand_key = 'squire'
  elsif vendor_clean contains 'masterlock' or vendor_clean contains 'master lock'
    assign brand_key = 'masterlock'
  elsif vendor_clean contains 'armorgard'
    assign brand_key = 'armorgard'
  endif

  # =========================================================================
  # STEP 3: ASSIGN BRAND COLOURS
  # =========================================================================
  assign brand_bg = '#2d2d2d'
  assign brand_text = '#ffffff'

  case brand_key
    # --- YELLOW backgrounds (need dark text) ---
    when 'dewalt'
      assign brand_bg = '#fecc00'
      assign brand_text = '#1a1a1a'
      assign brand_display = 'DeWalt'
    when 'stanley'
      assign brand_bg = '#ffcc00'
      assign brand_text = '#1a1a1a'
      assign brand_display = 'Stanley'

    # --- RED backgrounds (white text) ---
    when 'makita'
      assign brand_bg = '#e11d26'
      assign brand_display = 'Makita'
    when 'milwaukee'
      assign brand_bg = '#d5001a'
      assign brand_display = 'Milwaukee'
    when 'timco'
      assign brand_bg = '#e31837'
      assign brand_display = 'TIMCO'
    when 'lamello'
      assign brand_bg = '#a71d35'
      assign brand_display = 'Lamello'
    when 'loctite'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Loctite'
    when 'bostitch'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Bostitch'
    when 'tacwise'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Tacwise'
    when 'evolution'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Evolution'
    when 'karcher'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Kärcher'
    when 'ronseal'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Ronseal'
    when 'cuprinol'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Cuprinol'
    when 'zinsser'
      assign brand_bg = '#cc0000'
      assign brand_display = 'Zinsser'
    when 'rubi'
      assign brand_bg = '#e30613'
      assign brand_display = 'Rubi'
    when 'freud'
      assign brand_bg = '#e30613'
      assign brand_display = 'Freud'
    when 'fischer'
      assign brand_bg = '#e30613'
      assign brand_display = 'Fischer'
    when 'rawlplug'
      assign brand_bg = '#e30613'
      assign brand_display = 'Rawlplug'
    when 'gripit'
      assign brand_bg = '#e30613'
      assign brand_display = 'GripIt'
    when 'marcrist'
      assign brand_bg = '#c8102e'
      assign brand_display = 'Marcrist'
    when 'mexco'
      assign brand_bg = '#c8102e'
      assign brand_display = 'Mexco'
    when 'rapid'
      assign brand_bg = '#c8102e'
      assign brand_display = 'Rapid'
    when 'arrow'
      assign brand_bg = '#c8102e'
      assign brand_display = 'Arrow'
    when 'abus'
      assign brand_bg = '#c8102e'
      assign brand_display = 'ABUS'

    # --- GREEN backgrounds (white text) ---
    when 'hikoki'
      assign brand_bg = '#00a651'
      assign brand_display = 'HiKOKI'
    when 'metabo'
      assign brand_bg = '#00843d'
      assign brand_display = 'Metabo'
    when 'soudal'
      assign brand_bg = '#00843d'
      assign brand_display = 'Soudal'
    when 'ct1'
      assign brand_bg = '#00843d'
      assign brand_display = 'CT1'
    when 'siroflex'
      assign brand_bg = '#00843d'
      assign brand_display = 'Siroflex'
    when 'unibond'
      assign brand_bg = '#00843d'
      assign brand_display = 'UniBond'
    when 'araldite'
      assign brand_bg = '#00843d'
      assign brand_display = 'Araldite'
    when 'stabila'
      assign brand_bg = '#009639'
      assign brand_display = 'Stabila'
    when 'hultafors'
      assign brand_bg = '#009639'
      assign brand_display = 'Hultafors'
    when 'kapro'
      assign brand_bg = '#009639'
      assign brand_display = 'Kapro'

    # --- BLUE backgrounds (white text) ---
    when 'bosch'
      assign brand_bg = '#005eb8'
      assign brand_display = 'Bosch'
    when 'irwin'
      assign brand_bg = '#003da5'
      assign brand_display = 'Irwin'
    when 'trend'
      assign brand_bg = '#005ca9'
      assign brand_display = 'Trend'
    when 'faithfull'
      assign brand_bg = '#00539b'
      assign brand_display = 'Faithfull'
    when 'einhell'
      assign brand_bg = '#0065bd'
      assign brand_display = 'Einhell'
    when 'knipex'
      assign brand_bg = '#003087'
      assign brand_display = 'Knipex'
    when 'wera'
      assign brand_bg = '#00539b'
      assign brand_display = 'Wera'
    when 'sealey'
      assign brand_bg = '#003c71'
      assign brand_display = 'Sealey'
    when 'ox'
      assign brand_bg = '#0057b8'
      assign brand_display = 'OX Tools'
    when 'roughneck'
      assign brand_bg = '#00539b'
      assign brand_display = 'Roughneck'
    when 'silverline'
      assign brand_bg = '#003087'
      assign brand_display = 'Silverline'
    when 'evostik'
      assign brand_bg = '#FFFFFF'
      assign brand_display = 'Evo-Stik'
    when 'ob1'
      assign brand_bg = '#0055a5'
      assign brand_display = 'OB1'
    when 'everbuild'
      assign brand_bg = '#003da5'
      assign brand_display = 'Everbuild'
    when 'pdp'
      assign brand_bg = '#1e3a8a'
      assign brand_display = 'Premier Diamond'
    when 'estwing'
      assign brand_bg = '#0054a6'
      assign brand_display = 'Estwing'
    when 'draper'
      assign brand_bg = '#004990'
      assign brand_display = 'Draper'
    when 'bluespot'
      assign brand_bg = '#0066cc'
      assign brand_display = 'BlueSpot'
    when 'bostik'
      assign brand_bg = '#003087'
      assign brand_display = 'Bostik'
    when 'senco'
      assign brand_bg = '#003087'
      assign brand_display = 'Senco'
    when 'recordpower'
      assign brand_bg = '#003366'
      assign brand_display = 'Record Power'
    when 'nilfisk'
      assign brand_bg = '#003c71'
      assign brand_display = 'Nilfisk'
    when 'yale'
      assign brand_bg = '#003087'
      assign brand_display = 'Yale'

    # --- ORANGE backgrounds (white text) ---
    when 'paslode'
      assign brand_bg = '#ffffff'
      assign brand_display = 'Paslode'
    when 'spit'
      assign brand_bg = '#fa4d03'
      assign brand_display = 'Spit'  
    when 'bahco'
      assign brand_bg = '#ff6600'
      assign brand_display = 'Bahco'
    when 'gorilla'
      assign brand_bg = '#ff6600'
      assign brand_display = 'Gorilla Glue'
    when 'flex'
      assign brand_bg = '#ff6600'
      assign brand_display = 'Flex'
    when 'blackdecker'
      assign brand_bg = '#ff6600'
      assign brand_display = 'Black+Decker'
    when 'ridgid'
      assign brand_bg = '#f26522'
      assign brand_display = 'RIDGID'
    when 'fiskars'
      assign brand_bg = '#f86202'
      assign brand_display = 'Fiskars'
    when 'armorgard'
      assign brand_bg = '#ff6600'
      assign brand_display = 'Armorgard'

    # --- DARK backgrounds (white text) ---
    when 'kamtec'
      assign brand_bg = '#2d2d2d'
      assign brand_display = 'Kamtec'
    when 'forgefix'
      assign brand_bg = '#1a1a1a'
      assign brand_display = 'ForgeFix'
    when 'olympia'
      assign brand_bg = '#1a1a1a'
      assign brand_display = 'Olympia Tools'
    when 'dickies'
      assign brand_bg = '#1a1a1a'
      assign brand_display = 'Dickies'
  endcase

  # =========================================================================
  # STEP 4: BUILD URL
  # =========================================================================
  if url != blank
    assign pill_url = url
  else
    assign pill_url = routes.collections_url | append: '/' | append: brand_key
  endif

  # =========================================================================
  # STEP 5: BUILD LOGO URL (assets only)
  # =========================================================================
  assign brand_logo_url = brand_key | append: '.svg' | asset_url

  # =========================================================================
  # STEP 6: DETERMINE RENDER TYPE
  # =========================================================================
  assign render_type = type | default: 'pill'
-%}

{%- if vendor_raw != blank -%}

  {%- if render_type == 'dot' -%}
    {%- comment -%} DOT MODE: Just a coloured circle for filter buttons {%- endcomment -%}
    <span 
      class="invicta-brand-dot" 
      style="background-color: {{ brand_bg }};{% if brand_key == 'dewalt' or brand_key == 'stanley' %} box-shadow: inset 0 0 0 1px rgba(0,0,0,0.15);{% endif %}"
      aria-hidden="true"
    ></span>

  {%- elsif render_type == 'text-only' -%}
    {%- comment -%} TEXT-ONLY MODE: Simple coloured text pill, no logo {%- endcomment -%}
    <span 
      class="invicta-brand-pill invicta-brand-pill--text invicta-brand-pill--{{ pill_size | default: 'md' }}{% if pill_compact %} invicta-brand-pill--compact{% endif %}"
      style="--pill-bg: {{ brand_bg }}; --pill-text: {{ brand_text }};"
    >
      <span class="invicta-brand-pill__inner">
        <span class="invicta-brand-pill__label">{{ brand_display }}</span>
      </span>
    </span>

  {%- else -%}
    {%- comment -%} FULL PILL MODE: Logo with fallback to text {%- endcomment -%}
    <div class="invicta-brand-pill-wrapper invicta-brand-pill-wrapper--{{ pill_context | default: 'card' }}">
      <a
        href="{{ pill_url }}"
        class="invicta-brand-pill invicta-brand-pill--{{ pill_size | default: 'md' }}{% if pill_compact %} invicta-brand-pill--compact{% endif %}"
        aria-label="Shop {{ brand_display | escape }} products"
        title="Shop {{ brand_display | escape }}"
        style="--pill-bg: {{ brand_bg }}; --pill-text: {{ brand_text }};"
      >
        <span class="invicta-brand-pill__inner">

          <!-- Visible logo (mobile-safe) -->
          <span
            class="invicta-brand-pill__logo-bg"
            style="background-image:url('{{ brand_logo_url | escape }}');"
            aria-hidden="true"
          ></span>

          <!-- Hidden detector img: only used to trigger fallback if asset missing -->
          <img
            src="{{ brand_logo_url | escape }}"
            alt="{{ brand_display }} logo - Shop {{ brand_display }} tools at Invicta Tools"
            class="invicta-brand-pill__logo"
            loading="eager"
            width="120"
            height="40"
            style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;"
            data-brand-pill-detector
          >

          <!-- Text fallback: hard-hidden until onerror fires -->
          <span
            class="invicta-brand-pill__label"
            style="display:none;"
          >
            {{ brand_display }}
          </span>

        </span>
      </a>
    </div>
  {%- endif -%}

{%- endif -%}

<script>
/* Brand pill logo fallback — delegated error handler (replaces inline onerror) */
(function() {
  if (window.__invictaBrandPillErrorBound) return;
  window.__invictaBrandPillErrorBound = true;

  document.addEventListener('error', function(e) {
    var img = e.target;
    if (!img || img.tagName !== 'IMG' || !img.hasAttribute('data-brand-pill-detector')) return;

    var wrap = img.closest('.invicta-brand-pill__inner');
    if (!wrap) return;

    var bg = wrap.querySelector('.invicta-brand-pill__logo-bg');
    var label = wrap.querySelector('.invicta-brand-pill__label');

    if (bg) bg.style.display = 'none';
    if (label) label.style.display = 'inline-block';

    var pill = img.closest('.invicta-brand-pill');
    if (pill) pill.classList.add('invicta-brand-pill--text');
  }, true);
})();
</script>
