{% comment %}
  ============================================
  INVICTA FREE DELIVERY BAR v1.0
  ============================================
  Progress bar showing how close the cart is
  to qualifying for free delivery (Â£30 threshold).

  Usage:
    {% render 'invicta-free-delivery-bar' %}

  Placement: Cart drawer or cart page.
  Uses cart.total_price (in pence) to calculate progress.

  Version: 1.0.0
  ============================================
{% endcomment %}

{%- liquid
  assign threshold_pence = 3000
  assign cart_total = cart.total_price
  assign remaining_pence = threshold_pence | minus: cart_total
  assign qualified = false
  if cart_total >= threshold_pence
    assign qualified = true
    assign progress = 100
  else
    assign progress = cart_total | times: 100 | divided_by: threshold_pence
  endif
  assign remaining_pounds = remaining_pence | money
-%}

<div class="inv-delivery-bar" data-delivery-bar data-threshold="{{ threshold_pence }}">
  {%- if qualified -%}
    <div class="inv-delivery-bar__message inv-delivery-bar__message--qualified">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      <span>You qualify for <strong>FREE next-day delivery!</strong></span>
    </div>
  {%- else -%}
    <div class="inv-delivery-bar__message">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
      <span>You're <strong>{{ remaining_pounds }}</strong> away from <strong>FREE delivery!</strong></span>
    </div>
  {%- endif -%}
  <div class="inv-delivery-bar__track">
    <div class="inv-delivery-bar__fill" style="width: {{ progress }}%;" data-delivery-fill></div>
  </div>
</div>

<style>
  .inv-delivery-bar {
    padding: var(--inv-space-sm, 0.5rem) var(--inv-space-md, 1rem);
    background: var(--inv-bg-muted, #f9fafb);
    border: 1px solid var(--inv-border, #e5e7eb);
    border-radius: var(--inv-radius-md, 8px);
    margin: var(--inv-space-sm, 0.5rem) 0;
  }
  .inv-delivery-bar__message {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--inv-fg, #0f172a);
    margin-bottom: 8px;
    line-height: 1.3;
  }
  .inv-delivery-bar__message svg {
    flex-shrink: 0;
    color: var(--inv-fg-muted, #6b7280);
  }
  .inv-delivery-bar__message--qualified {
    color: var(--inv-success, #16a34a);
    font-weight: 500;
  }
  .inv-delivery-bar__message--qualified svg {
    color: var(--inv-success, #16a34a);
  }
  .inv-delivery-bar__track {
    height: 6px;
    background: var(--inv-border, #e5e7eb);
    border-radius: 3px;
    overflow: hidden;
  }
  .inv-delivery-bar__fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--inv-accent, #e11d26), var(--inv-accent-hover, #c4191f));
    transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    min-width: 0;
    max-width: 100%;
  }
  .inv-delivery-bar__message--qualified + .inv-delivery-bar__track .inv-delivery-bar__fill,
  .inv-delivery-bar__message--qualified ~ .inv-delivery-bar__track .inv-delivery-bar__fill {
    background: linear-gradient(90deg, var(--inv-success, #16a34a), #22c55e);
  }
</style>

<script>
  /* Auto-update delivery bar when cart changes (for AJAX carts) */
  (function() {
    var bar = document.querySelector('[data-delivery-bar]');
    if (!bar) return;
    var threshold = parseInt(bar.dataset.threshold, 10);

    function updateBar(totalPence) {
      var fill = bar.querySelector('[data-delivery-fill]');
      var msgContainer = bar.querySelector('.inv-delivery-bar__message');
      if (!fill || !msgContainer) return;

      var qualified = totalPence >= threshold;
      var progress = qualified ? 100 : Math.min(Math.round((totalPence / threshold) * 100), 100);
      fill.style.width = progress + '%';

      if (qualified) {
        msgContainer.className = 'inv-delivery-bar__message inv-delivery-bar__message--qualified';
        msgContainer.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>You qualify for <strong>FREE next-day delivery!</strong></span>';
      } else {
        var remaining = ((threshold - totalPence) / 100).toFixed(2);
        msgContainer.className = 'inv-delivery-bar__message';
        msgContainer.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg><span>You\u2019re <strong>\u00a3' + remaining + '</strong> away from <strong>FREE delivery!</strong></span>';
      }
    }

    /* Listen for Shopify cart update events */
    document.addEventListener('cart:updated', function(e) {
      if (e.detail && e.detail.total_price != null) {
        updateBar(e.detail.total_price);
      }
    });
  })();
</script>
