{% comment %}
  Minimum Order Quantity
  ======================
  Displays minimum order quantity notice and validates quantity input.
  
  Reads from product metafield: custom.min_qty
  
  Usage: {% render 'min-order-qty', product: product %}
  
  Version: 1.0.0
  Author: Invicta Tools Theme
{% endcomment %}

{%- liquid
  # Get minimum quantity from metafield
  assign min_qty = product.metafields.custom.min_qty.value | default: 1 | plus: 0
  assign has_min_qty = false
  
  if min_qty > 1
    assign has_min_qty = true
  endif
-%}

{%- if has_min_qty -%}
  <div class="invicta-min-qty" data-min-qty="{{ min_qty }}">
    <div class="invicta-min-qty__notice">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>Minimum order: <strong>{{ min_qty }} units</strong></span>
    </div>
  </div>

  <script>
    (function() {
      'use strict';
      
      const MIN_QTY = {{ min_qty }};
      const minQtyEl = document.querySelector('[data-min-qty]');
      const qtyInput = document.querySelector('#InvQty, input[name="quantity"]');
      
      if (!qtyInput || !minQtyEl) return;
      
      // Set minimum on input
      qtyInput.min = MIN_QTY;
      
      // Validate and auto-correct on blur
      qtyInput.addEventListener('blur', function() {
        const val = parseInt(this.value) || 0;
        if (val < MIN_QTY) {
          this.value = MIN_QTY;
          
          // Show feedback
          minQtyEl.classList.add('invicta-min-qty--warning');
          setTimeout(() => {
            minQtyEl.classList.remove('invicta-min-qty--warning');
          }, 2000);
          
          // Trigger change event
          this.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      // Also check on form submit
      document.addEventListener('submit', function(e) {
        if (e.target.closest('product-form, .product-form')) {
          const val = parseInt(qtyInput.value) || 0;
          if (val < MIN_QTY) {
            e.preventDefault();
            qtyInput.value = MIN_QTY;
            minQtyEl.classList.add('invicta-min-qty--warning');
            setTimeout(() => {
              minQtyEl.classList.remove('invicta-min-qty--warning');
            }, 2000);
          }
        }
      });
      
      // Check on +/- button clicks
      document.addEventListener('click', function(e) {
        if (e.target.closest('.inv-qty__btn--minus, [data-qty-minus]')) {
          setTimeout(() => {
            const val = parseInt(qtyInput.value) || 0;
            if (val < MIN_QTY) {
              qtyInput.value = MIN_QTY;
            }
          }, 50);
        }
      });
      
      // Set initial value if below minimum
      if (parseInt(qtyInput.value) < MIN_QTY) {
        qtyInput.value = MIN_QTY;
      }
    })();
  </script>
{%- endif -%}

<style>
  .invicta-min-qty {
    margin: 12px 0;
  }
  
  .invicta-min-qty__notice {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #92400e;
    transition: all 0.2s ease;
  }
  
  .invicta-min-qty__notice svg {
    flex-shrink: 0;
    color: #d97706;
  }
  
  .invicta-min-qty__notice strong {
    color: #78350f;
  }
  
  /* Warning state - when user tries to go below minimum */
  .invicta-min-qty--warning .invicta-min-qty__notice {
    background: #fef2f2;
    border-color: #f87171;
    animation: minQtyShake 0.5s ease;
  }
  
  @keyframes minQtyShake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }
</style>
