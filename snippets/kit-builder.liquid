{% comment %}
  ============================================================================
  Kit Builder Snippet v4.0 — CLEAN REDESIGN
  ============================================================================
  
  CHANGES from v3.1:
  - Removed "Your Tool" step (redundant)
  - Collapsible panel (collapsed by default)
  - Cleaner badges (short text)
  - Hide qty until battery selected
  - Better summary with clear CTA
  - Simpler visual hierarchy
  - No "Start Building" confusion
  
  USAGE:
  {% render 'kit-builder', product: product %}
  ============================================================================
{% endcomment %}

{% liquid
  assign show_kit_builder = false
  assign is_power_tool = false
  assign kit_brand = ''
  
  for tag in product.tags
    assign tag_down = tag | downcase
    if tag_down == 'category:power tools'
      assign is_power_tool = true
    endif
  endfor
  
  assign vendor_down = product.vendor | downcase
  if vendor_down == 'makita'
    assign kit_brand = 'makita'
  elsif vendor_down == 'dewalt'
    assign kit_brand = 'dewalt'
  endif
  
  if is_power_tool and kit_brand != ''
    assign show_kit_builder = true
  endif
  
  if show_kit_builder
    if kit_brand == 'makita'
      assign battery_collection = collections['makita-18v-batteries']
      assign charger_collection = collections['makita-18v-chargers']
      assign case_collection = collections['makita-cases']
    elsif kit_brand == 'dewalt'
      assign battery_collection = collections['dewalt-18v-batteries']
      assign charger_collection = collections['dewalt-18v-chargers']
      assign case_collection = collections['dewalt-cases']
    endif
    
    assign has_batteries = false
    assign has_chargers = false
    assign has_cases = false
    
    if battery_collection and battery_collection.products.size > 0
      assign has_batteries = true
    endif
    if charger_collection and charger_collection.products.size > 0
      assign has_chargers = true
    endif
    if case_collection and case_collection.products.size > 0
      assign has_cases = true
    endif
    
    unless has_batteries
      assign show_kit_builder = false
    endunless
  endif
%}

{% if show_kit_builder %}
{{ 'component-kit-builder.css' | asset_url | stylesheet_tag }}

<!-- ========================================================================
     HTML
     ======================================================================== -->
<div class="inv-kit" data-kit-builder data-brand="{{ kit_brand }}" data-expanded="true" data-tool-price="{{ product.selected_or_first_available_variant.price }}" data-tool-id="{{ product.selected_or_first_available_variant.id }}" data-discount-code="{% if kit_brand == 'makita' %}MAKITA-KIT{% elsif kit_brand == 'dewalt' %}DEWALT-KIT{% endif %}">
  
  <!-- HEADER (Click to expand) -->
  <div class="inv-kit__header" data-kit-toggle>
    <div class="inv-kit__header-left">
      <div class="inv-kit__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="1" y="3" width="15" height="13"/>
          <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
          <circle cx="5.5" cy="18.5" r="2.5"/>
          <circle cx="18.5" cy="18.5" r="2.5"/>
        </svg>
      </div>
      <div class="inv-kit__header-text">
        <h3 class="inv-kit__title">Build & Save</h3>
        <span class="inv-kit__subtitle">Bundle batteries, charger & case</span>
      </div>
    </div>
    <div class="inv-kit__toggle">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
  </div>
  
  <!-- BODY -->
  <div class="inv-kit__body">
    
    <!-- BATTERIES -->
    {% if has_batteries %}
    <div class="inv-kit__row" data-row="battery">
      <div class="inv-kit__row-header">
        <div class="inv-kit__row-left">
          <span class="inv-kit__row-label">Batteries</span>
          <span class="inv-kit__badge" data-badge="battery">Buy 2 = 15% off</span>
        </div>
        <div class="inv-kit__row-price inv-kit__row-price--empty" data-price="battery">
          <span class="inv-kit__price-was" data-price-was="battery" style="display:none;"></span>
          <span data-price-now="battery">—</span>
        </div>
      </div>
      
      <div class="inv-kit__select-wrap">
        <select class="inv-kit__select" data-select="battery" aria-label="Select battery">
          <option value="" data-price="0" data-kit-price="0">Select battery...</option>
          {% for battery in battery_collection.products %}
            {% liquid
              assign batt_variant = battery.variants.first
              assign batt_price = batt_variant.price
              assign batt_available = batt_variant.available
              assign batt_title_down = battery.title | downcase
              assign batt_kit_price = batt_price
              
              if kit_brand == 'makita'
                if batt_title_down contains '3.0ah' or batt_title_down contains '3ah'
                  assign batt_kit_price = 4000
                elsif batt_title_down contains '5.0ah' or batt_title_down contains '5ah'
                  assign batt_kit_price = 6000
                elsif batt_title_down contains '6.0ah' or batt_title_down contains '6ah'
                  assign batt_kit_price = 7800
                endif
              endif
            %}
            <option 
              value="{{ batt_variant.id }}"
              data-price="{{ batt_price }}"
              data-kit-price="{{ batt_kit_price }}"
              data-title="{{ battery.title | escape }}"
              {% unless batt_available %}disabled{% endunless %}
            >
              {{ battery.title }} — {{ batt_price | money }}{% unless batt_available %} (Sold out){% endunless %}
            </option>
          {% endfor %}
        </select>
        <svg class="inv-kit__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      
      <!-- Qty (hidden until battery selected) -->
      <div class="inv-kit__qty-wrap" data-qty-wrap="battery">
        <span class="inv-kit__qty-label">Qty:</span>
        <div class="inv-kit__qty">
          <button type="button" class="inv-kit__qty-btn" data-qty-btn="decrease" aria-label="Decrease">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <input type="number" class="inv-kit__qty-input" data-qty-input="battery" value="1" min="1" max="4" readonly>
          <button type="button" class="inv-kit__qty-btn" data-qty-btn="increase" aria-label="Increase">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <span class="inv-kit__qty-hint" data-qty-hint>Buy 2 for 15% off!</span>
      </div>
    </div>
    {% endif %}
    
    <!-- CHARGER -->
    {% if has_chargers %}
    <div class="inv-kit__row" data-row="charger">
      <div class="inv-kit__row-header">
        <div class="inv-kit__row-left">
          <span class="inv-kit__row-label">Charger</span>
          <span class="inv-kit__badge" data-badge="charger" style="display:none;">Saving!</span>
        </div>
        <div class="inv-kit__row-price inv-kit__row-price--empty" data-price="charger">
          <span class="inv-kit__price-was" data-price-was="charger" style="display:none;"></span>
          <span data-price-now="charger">—</span>
        </div>
      </div>
      
      <div class="inv-kit__select-wrap">
        <select class="inv-kit__select" data-select="charger" aria-label="Select charger">
          <option value="" data-price="0" data-kit-price="0">No charger</option>
          {% for charger in charger_collection.products %}
            {% liquid
              assign chrg_variant = charger.variants.first
              assign chrg_price = chrg_variant.price
              assign chrg_available = chrg_variant.available
              assign chrg_title_down = charger.title | downcase
              assign chrg_kit_price = chrg_price
              
              if kit_brand == 'makita'
                if chrg_title_down contains 'dc18rc'
                  assign chrg_kit_price = 2399
                elsif chrg_title_down contains 'dc18sd'
                  assign chrg_kit_price = 1199
                endif
              endif
            %}
            <option 
              value="{{ chrg_variant.id }}"
              data-price="{{ chrg_price }}"
              data-kit-price="{{ chrg_kit_price }}"
              data-title="{{ charger.title | escape }}"
              {% unless chrg_available %}disabled{% endunless %}
            >
              {{ charger.title }} — {{ chrg_price | money }}{% unless chrg_available %} (Sold out){% endunless %}
            </option>
          {% endfor %}
        </select>
        <svg class="inv-kit__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
    </div>
    {% endif %}
    
    <!-- CASE -->
    {% if has_cases %}
    <div class="inv-kit__row" data-row="case">
      <div class="inv-kit__row-header">
        <div class="inv-kit__row-left">
          <span class="inv-kit__row-label">Case</span>
          <span class="inv-kit__badge" data-badge="case" style="display:none;">Saving!</span>
        </div>
        <div class="inv-kit__row-price inv-kit__row-price--empty" data-price="case">
          <span class="inv-kit__price-was" data-price-was="case" style="display:none;"></span>
          <span data-price-now="case">—</span>
        </div>
      </div>
      
      <div class="inv-kit__select-wrap">
        <select class="inv-kit__select" data-select="case" aria-label="Select case">
          <option value="" data-price="0" data-kit-price="0">No case</option>
          {% for case in case_collection.products %}
            {% liquid
              assign case_variant = case.variants.first
              assign case_price = case_variant.price
              assign case_available = case_variant.available
              assign case_title_down = case.title | downcase
              assign case_kit_price = case_price
              
              if kit_brand == 'makita'
                if case_title_down contains 'makpac 3' or case_title_down contains 'makpac type 3'
                  assign case_kit_price = 1500
                elsif case_title_down contains 'makpac 4' or case_title_down contains 'makpac type 4'
                  assign case_kit_price = 2500
                endif
              endif
            %}
            <option 
              value="{{ case_variant.id }}"
              data-price="{{ case_price }}"
              data-kit-price="{{ case_kit_price }}"
              data-title="{{ case.title | escape }}"
              {% unless case_available %}disabled{% endunless %}
            >
              {{ case.title }} — {{ case_price | money }}{% unless case_available %} (Sold out){% endunless %}
            </option>
          {% endfor %}
        </select>
        <svg class="inv-kit__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
    </div>
    {% endif %}
    
    <!-- SUMMARY -->
    <div class="inv-kit__summary">
      <div class="inv-kit__summary-row">
        <span class="inv-kit__summary-label">Kit total (inc. tool)</span>
        <span class="inv-kit__summary-total inv-kit__summary-total--empty" data-kit-total>Select items above</span>
      </div>
      
      <div class="inv-kit__summary-savings" data-savings-row hidden>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <span class="inv-kit__summary-savings-text" data-kit-savings>You save £0.00</span>
      </div>
      
      <button type="button" class="inv-kit__add-btn" data-add-kit-btn disabled>
        <span data-btn-text>Add Kit to Cart</span>
        <svg class="inv-kit__spinner" data-btn-loading style="display:none;" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    
  </div>
</div>

<script src="{{ 'component-kit-builder.js' | asset_url }}" defer></script>
{% endif %}
