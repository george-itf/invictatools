{% comment %}
  ============================================================================
  Kit Builder Snippet v4.0 — CLEAN REDESIGN
  ============================================================================
  
  CHANGES from v3.1:
  - Removed "Your Tool" step (redundant)
  - Collapsible panel (collapsed by default)
  - Cleaner badges (short text)
  - Hide qty until battery selected
  - Better summary with clear CTA
  - Simpler visual hierarchy
  - No "Start Building" confusion
  
  USAGE:
  {% render 'kit-builder', product: product %}
  ============================================================================
{% endcomment %}

{% liquid
  assign show_kit_builder = false
  assign is_power_tool = false
  assign kit_brand = ''
  
  for tag in product.tags
    assign tag_down = tag | downcase
    if tag_down == 'category:power tools'
      assign is_power_tool = true
    endif
  endfor
  
  assign vendor_down = product.vendor | downcase
  if vendor_down == 'makita'
    assign kit_brand = 'makita'
  elsif vendor_down == 'dewalt'
    assign kit_brand = 'dewalt'
  endif
  
  if is_power_tool and kit_brand != ''
    assign show_kit_builder = true
  endif
  
  if show_kit_builder
    if kit_brand == 'makita'
      assign battery_collection = collections['makita-18v-batteries']
      assign charger_collection = collections['makita-18v-chargers']
      assign case_collection = collections['makita-cases']
    elsif kit_brand == 'dewalt'
      assign battery_collection = collections['dewalt-18v-batteries']
      assign charger_collection = collections['dewalt-18v-chargers']
      assign case_collection = collections['dewalt-cases']
    endif
    
    assign has_batteries = false
    assign has_chargers = false
    assign has_cases = false
    
    if battery_collection and battery_collection.products.size > 0
      assign has_batteries = true
    endif
    if charger_collection and charger_collection.products.size > 0
      assign has_chargers = true
    endif
    if case_collection and case_collection.products.size > 0
      assign has_cases = true
    endif
    
    unless has_batteries
      assign show_kit_builder = false
    endunless
  endif
%}

{% if show_kit_builder %}
<style>
/* ==========================================================================
   KIT BUILDER v4.0 — CLEAN REDESIGN
   ========================================================================== */

/* ----- Brand Colours ----- */
.inv-kit[data-brand="makita"] {
  --kit-brand: #00a0aa;
  --kit-brand-dark: #008891;
  --kit-brand-light: #e6f7f8;
}

.inv-kit[data-brand="dewalt"] {
  --kit-brand: #febd17;
  --kit-brand-dark: #d9a000;
  --kit-brand-light: #fff9e6;
}

/* ----- Base ----- */
.inv-kit {
  --kit-text: #1a1a1a;
  --kit-muted: #666;
  --kit-border: #e5e5e5;
  --kit-bg: #f8f8f8;
  --kit-success: #16a34a;
  --kit-radius: 8px;
  
  background: #fff;
  border: 1px solid var(--kit-border);
  border-radius: var(--kit-radius);
  font-family: inherit;
  overflow: hidden;
}

/* ==========================================================================
   HEADER (Clickable to expand/collapse)
   ========================================================================== */
.inv-kit__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  cursor: pointer;
  background: var(--kit-bg);
  border-bottom: 1px solid var(--kit-border);
  transition: background 0.15s;
  user-select: none;
}

.inv-kit__header:hover {
  background: #f0f0f0;
}

.inv-kit__header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.inv-kit__icon {
  width: 40px;
  height: 40px;
  background: var(--kit-brand);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.inv-kit__icon svg {
  width: 20px;
  height: 20px;
  color: #fff;
}

.inv-kit[data-brand="dewalt"] .inv-kit__icon svg {
  color: #1a1a1a;
}

.inv-kit__header-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.inv-kit__title {
  font-size: 15px;
  font-weight: 700;
  color: var(--kit-text);
  margin: 0;
}

.inv-kit__subtitle {
  font-size: 12px;
  color: var(--kit-muted);
}

.inv-kit__toggle {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--kit-muted);
}

.inv-kit__toggle svg {
  width: 20px;
  height: 20px;
  transition: transform 0.2s ease;
}

.inv-kit[data-expanded="false"] .inv-kit__toggle svg {
  transform: rotate(-90deg);
}

/* ==========================================================================
   BODY (Collapsible)
   ========================================================================== */
.inv-kit__body {
  display: block;
}

.inv-kit[data-expanded="false"] .inv-kit__body {
  display: none;
}

/* ==========================================================================
   ACCESSORY ROW
   ========================================================================== */
.inv-kit__row {
  padding: 16px;
  border-bottom: 1px solid #f0f0f0;
}

.inv-kit__row:last-child {
  border-bottom: none;
}

.inv-kit__row-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.inv-kit__row-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.inv-kit__row-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--kit-text);
}

/* ----- Badges ----- */
.inv-kit__badge {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  padding: 4px 8px;
  border-radius: 4px;
  background: var(--kit-brand-light);
  color: var(--kit-brand-dark);
}

.inv-kit__badge--active {
  background: var(--kit-brand);
  color: #fff;
}

.inv-kit[data-brand="dewalt"] .inv-kit__badge--active {
  color: #1a1a1a;
}

/* ----- Row Price ----- */
.inv-kit__row-price {
  font-size: 14px;
  font-weight: 700;
  color: var(--kit-text);
  text-align: right;
}

.inv-kit__row-price--empty {
  color: #ccc;
  font-weight: 400;
}

.inv-kit__row-price--discount {
  color: var(--kit-brand-dark);
}

.inv-kit__price-was {
  font-size: 12px;
  color: #999;
  text-decoration: line-through;
  margin-right: 6px;
  font-weight: 400;
}

/* ==========================================================================
   SELECT DROPDOWN
   ========================================================================== */
.inv-kit__select-wrap {
  position: relative;
}

.inv-kit__select {
  width: 100%;
  height: 44px;
  padding: 0 40px 0 14px;
  border: 1px solid var(--kit-border);
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  background: #fff;
  color: var(--kit-text);
  cursor: pointer;
  appearance: none;
  transition: border-color 0.15s;
}

.inv-kit__select:hover {
  border-color: #ccc;
}

.inv-kit__select:focus {
  outline: none;
  border-color: var(--kit-brand);
}

.inv-kit__select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #999;
  width: 16px;
  height: 16px;
}

/* ==========================================================================
   QUANTITY (Only shown when battery selected)
   ========================================================================== */
.inv-kit__qty-wrap {
  display: none;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px dashed var(--kit-border);
}

.inv-kit__qty-wrap--visible {
  display: flex;
}

.inv-kit__qty-label {
  font-size: 13px;
  color: var(--kit-muted);
}

.inv-kit__qty {
  display: inline-flex;
  border: 1px solid var(--kit-border);
  border-radius: 6px;
  overflow: hidden;
}

.inv-kit__qty-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--kit-text);
  transition: background 0.15s;
}

.inv-kit__qty-btn:hover {
  background: var(--kit-bg);
}

.inv-kit__qty-btn:active {
  background: var(--kit-brand-light);
}

.inv-kit__qty-btn svg {
  width: 14px;
  height: 14px;
}

.inv-kit__qty-input {
  width: 44px;
  height: 36px;
  border: none;
  border-left: 1px solid var(--kit-border);
  border-right: 1px solid var(--kit-border);
  text-align: center;
  font-size: 15px;
  font-weight: 700;
  font-family: inherit;
  color: var(--kit-text);
  -moz-appearance: textfield;
}

.inv-kit__qty-input::-webkit-outer-spin-button,
.inv-kit__qty-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
}

.inv-kit__qty-hint {
  font-size: 12px;
  color: var(--kit-brand-dark);
  font-weight: 600;
}

/* ==========================================================================
   SUMMARY FOOTER
   ========================================================================== */
.inv-kit__summary {
  background: var(--kit-bg);
  padding: 16px;
  border-top: 2px solid var(--kit-brand);
}

.inv-kit__summary-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
}

.inv-kit__summary-label {
  font-size: 13px;
  color: var(--kit-muted);
}

.inv-kit__summary-total {
  font-size: 22px;
  font-weight: 800;
  color: var(--kit-text);
}

.inv-kit__summary-total--empty {
  font-size: 14px;
  font-weight: 500;
  color: #999;
}

.inv-kit__summary-savings {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--kit-border);
  display: flex;
  align-items: center;
  gap: 6px;
}

.inv-kit__summary-savings[hidden] {
  display: none;
}

.inv-kit__summary-savings svg {
  width: 16px;
  height: 16px;
  color: var(--kit-success);
}

.inv-kit__summary-savings-text {
  font-size: 13px;
  font-weight: 600;
  color: var(--kit-success);
}

/* ==========================================================================
   ADD KIT BUTTON
   ========================================================================== */
.inv-kit__add-btn {
  width: 100%;
  height: 48px;
  margin-top: 12px;
  border: none;
  border-radius: 6px;
  background: var(--kit-brand);
  color: #fff;
  font-size: 15px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  transition: background 0.15s, opacity 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.inv-kit__add-btn:hover {
  background: var(--kit-brand-dark);
}

.inv-kit__add-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.inv-kit[data-brand="dewalt"] .inv-kit__add-btn {
  color: #1a1a1a;
}

.inv-kit__add-btn svg {
  width: 18px;
  height: 18px;
}

/* Spinner */
@keyframes inv-kit-spin {
  to { transform: rotate(360deg); }
}

.inv-kit__spinner {
  animation: inv-kit-spin 0.8s linear infinite;
}

/* ==========================================================================
   RESPONSIVE
   ========================================================================== */
@media (max-width: 480px) {
  .inv-kit__header {
    padding: 14px;
  }
  
  .inv-kit__icon {
    width: 36px;
    height: 36px;
  }
  
  .inv-kit__icon svg {
    width: 18px;
    height: 18px;
  }
  
  .inv-kit__title {
    font-size: 14px;
  }
  
  .inv-kit__row {
    padding: 14px;
  }
  
  .inv-kit__select {
    height: 42px;
    font-size: 13px;
  }
  
  .inv-kit__summary {
    padding: 14px;
  }
  
  .inv-kit__summary-total {
    font-size: 20px;
  }
  
  .inv-kit__add-btn {
    height: 46px;
    font-size: 14px;
  }
}
</style>

<!-- ========================================================================
     HTML
     ======================================================================== -->
<div class="inv-kit" data-kit-builder data-brand="{{ kit_brand }}" data-expanded="true" data-tool-price="{{ product.selected_or_first_available_variant.price }}" data-tool-id="{{ product.selected_or_first_available_variant.id }}" data-discount-code="{% if kit_brand == 'makita' %}MAKITA-KIT{% elsif kit_brand == 'dewalt' %}DEWALT-KIT{% endif %}">
  
  <!-- HEADER (Click to expand) -->
  <div class="inv-kit__header" data-kit-toggle>
    <div class="inv-kit__header-left">
      <div class="inv-kit__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="1" y="3" width="15" height="13"/>
          <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
          <circle cx="5.5" cy="18.5" r="2.5"/>
          <circle cx="18.5" cy="18.5" r="2.5"/>
        </svg>
      </div>
      <div class="inv-kit__header-text">
        <h3 class="inv-kit__title">Build & Save</h3>
        <span class="inv-kit__subtitle">Bundle batteries, charger & case</span>
      </div>
    </div>
    <div class="inv-kit__toggle">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
    </div>
  </div>
  
  <!-- BODY -->
  <div class="inv-kit__body">
    
    <!-- BATTERIES -->
    {% if has_batteries %}
    <div class="inv-kit__row" data-row="battery">
      <div class="inv-kit__row-header">
        <div class="inv-kit__row-left">
          <span class="inv-kit__row-label">Batteries</span>
          <span class="inv-kit__badge" data-badge="battery">Buy 2 = 15% off</span>
        </div>
        <div class="inv-kit__row-price inv-kit__row-price--empty" data-price="battery">
          <span class="inv-kit__price-was" data-price-was="battery" style="display:none;"></span>
          <span data-price-now="battery">—</span>
        </div>
      </div>
      
      <div class="inv-kit__select-wrap">
        <select class="inv-kit__select" data-select="battery" aria-label="Select battery">
          <option value="" data-price="0" data-kit-price="0">Select battery...</option>
          {% for battery in battery_collection.products %}
            {% liquid
              assign batt_variant = battery.variants.first
              assign batt_price = batt_variant.price
              assign batt_available = batt_variant.available
              assign batt_title_down = battery.title | downcase
              assign batt_kit_price = batt_price
              
              if kit_brand == 'makita'
                if batt_title_down contains '3.0ah' or batt_title_down contains '3ah'
                  assign batt_kit_price = 4000
                elsif batt_title_down contains '5.0ah' or batt_title_down contains '5ah'
                  assign batt_kit_price = 6000
                elsif batt_title_down contains '6.0ah' or batt_title_down contains '6ah'
                  assign batt_kit_price = 7800
                endif
              endif
            %}
            <option 
              value="{{ batt_variant.id }}"
              data-price="{{ batt_price }}"
              data-kit-price="{{ batt_kit_price }}"
              data-title="{{ battery.title | escape }}"
              {% unless batt_available %}disabled{% endunless %}
            >
              {{ battery.title }} — {{ batt_price | money }}{% unless batt_available %} (Sold out){% endunless %}
            </option>
          {% endfor %}
        </select>
        <svg class="inv-kit__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      
      <!-- Qty (hidden until battery selected) -->
      <div class="inv-kit__qty-wrap" data-qty-wrap="battery">
        <span class="inv-kit__qty-label">Qty:</span>
        <div class="inv-kit__qty">
          <button type="button" class="inv-kit__qty-btn" data-qty-btn="decrease" aria-label="Decrease">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <input type="number" class="inv-kit__qty-input" data-qty-input="battery" value="1" min="1" max="4" readonly>
          <button type="button" class="inv-kit__qty-btn" data-qty-btn="increase" aria-label="Increase">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <span class="inv-kit__qty-hint" data-qty-hint>Buy 2 for 15% off!</span>
      </div>
    </div>
    {% endif %}
    
    <!-- CHARGER -->
    {% if has_chargers %}
    <div class="inv-kit__row" data-row="charger">
      <div class="inv-kit__row-header">
        <div class="inv-kit__row-left">
          <span class="inv-kit__row-label">Charger</span>
          <span class="inv-kit__badge" data-badge="charger" style="display:none;">Saving!</span>
        </div>
        <div class="inv-kit__row-price inv-kit__row-price--empty" data-price="charger">
          <span class="inv-kit__price-was" data-price-was="charger" style="display:none;"></span>
          <span data-price-now="charger">—</span>
        </div>
      </div>
      
      <div class="inv-kit__select-wrap">
        <select class="inv-kit__select" data-select="charger" aria-label="Select charger">
          <option value="" data-price="0" data-kit-price="0">No charger</option>
          {% for charger in charger_collection.products %}
            {% liquid
              assign chrg_variant = charger.variants.first
              assign chrg_price = chrg_variant.price
              assign chrg_available = chrg_variant.available
              assign chrg_title_down = charger.title | downcase
              assign chrg_kit_price = chrg_price
              
              if kit_brand == 'makita'
                if chrg_title_down contains 'dc18rc'
                  assign chrg_kit_price = 2399
                elsif chrg_title_down contains 'dc18sd'
                  assign chrg_kit_price = 1199
                endif
              endif
            %}
            <option 
              value="{{ chrg_variant.id }}"
              data-price="{{ chrg_price }}"
              data-kit-price="{{ chrg_kit_price }}"
              data-title="{{ charger.title | escape }}"
              {% unless chrg_available %}disabled{% endunless %}
            >
              {{ charger.title }} — {{ chrg_price | money }}{% unless chrg_available %} (Sold out){% endunless %}
            </option>
          {% endfor %}
        </select>
        <svg class="inv-kit__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
    </div>
    {% endif %}
    
    <!-- CASE -->
    {% if has_cases %}
    <div class="inv-kit__row" data-row="case">
      <div class="inv-kit__row-header">
        <div class="inv-kit__row-left">
          <span class="inv-kit__row-label">Case</span>
          <span class="inv-kit__badge" data-badge="case" style="display:none;">Saving!</span>
        </div>
        <div class="inv-kit__row-price inv-kit__row-price--empty" data-price="case">
          <span class="inv-kit__price-was" data-price-was="case" style="display:none;"></span>
          <span data-price-now="case">—</span>
        </div>
      </div>
      
      <div class="inv-kit__select-wrap">
        <select class="inv-kit__select" data-select="case" aria-label="Select case">
          <option value="" data-price="0" data-kit-price="0">No case</option>
          {% for case in case_collection.products %}
            {% liquid
              assign case_variant = case.variants.first
              assign case_price = case_variant.price
              assign case_available = case_variant.available
              assign case_title_down = case.title | downcase
              assign case_kit_price = case_price
              
              if kit_brand == 'makita'
                if case_title_down contains 'makpac 3' or case_title_down contains 'makpac type 3'
                  assign case_kit_price = 1500
                elsif case_title_down contains 'makpac 4' or case_title_down contains 'makpac type 4'
                  assign case_kit_price = 2500
                endif
              endif
            %}
            <option 
              value="{{ case_variant.id }}"
              data-price="{{ case_price }}"
              data-kit-price="{{ case_kit_price }}"
              data-title="{{ case.title | escape }}"
              {% unless case_available %}disabled{% endunless %}
            >
              {{ case.title }} — {{ case_price | money }}{% unless case_available %} (Sold out){% endunless %}
            </option>
          {% endfor %}
        </select>
        <svg class="inv-kit__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
    </div>
    {% endif %}
    
    <!-- SUMMARY -->
    <div class="inv-kit__summary">
      <div class="inv-kit__summary-row">
        <span class="inv-kit__summary-label">Kit total (inc. tool)</span>
        <span class="inv-kit__summary-total inv-kit__summary-total--empty" data-kit-total>Select items above</span>
      </div>
      
      <div class="inv-kit__summary-savings" data-savings-row hidden>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <span class="inv-kit__summary-savings-text" data-kit-savings>You save £0.00</span>
      </div>
      
      <button type="button" class="inv-kit__add-btn" data-add-kit-btn disabled>
        <span data-btn-text>Add Kit to Cart</span>
        <svg class="inv-kit__spinner" data-btn-loading style="display:none;" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    
  </div>
</div>

<!-- ========================================================================
     JAVASCRIPT v4.0
     ======================================================================== -->
<script>
(function() {
  'use strict';
  
  const kit = document.querySelector('[data-kit-builder]');
  if (!kit) return;
  
  /* ================================================================
     ELEMENTS
     ================================================================ */
  const toggle = kit.querySelector('[data-kit-toggle]');
  const batterySelect = kit.querySelector('[data-select="battery"]');
  const batteryQtyWrap = kit.querySelector('[data-qty-wrap="battery"]');
  const batteryQtyInput = kit.querySelector('[data-qty-input="battery"]');
  const batteryQtyHint = kit.querySelector('[data-qty-hint]');
  const chargerSelect = kit.querySelector('[data-select="charger"]');
  const caseSelect = kit.querySelector('[data-select="case"]');
  
  const totalEl = kit.querySelector('[data-kit-total]');
  const savingsEl = kit.querySelector('[data-kit-savings]');
  const savingsRow = kit.querySelector('[data-savings-row]');
  const addBtn = kit.querySelector('[data-add-kit-btn]');
  const btnText = kit.querySelector('[data-btn-text]');
  const btnLoading = kit.querySelector('[data-btn-loading]');
  
  // Price elements
  const batteryPriceWrap = kit.querySelector('[data-price="battery"]');
  const batteryPriceWas = kit.querySelector('[data-price-was="battery"]');
  const batteryPriceNow = kit.querySelector('[data-price-now="battery"]');
  const chargerPriceWrap = kit.querySelector('[data-price="charger"]');
  const chargerPriceWas = kit.querySelector('[data-price-was="charger"]');
  const chargerPriceNow = kit.querySelector('[data-price-now="charger"]');
  const casePriceWrap = kit.querySelector('[data-price="case"]');
  const casePriceWas = kit.querySelector('[data-price-was="case"]');
  const casePriceNow = kit.querySelector('[data-price-now="case"]');
  
  // Badges
  const batteryBadge = kit.querySelector('[data-badge="battery"]');
  const chargerBadge = kit.querySelector('[data-badge="charger"]');
  const caseBadge = kit.querySelector('[data-badge="case"]');
  
  // Tool data
  const toolPrice = parseInt(kit.dataset.toolPrice || '0', 10);
  const toolId = kit.dataset.toolId;
  const discountCode = kit.dataset.discountCode || '';
  
  /* ================================================================
     HELPERS
     ================================================================ */
  const fmt = (p) => p > 0 ? '£' + (p / 100).toFixed(2) : '£0.00';
  
  const getData = (sel) => {
    if (!sel || !sel.value) return { id: null, price: 0, kitPrice: 0 };
    const o = sel.options[sel.selectedIndex];
    return {
      id: o.value,
      price: parseInt(o.dataset.price || '0', 10),
      kitPrice: parseInt(o.dataset.kitPrice || o.dataset.price || '0', 10)
    };
  };
  
  /* ================================================================
     TOGGLE EXPAND/COLLAPSE
     ================================================================ */
  if (toggle) {
    toggle.addEventListener('click', () => {
      const expanded = kit.dataset.expanded === 'true';
      kit.dataset.expanded = expanded ? 'false' : 'true';
    });
  }
  
  /* ================================================================
     CALCULATIONS
     ================================================================ */
  const calc = () => {
    const bQty = batteryQtyInput ? parseInt(batteryQtyInput.value, 10) || 0 : 0;
    const b = getData(batterySelect);
    const c = getData(chargerSelect);
    const k = getData(caseSelect);
    
    // Battery discount: 2+ batteries
    const bDisc = b.id && bQty >= 2;
    
    // Full kit = battery + charger + case (all three selected)
    const hasFullKit = (b.id && bQty > 0) && c.id && k.id;
    
    // Charger/Case ONLY get kit price when full kit is built
    const cDisc = hasFullKit;
    const kDisc = hasFullKit;
    
    // Battery pricing
    let bFull = 0, bKit = 0;
    if (b.id && bQty > 0) {
      bFull = b.price * bQty;
      bKit = bDisc ? b.kitPrice * bQty : bFull;
    }
    
    // Charger pricing
    let cFull = 0, cKit = 0;
    if (c.id) {
      cFull = c.price;
      cKit = cDisc ? c.kitPrice : cFull;
    }
    
    // Case pricing
    let kFull = 0, kKit = 0;
    if (k.id) {
      kFull = k.price;
      kKit = kDisc ? k.kitPrice : kFull;
    }
    
    const accessoriesTotal = bKit + cKit + kKit;
    const hasItems = (b.id && bQty > 0) || c.id || k.id;
    
    return {
      bQty, b, c, k,
      bFull, bKit, cFull, cKit, kFull, kKit,
      bDisc, cDisc, kDisc, hasFullKit,
      accessoriesTotal,
      total: toolPrice + accessoriesTotal,
      savings: (bFull + cFull + kFull) - accessoriesTotal,
      hasItems
    };
  };
  
  /* ================================================================
     UPDATE UI
     ================================================================ */
  const update = () => {
    const d = calc();
    
    // ----- Battery row -----
    if (batteryQtyWrap) {
      batteryQtyWrap.classList.toggle('inv-kit__qty-wrap--visible', !!d.b.id);
    }
    
    if (batteryQtyHint) {
      if (d.b.id && d.bQty < 2) {
        batteryQtyHint.textContent = 'Buy 2 for 15% off!';
        batteryQtyHint.style.display = '';
      } else if (d.bDisc) {
        batteryQtyHint.textContent = '15% off applied!';
        batteryQtyHint.style.display = '';
      } else {
        batteryQtyHint.style.display = 'none';
      }
    }
    
    if (batteryPriceNow) {
      if (d.b.id && d.bQty > 0) {
        batteryPriceNow.textContent = fmt(d.bKit);
        batteryPriceWrap.classList.remove('inv-kit__row-price--empty');
        batteryPriceWrap.classList.toggle('inv-kit__row-price--discount', d.bDisc);
      } else {
        batteryPriceNow.textContent = '—';
        batteryPriceWrap.classList.add('inv-kit__row-price--empty');
        batteryPriceWrap.classList.remove('inv-kit__row-price--discount');
      }
    }
    
    if (batteryPriceWas) {
      if (d.bDisc && d.bFull > d.bKit) {
        batteryPriceWas.textContent = fmt(d.bFull);
        batteryPriceWas.style.display = '';
      } else {
        batteryPriceWas.style.display = 'none';
      }
    }
    
    if (batteryBadge) {
      batteryBadge.classList.toggle('inv-kit__badge--active', d.bDisc);
      batteryBadge.textContent = d.bDisc ? '15% off!' : 'Buy 2 = 15% off';
    }
    
    // ----- Charger row -----
    if (chargerPriceNow) {
      if (d.c.id) {
        chargerPriceNow.textContent = fmt(d.cKit);
        chargerPriceWrap.classList.remove('inv-kit__row-price--empty');
        chargerPriceWrap.classList.toggle('inv-kit__row-price--discount', d.cDisc);
      } else {
        chargerPriceNow.textContent = '—';
        chargerPriceWrap.classList.add('inv-kit__row-price--empty');
        chargerPriceWrap.classList.remove('inv-kit__row-price--discount');
      }
    }
    
    if (chargerPriceWas) {
      if (d.cDisc && d.cFull > d.cKit) {
        chargerPriceWas.textContent = fmt(d.cFull);
        chargerPriceWas.style.display = '';
      } else {
        chargerPriceWas.style.display = 'none';
      }
    }
    
    if (chargerBadge) {
      if (d.hasFullKit) {
        chargerBadge.textContent = 'Kit price!';
        chargerBadge.classList.add('inv-kit__badge--active');
        chargerBadge.style.display = '';
      } else if (d.c.id && d.b.id && d.bQty > 0 && !d.k.id) {
        // Has battery + charger, missing case
        chargerBadge.textContent = '+ case for kit price';
        chargerBadge.classList.remove('inv-kit__badge--active');
        chargerBadge.style.display = '';
      } else if (d.c.id && (!d.b.id || d.bQty === 0)) {
        // Has charger, missing battery
        chargerBadge.textContent = '+ battery & case for kit price';
        chargerBadge.classList.remove('inv-kit__badge--active');
        chargerBadge.style.display = '';
      } else {
        chargerBadge.style.display = 'none';
      }
    }
    
    // ----- Case row -----
    if (casePriceNow) {
      if (d.k.id) {
        casePriceNow.textContent = fmt(d.kKit);
        casePriceWrap.classList.remove('inv-kit__row-price--empty');
        casePriceWrap.classList.toggle('inv-kit__row-price--discount', d.kDisc);
      } else {
        casePriceNow.textContent = '—';
        casePriceWrap.classList.add('inv-kit__row-price--empty');
        casePriceWrap.classList.remove('inv-kit__row-price--discount');
      }
    }
    
    if (casePriceWas) {
      if (d.kDisc && d.kFull > d.kKit) {
        casePriceWas.textContent = fmt(d.kFull);
        casePriceWas.style.display = '';
      } else {
        casePriceWas.style.display = 'none';
      }
    }
    
    if (caseBadge) {
      if (d.hasFullKit) {
        caseBadge.textContent = 'Kit price!';
        caseBadge.classList.add('inv-kit__badge--active');
        caseBadge.style.display = '';
      } else if (d.k.id && d.b.id && d.bQty > 0 && !d.c.id) {
        // Has battery + case, missing charger
        caseBadge.textContent = '+ charger for kit price';
        caseBadge.classList.remove('inv-kit__badge--active');
        caseBadge.style.display = '';
      } else if (d.k.id && (!d.b.id || d.bQty === 0)) {
        // Has case, missing battery
        caseBadge.textContent = '+ battery & charger for kit price';
        caseBadge.classList.remove('inv-kit__badge--active');
        caseBadge.style.display = '';
      } else {
        caseBadge.style.display = 'none';
      }
    }
    
    // ----- Summary -----
    if (totalEl) {
      if (d.hasItems) {
        totalEl.textContent = fmt(d.total);
        totalEl.classList.remove('inv-kit__summary-total--empty');
      } else {
        totalEl.textContent = 'Select items above';
        totalEl.classList.add('inv-kit__summary-total--empty');
      }
    }
    
    if (savingsRow) {
      if (d.savings > 0) {
        savingsEl.textContent = 'You save ' + fmt(d.savings);
        savingsRow.hidden = false;
      } else {
        savingsRow.hidden = true;
      }
    }
    
    // ----- Add Kit Button -----
    if (addBtn) {
      addBtn.disabled = !d.hasItems;
    }
  };
  
  /* ================================================================
     EVENT LISTENERS
     ================================================================ */
  // Battery select
  if (batterySelect) {
    batterySelect.addEventListener('change', () => {
      // Reset qty to 1 when battery selected, 0 when cleared
      if (batteryQtyInput) {
        batteryQtyInput.value = batterySelect.value ? '1' : '0';
      }
      update();
    });
  }
  
  // Charger select
  if (chargerSelect) {
    chargerSelect.addEventListener('change', update);
  }
  
  // Case select
  if (caseSelect) {
    caseSelect.addEventListener('change', update);
  }
  
  // Qty buttons
  kit.querySelectorAll('[data-qty-btn]').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!batteryQtyInput) return;
      
      let val = parseInt(batteryQtyInput.value, 10) || 1;
      const action = btn.dataset.qtyBtn;
      
      if (action === 'increase' && val < 4) {
        val++;
      } else if (action === 'decrease' && val > 1) {
        val--;
      }
      
      batteryQtyInput.value = val;
      update();
    });
  });
  
  /* ================================================================
     ADD KIT TO CART
     ================================================================ */
  if (addBtn) {
    addBtn.addEventListener('click', async () => {
      const d = calc();
      if (!d.hasItems) return;
      
      // Build items array
      const items = [];
      
      // Always add tool
      items.push({ id: parseInt(toolId, 10), quantity: 1 });
      
      // Add battery
      if (d.b.id && d.bQty > 0) {
        items.push({ id: parseInt(d.b.id, 10), quantity: d.bQty });
      }
      
      // Add charger
      if (d.c.id) {
        items.push({ id: parseInt(d.c.id, 10), quantity: 1 });
      }
      
      // Add case
      if (d.k.id) {
        items.push({ id: parseInt(d.k.id, 10), quantity: 1 });
      }
      
      // DEBUG
      console.log('[Kit Builder] Adding items:', items);
      console.log('[Kit Builder] Calc data:', d);
      
      // Show loading
      addBtn.disabled = true;
      if (btnText) btnText.style.display = 'none';
      if (btnLoading) btnLoading.style.display = '';
      
      try {
        const res = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });
        
        const responseData = await res.json();
        console.log('[Kit Builder] Cart response:', responseData);
        
        if (!res.ok) throw new Error('Failed to add');
        
        // Success — apply discount code and go to cart
        if (btnText) btnText.textContent = 'Added!';
        if (btnText) btnText.style.display = '';
        if (btnLoading) btnLoading.style.display = 'none';
        
        // Apply discount code via redirect
        if (discountCode) {
          // Redirect to apply discount, then to cart
          window.location.href = '/discount/' + discountCode + '?redirect=/cart';
        } else {
          // No discount code, just go to cart
          window.location.href = '/cart';
        }
        
      } catch (err) {
        console.error('[Kit Builder]', err);
        if (btnText) btnText.textContent = 'Error — Try Again';
        if (btnText) btnText.style.display = '';
        if (btnLoading) btnLoading.style.display = 'none';
        addBtn.disabled = false;
        
        setTimeout(() => {
          if (btnText) btnText.textContent = 'Add Kit to Cart';
        }, 2000);
      }
    });
  }
  
  // Initial update
  update();
  
})();
</script>
{% endif %}
