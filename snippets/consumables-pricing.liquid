{% comment %}
  Consumables Pricing Chart
  =========================
  Displays a per-unit pricing chart for consumable products.
  
  Reads from product metafield: custom.pack_pricing
  Expected format JSON: 
  {
    "unit": "piece",
    "packs": [
      {"qty": 100, "price": 1200},
      {"qty": 500, "price": 5500},
      {"qty": 1000, "price": 9900}
    ]
  }
  
  Or simple format: "100:12.00,500:55.00,1000:99.00"
  
  Usage: {% render 'consumables-pricing', product: product %}
  
  Version: 1.0.0
  Author: Invicta Tools Theme
{% endcomment %}

{%- liquid
  # Check for pack pricing metafield
  assign pack_data = product.metafields.custom.pack_pricing.value
  assign has_pack_pricing = false
  assign unit_name = 'piece'
  
  if pack_data != blank
    assign has_pack_pricing = true
    
    # Try to parse unit name if JSON format
    if pack_data.unit != blank
      assign unit_name = pack_data.unit
    endif
  endif
-%}

{%- if has_pack_pricing -%}
  <div class="invicta-pack-pricing" data-pack-pricing>
    <h4 class="invicta-pack-pricing__title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="3" y1="9" x2="21" y2="9"></line>
        <line x1="9" y1="21" x2="9" y2="9"></line>
      </svg>
      Price Comparison by Pack Size
    </h4>
    
    <div class="invicta-pack-pricing__table">
      <div class="invicta-pack-pricing__header">
        <span>Pack Size</span>
        <span>Pack Price</span>
        <span>Per {{ unit_name | capitalize }}</span>
      </div>
      
      {%- if pack_data.packs != blank -%}
        <!-- JSON format -->
        {%- for pack in pack_data.packs -%}
          {%- liquid
            assign pack_qty = pack.qty | plus: 0
            assign pack_price = pack.price | plus: 0
            assign per_unit = pack_price | divided_by: pack_qty | round: 2
          -%}
          <div class="invicta-pack-pricing__row" data-pack-qty="{{ pack_qty }}">
            <span class="invicta-pack-pricing__qty">{{ pack_qty }}</span>
            <span class="invicta-pack-pricing__price">{{ pack_price | money }}</span>
            <span class="invicta-pack-pricing__per-unit">
              {{ per_unit | money }}
              <small>/{{ unit_name }}</small>
            </span>
          </div>
        {%- endfor -%}
        
      {%- else -%}
        <!-- Simple format: "100:12.00,500:55.00,1000:99.00" -->
        {%- assign packs = pack_data | split: ',' -%}
        {%- for pack in packs -%}
          {%- liquid
            assign pack_parts = pack | split: ':'
            assign pack_qty = pack_parts[0] | plus: 0
            assign pack_price = pack_parts[1] | times: 100 | round
            assign per_unit_pence = pack_price | divided_by: pack_qty
          -%}
          <div class="invicta-pack-pricing__row" data-pack-qty="{{ pack_qty }}">
            <span class="invicta-pack-pricing__qty">{{ pack_qty }}</span>
            <span class="invicta-pack-pricing__price">Â£{{ pack_parts[1] }}</span>
            <span class="invicta-pack-pricing__per-unit">
              Â£{{ per_unit_pence | divided_by: 100.0 | round: 3 }}
              <small>/{{ unit_name }}</small>
            </span>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>
    
    <p class="invicta-pack-pricing__note">
      ðŸ’¡ Larger packs = better value per {{ unit_name }}
    </p>
  </div>
{%- endif -%}

<style>
  .invicta-pack-pricing {
    margin: 20px 0;
    padding: 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
  }
  
  .invicta-pack-pricing__title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 0 14px;
    font-size: 1rem;
    font-weight: 700;
    color: #1e293b;
  }
  
  .invicta-pack-pricing__title svg {
    color: #3b82f6;
  }
  
  .invicta-pack-pricing__table {
    width: 100%;
  }
  
  .invicta-pack-pricing__header {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    padding: 10px 12px;
    background: #e2e8f0;
    border-radius: 6px 6px 0 0;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #475569;
  }
  
  .invicta-pack-pricing__row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
    transition: background 0.15s ease;
  }
  
  .invicta-pack-pricing__row:last-child {
    border-bottom: none;
    border-radius: 0 0 6px 6px;
  }
  
  .invicta-pack-pricing__row:hover {
    background: #f1f5f9;
  }
  
  /* Best value indicator for largest pack */
  .invicta-pack-pricing__row:last-child {
    background: #ecfdf5;
    border: 1px solid #a7f3d0;
  }
  
  .invicta-pack-pricing__row:last-child::before {
    content: 'â˜… Best Value';
    position: absolute;
    top: -10px;
    right: 10px;
    padding: 2px 8px;
    background: #22c55e;
    color: #fff;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 4px;
  }
  
  .invicta-pack-pricing__row:last-child {
    position: relative;
    margin-top: 12px;
    border-radius: 6px;
  }
  
  .invicta-pack-pricing__qty {
    font-weight: 600;
    color: #1e293b;
  }
  
  .invicta-pack-pricing__price {
    font-weight: 500;
    color: #475569;
  }
  
  .invicta-pack-pricing__per-unit {
    font-weight: 700;
    color: #059669;
  }
  
  .invicta-pack-pricing__per-unit small {
    font-weight: 400;
    color: #6b7280;
  }
  
  .invicta-pack-pricing__note {
    margin: 14px 0 0;
    font-size: 0.85rem;
    color: #64748b;
    text-align: center;
  }
  
  /* Mobile adjustments */
  @media screen and (max-width: 400px) {
    .invicta-pack-pricing__header,
    .invicta-pack-pricing__row {
      grid-template-columns: 1fr 1fr;
    }
    
    .invicta-pack-pricing__header span:last-child,
    .invicta-pack-pricing__row span:last-child {
      grid-column: 1 / -1;
      text-align: left;
      padding-top: 4px;
      font-size: 0.95rem;
    }
  }
</style>
