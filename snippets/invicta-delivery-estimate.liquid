{% comment %}
  ============================================
  INVICTA DELIVERY ESTIMATE v1.0
  Reusable across product pages, cart, and cart drawer
  
  Usage:
    {% render 'invicta-delivery-estimate' %}
    {% render 'invicta-delivery-estimate', compact: true %}
  ============================================
{% endcomment %}

{% liquid
  assign is_compact = compact | default: false
%}

<div class="inv-del-est{% if is_compact %} inv-del-est--compact{% endif %}" data-inv-delivery-estimate>
  <div class="inv-del-est__row inv-del-est__delivery">
    <svg class="inv-del-est__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <rect x="1" y="3" width="15" height="13" rx="1"></rect>
      <path d="M16 8h4l3 3v5h-7V8z"></path>
      <circle cx="5.5" cy="18.5" r="2.5"></circle>
      <circle cx="18.5" cy="18.5" r="2.5"></circle>
    </svg>
    <span class="inv-del-est__text">
      <span data-inv-del-order-text>Order now for delivery </span>
      <strong data-inv-del-countdown style="display:none"></strong>
      <span data-inv-del-for-text style="display:none"> for delivery </span>
      <strong data-inv-del-day class="inv-del-est__day">Monday</strong>
    </span>
  </div>
  {% unless is_compact %}
  <div class="inv-del-est__row inv-del-est__returns">
    <svg class="inv-del-est__icon inv-del-est__icon--muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
    </svg>
    <span class="inv-del-est__meta">30-day returns Â· Full manufacturer warranty</span>
  </div>
  {% endunless %}
</div>

<style>
  .inv-del-est {
    border: 2px solid var(--inv-accent, #e11d26);
    border-radius: var(--inv-radius-card, 12px);
    padding: 12px 16px;
    background: linear-gradient(135deg, #fef2f2, #fff);
    margin: 12px 0;
  }
  .inv-del-est--compact {
    border-width: 1px;
    border-color: var(--inv-border, #e5e7eb);
    padding: 10px 14px;
    background: var(--inv-bg-elevated, #fff);
    border-radius: 8px;
    margin: 8px 0;
  }
  .inv-del-est__row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .inv-del-est__delivery {
    font-size: 15px;
    font-weight: 500;
    color: var(--inv-fg, #0f172a);
  }
  .inv-del-est__icon {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
    color: var(--inv-accent, #e11d26);
  }
  .inv-del-est__icon--muted {
    color: var(--inv-fg-muted, #6b7280);
    width: 18px;
    height: 18px;
  }
  .inv-del-est__day {
    color: var(--inv-accent, #e11d26);
  }
  .inv-del-est__returns {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--inv-border, #e5e7eb);
  }
  .inv-del-est__meta {
    font-size: 13px;
    color: var(--inv-fg-muted, #6b7280);
  }
  .inv-del-est--compact .inv-del-est__delivery {
    font-size: 13px;
  }
  .inv-del-est--compact .inv-del-est__icon {
    width: 18px;
    height: 18px;
  }
</style>

<script>
(function() {
  document.querySelectorAll('[data-inv-delivery-estimate]').forEach(function(el) {
    var dayEl = el.querySelector('[data-inv-del-day]');
    var countdownEl = el.querySelector('[data-inv-del-countdown]');
    var orderTextEl = el.querySelector('[data-inv-del-order-text]');
    var forTextEl = el.querySelector('[data-inv-del-for-text]');
    if (!dayEl) return;
    
    var cutoffHour = 14;
    
    function getDeliveryDay() {
      var now = new Date();
      var day = now.getDay();
      var hour = now.getHours();
      var pastCutoff = hour >= cutoffHour;
      
      // Map: current day -> delivery day name
      // If before cutoff on weekday: next working day
      // If after cutoff: day after next working day
      var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      
      if (day >= 1 && day <= 4 && !pastCutoff) {
        // Mon-Thu before 2pm -> tomorrow
        return days[day + 1];
      } else if (day >= 1 && day <= 3 && pastCutoff) {
        // Mon-Wed after 2pm -> day after tomorrow
        return days[day + 2];
      } else if (day === 4 && pastCutoff) {
        // Thu after 2pm -> Monday
        return 'Monday';
      } else if (day === 5 && !pastCutoff) {
        // Fri before 2pm -> Monday
        return 'Monday';
      } else if (day === 5 && pastCutoff) {
        // Fri after 2pm -> Tuesday
        return 'Tuesday';
      } else if (day === 6) {
        // Saturday -> Tuesday
        return 'Tuesday';
      } else {
        // Sunday -> Tuesday
        return 'Tuesday';
      }
    }
    
    function update() {
      var now = new Date();
      var hour = now.getHours();
      var day = now.getDay();
      var isWeekday = day >= 1 && day <= 5;
      var beforeCutoff = hour < cutoffHour;
      
      dayEl.textContent = getDeliveryDay();
      
      if (isWeekday && beforeCutoff && countdownEl) {
        // Show countdown
        var cutoff = new Date();
        cutoff.setHours(cutoffHour, 0, 0, 0);
        var diff = cutoff - now;
        var h = Math.floor(diff / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);
        countdownEl.textContent = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
        countdownEl.style.display = 'inline';
        forTextEl.style.display = 'inline';
        orderTextEl.textContent = 'Order within ';
      } else {
        if (countdownEl) countdownEl.style.display = 'none';
        if (forTextEl) forTextEl.style.display = 'none';
        orderTextEl.textContent = 'Order now for delivery ';
      }
    }
    
    update();
    setInterval(update, 1000);
  });
})();
</script>
