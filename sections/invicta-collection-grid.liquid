{% comment %}
  ============================================
  INVICTA COLLECTION GRID v6.0
  ============================================
  Features:
  - Toolbar with count, VAT toggle, sort
  - VAT toggle applies body class
  - Listens for view toggle events
  - AJAX pagination
  
  Trade 15.4.0 Compatible
  ============================================
{% endcomment %}

{%- liquid
  assign products_per_page = section.settings.products_per_page | default: 24
  assign show_vat_toggle = section.settings.show_vat_toggle
  assign show_sort = section.settings.show_sort
  assign current_sort = collection.sort_by | default: collection.default_sort_by
-%}

<div class="inv-col-grid" data-section-id="{{ section.id }}">
  
  {%- comment -%} Toolbar {%- endcomment -%}
  <div class="inv-col-grid__toolbar">
    <div class="page-width">
      <div class="inv-col-grid__toolbar-inner">
        
        <p class="inv-col-grid__count" id="grid-product-count">
          <strong>{{ collection.products_count }}</strong> 
          {{ collection.products_count | pluralize: 'result', 'results' }}
        </p>
        
        <div class="inv-col-grid__controls">
          
          {%- if show_vat_toggle -%}
            <div class="inv-col-grid__vat" id="vat-toggle-container">
              <button type="button" class="inv-col-grid__vat-btn" data-vat="ex">Ex VAT</button>
              <button type="button" class="inv-col-grid__vat-btn inv-col-grid__vat-btn--active" data-vat="inc">Inc VAT</button>
            </div>
          {%- endif -%}
          
          {%- if show_sort -%}
            <div class="inv-col-grid__sort">
              <label for="inv-sort" class="inv-col-grid__sort-label">Sort:</label>
              <div class="inv-col-grid__sort-wrap">
                <select id="inv-sort" class="inv-col-grid__sort-select" data-sort-select>
                  {%- for option in collection.sort_options -%}
                    <option value="{{ option.value }}"{% if option.value == current_sort %} selected{% endif %}>
                      {{ option.name }}
                    </option>
                  {%- endfor -%}
                </select>
                <svg class="inv-col-grid__sort-chevron" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
            </div>
          {%- endif -%}
          
        </div>
        
      </div>
    </div>
  </div>
  
  {%- comment -%} Grid {%- endcomment -%}
  <div class="inv-col-grid__main">
    <div class="page-width">
      
      {%- paginate collection.products by products_per_page -%}
        
        {%- if collection.products.size > 0 -%}
          <ul class="inv-col-grid__products" id="invicta-product-grid-{{ section.id }}" data-product-grid>
            {%- for product in collection.products -%}
              <li class="inv-col-grid__item">
                {% render 'invicta-product-card', product: product %}
              </li>
            {%- endfor -%}
          </ul>
          
          {%- if paginate.pages > 1 -%}
            <nav class="inv-col-grid__pagination" aria-label="Pagination">
              <ul class="inv-col-grid__pagination-list">
                {%- if paginate.previous -%}
                  <li><a href="{{ paginate.previous.url }}" class="inv-col-grid__page inv-col-grid__page--prev">← Prev</a></li>
                {%- endif -%}
                
                {%- for part in paginate.parts -%}
                  <li>
                    {%- if part.is_link -%}
                      <a href="{{ part.url }}" class="inv-col-grid__page">{{ part.title }}</a>
                    {%- elsif part.title == paginate.current_page -%}
                      <span class="inv-col-grid__page inv-col-grid__page--current">{{ part.title }}</span>
                    {%- else -%}
                      <span class="inv-col-grid__dots">{{ part.title }}</span>
                    {%- endif -%}
                  </li>
                {%- endfor -%}
                
                {%- if paginate.next -%}
                  <li><a href="{{ paginate.next.url }}" class="inv-col-grid__page inv-col-grid__page--next">Next →</a></li>
                {%- endif -%}
              </ul>
            </nav>
          {%- endif -%}
          
        {%- else -%}
          <div class="inv-col-grid__empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <p>No products found matching your filters.</p>
            <a href="{{ collection.url }}" class="inv-col-grid__empty-btn">Clear all filters</a>
          </div>
        {%- endif -%}
        
      {%- endpaginate -%}
      
    </div>
  </div>
  
</div>

<style>
  .inv-col-grid {
    padding-bottom: 48px;
  }
  
  /* Toolbar */
  .inv-col-grid__toolbar {
    padding: 12px 0;
    background: var(--inv-bg, #f5f5f5);
    border-bottom: 1px solid var(--inv-border, #e5e5e5);
  }
  
  .inv-col-grid__toolbar-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  
  .inv-col-grid__count {
    font-size: 13px;
    color: var(--inv-text-muted, #666);
    margin: 0;
  }
  
  .inv-col-grid__count strong {
    color: var(--inv-text, #1a1a1a);
    font-weight: 700;
  }
  
  .inv-col-grid__controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  /* VAT Toggle */
  .inv-col-grid__vat {
    display: flex;
    background: #fff;
    border: 1.5px solid var(--inv-border, #e5e5e5);
    border-radius: 20px;
    overflow: hidden;
  }
  
  .inv-col-grid__vat-btn {
    padding: 6px 12px;
    font-family: inherit;
    font-size: 11px;
    font-weight: 600;
    color: var(--inv-text-muted, #666);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  
  .inv-col-grid__vat-btn:hover {
    color: var(--inv-text, #1a1a1a);
  }
  
  .inv-col-grid__vat-btn--active {
    background: var(--inv-dark, #2d2d2d);
    color: #fff;
  }
  
  /* Sort */
  .inv-col-grid__sort {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .inv-col-grid__sort-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--inv-text-muted, #666);
  }
  
  .inv-col-grid__sort-wrap {
    position: relative;
  }
  
  .inv-col-grid__sort-select {
    padding: 7px 28px 7px 12px;
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
    color: var(--inv-text, #1a1a1a);
    background: #fff;
    border: 1.5px solid var(--inv-border, #e5e5e5);
    border-radius: 6px;
    appearance: none;
    cursor: pointer;
  }
  
  .inv-col-grid__sort-select:hover {
    border-color: #bbb;
  }
  
  .inv-col-grid__sort-chevron {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--inv-text-muted, #666);
  }
  
  /* Grid */
  .inv-col-grid__main {
    padding-top: 20px;
  }
  
  .inv-col-grid__products {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  .inv-col-grid__products--loading {
    opacity: 0.5;
    pointer-events: none;
  }
  
  .inv-col-grid__item {
    display: flex;
  }
  
  /* List view */
  .inv-col-grid__products--list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  /* Pagination */
  .inv-col-grid__pagination {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--inv-border, #e5e5e5);
  }
  
  .inv-col-grid__pagination-list {
    display: flex;
    justify-content: center;
    gap: 6px;
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  .inv-col-grid__page {
    display: inline-flex;
    padding: 8px 14px;
    font-size: 12px;
    font-weight: 600;
    color: var(--inv-text, #1a1a1a);
    background: #fff;
    border: 1.5px solid var(--inv-border, #e5e5e5);
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.15s ease;
  }
  
  .inv-col-grid__page:hover {
    border-color: var(--inv-dark, #2d2d2d);
  }
  
  .inv-col-grid__page--current {
    background: var(--inv-dark, #2d2d2d);
    border-color: var(--inv-dark, #2d2d2d);
    color: #fff;
  }
  
  .inv-col-grid__page--prev,
  .inv-col-grid__page--next {
    background: var(--inv-primary, #dc2626);
    border-color: var(--inv-primary, #dc2626);
    color: #fff;
  }
  
  .inv-col-grid__page--prev:hover,
  .inv-col-grid__page--next:hover {
    background: #b91c1c;
    border-color: #b91c1c;
  }
  
  .inv-col-grid__dots {
    padding: 8px 4px;
    color: var(--inv-text-muted, #666);
  }
  
  /* Empty */
  .inv-col-grid__empty {
    text-align: center;
    padding: 60px 24px;
    color: var(--inv-text-muted, #666);
  }
  
  .inv-col-grid__empty svg {
    margin-bottom: 16px;
    opacity: 0.3;
  }
  
  .inv-col-grid__empty p {
    font-size: 14px;
    margin: 0 0 20px;
  }
  
  .inv-col-grid__empty-btn {
    display: inline-flex;
    padding: 10px 20px;
    font-size: 12px;
    font-weight: 700;
    color: #fff;
    background: var(--inv-primary, #dc2626);
    border-radius: 6px;
    text-decoration: none;
    text-transform: uppercase;
  }
  
  .inv-col-grid__empty-btn:hover {
    background: #b91c1c;
  }
  
  @media (max-width: 1024px) {
    .inv-col-grid__products { grid-template-columns: repeat(3, 1fr); }
  }
  
  @media (max-width: 768px) {
    .inv-col-grid__toolbar-inner { flex-wrap: wrap; }
    .inv-col-grid__products { grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .inv-col-grid__vat-btn { padding: 5px 10px; font-size: 10px; }
    .inv-col-grid__sort-label { display: none; }
    .inv-col-grid__page { padding: 6px 10px; font-size: 11px; }
  }
  
  @media (max-width: 480px) {
    .inv-col-grid__products { gap: 10px; }
    .inv-col-grid__controls { width: 100%; justify-content: space-between; }
  }
</style>

<script>
  (function() {
    let abortController = null;
    
    function init() {
      initVatToggle();
      initSort();
      initPagination();
      initViewListener();
    }
    
    function initVatToggle() {
      const container = document.getElementById('vat-toggle-container');
      if (!container) return;
      
      const saved = localStorage.getItem('invicta-vat-mode') || 'inc';
      setVatMode(saved);
      
      container.addEventListener('click', (e) => {
        const btn = e.target.closest('.inv-col-grid__vat-btn');
        if (!btn) return;
        
        const mode = btn.dataset.vat;
        setVatMode(mode);
        localStorage.setItem('invicta-vat-mode', mode);
      });
    }
    
    function setVatMode(mode) {
      const buttons = document.querySelectorAll('.inv-col-grid__vat-btn');
      buttons.forEach(btn => {
        btn.classList.toggle('inv-col-grid__vat-btn--active', btn.dataset.vat === mode);
      });
      
      document.body.classList.remove('vat-mode-inc', 'vat-mode-ex');
      document.body.classList.add('vat-mode-' + mode);
    }
    
    function initSort() {
      const select = document.querySelector('[data-sort-select]');
      if (!select) return;
      
      select.addEventListener('change', () => {
        const url = new URL(window.location.href);
        url.searchParams.set('sort_by', select.value);
        fetchGrid(url.toString());
      });
    }
    
    function initPagination() {
      const pagination = document.querySelector('.inv-col-grid__pagination');
      if (!pagination) return;
      
      pagination.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (!link) return;
        
        e.preventDefault();
        fetchGrid(link.href);
        
        const section = document.querySelector('.inv-col-grid');
        if (section) {
          const offset = document.querySelector('.inv-col-filters')?.offsetHeight || 0;
          window.scrollTo({ top: section.offsetTop - offset - 20, behavior: 'smooth' });
        }
      });
    }
    
    function initViewListener() {
      // Listen for view change events
      document.addEventListener('invicta:view-change', (e) => {
        const grid = document.querySelector('[data-product-grid]');
        if (!grid) return;
        
        console.log('[Grid] Received view change:', e.detail.view);
        
        if (e.detail.view === 'list') {
          grid.classList.add('inv-col-grid__products--list');
        } else {
          grid.classList.remove('inv-col-grid__products--list');
        }
      });
      
      // Apply saved view on init
      const saved = localStorage.getItem('invicta-collection-view') || 'grid';
      const grid = document.querySelector('[data-product-grid]');
      if (grid && saved === 'list') {
        grid.classList.add('inv-col-grid__products--list');
      }
    }
    
    async function fetchGrid(url) {
      if (abortController) abortController.abort();
      abortController = new AbortController();
      
      const grid = document.querySelector('[data-product-grid]');
      if (grid) grid.classList.add('inv-col-grid__products--loading');
      
      try {
        const res = await fetch(url, { signal: abortController.signal, headers: { 'Accept': 'text/html' } });
        if (!res.ok) throw new Error('Network error');
        
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        
        history.pushState({}, '', url);
        
        const newMain = doc.querySelector('.inv-col-grid__main');
        const oldMain = document.querySelector('.inv-col-grid__main');
        if (newMain && oldMain) oldMain.innerHTML = newMain.innerHTML;
        
        const newCount = doc.querySelector('#grid-product-count');
        const oldCount = document.querySelector('#grid-product-count');
        if (newCount && oldCount) oldCount.innerHTML = newCount.innerHTML;
        
        // Re-apply view mode
        const saved = localStorage.getItem('invicta-collection-view') || 'grid';
        const updated = document.querySelector('[data-product-grid]');
        if (updated && saved === 'list') {
          updated.classList.add('inv-col-grid__products--list');
        }
        
        initPagination();
        
        document.dispatchEvent(new CustomEvent('invicta:grid-updated'));
        
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('Grid error:', err);
          window.location.href = url;
        }
      }
    }
    
    window.addEventListener('popstate', () => window.location.reload());
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    document.addEventListener('invicta:filters-updated', () => {
      initSort();
      initPagination();
      
      const saved = localStorage.getItem('invicta-collection-view') || 'grid';
      const grid = document.querySelector('[data-product-grid]');
      if (grid && saved === 'list') {
        grid.classList.add('inv-col-grid__products--list');
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Collection Grid",
  "tag": "section",
  "class": "section-invicta-collection-grid",
  "settings": [
    { "type": "range", "id": "products_per_page", "label": "Products per page", "min": 12, "max": 48, "step": 4, "default": 24 },
    { "type": "checkbox", "id": "show_vat_toggle", "label": "Show VAT toggle", "default": true },
    { "type": "checkbox", "id": "show_sort", "label": "Show sort dropdown", "default": true }
  ],
  "presets": [{ "name": "Collection Grid" }]
}
{% endschema %}
