{% assign s = section.settings %}
{% assign menu = linklists[s.menu] %}

<style>
/*
 * H26 Performance note: This CSS must remain inline because every selector
 * contains {{ section.id }} and most property values use Liquid settings
 * ({{ s.bar_bg }}, {{ s.bar_height }}, {{ s.accent_color }}, etc.).
 * Extracting to an external .css file is not possible without losing
 * per-section scoping and theme-editor configurability.
 */

/* Hide mega menu on mobile — use drawer instead */
@media (max-width: 989px) {
  .mega-menu-bar-{{ section.id }},
  .mega-dropdown-{{ section.id }} {
    display: none !important;
  }
}

/* ========= TOP BAR (HEADINGS) ========= */

.mega-menu-bar-{{ section.id }} {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  height: {{ s.bar_height }}px;
  background: {{ s.bar_bg }};
  border-bottom: 1px solid {{ s.bar_border }};
  position: relative;
  z-index: {{ s.z_index }};
}

/* Top-level link */
.mega-item-{{ section.id }} {
  position: relative;
  padding: 0 18px;
  height: 100%;
  display: flex;
  align-items: center;
  cursor: pointer;
  font-weight: 600;
  color: {{ s.item_color }};
}

.mega-item-{{ section.id }}:hover,
.mega-item-{{ section.id }}.active {
  background: rgba(0,0,0,0.08);
  border-bottom: 3px solid {{ s.accent_color }};
  color: {{ s.item_hover_color }};
}

/* caret arrow */
.mega-item-{{ section.id }} svg {
  margin-left: 6px;
  width: 14px;
  height: 14px;
  transition: transform .2s ease;
}

.mega-item-{{ section.id }}:hover svg,
.mega-item-{{ section.id }}.active svg {
  transform: rotate(180deg);
}

/* ========= DROPDOWN PANEL ========= */

.mega-dropdown-{{ section.id }} {
  width: 100vw;
  max-width: 100%;
  position: absolute;
  top: 100%;
  left: 0;
  background: {{ s.panel_bg }};
  border-bottom: 1px solid {{ s.panel_border }};
  box-shadow: 0 4px 18px rgba(0,0,0,0.08);
  padding: 32px 48px;
  display: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity .18s ease;
  z-index: {{ s.z_index }};
}

/* Visible */
.mega-dropdown-{{ section.id }}.open {
  display: block;
  opacity: 1;
  visibility: visible;
}

/* Balanced grid layout */
.mega-grid-{{ section.id }} {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax({{ s.column_min_width }}px, 1fr));
  gap: 40px 60px;
  width: 100%;}

/* ========= CATEGORY TITLE — NOW CLICKABLE ========= */
.mega-cat-title-{{ section.id }} {
  display: block;
  font-weight: 700;
  margin-bottom: 12px;
  padding-bottom: 6px;
  border-bottom: 2px solid {{ s.accent_color }};
  color: {{ s.cat_title_color }};
  text-decoration: none;
  transition: color 0.15s ease;
}

.mega-cat-title-{{ section.id }}:hover {
  color: {{ s.sub_hover_color }};
}

/* Sub links */
.mega-sub-item-{{ section.id }} {
  display: block;
  margin: 6px 0;
  font-size: 14px;
  color: {{ s.sub_color }};
  text-decoration: none;
}

.mega-sub-item-{{ section.id }}:hover {
  color: {{ s.sub_hover_color }};
  transform: translateX(4px);
}

/* Keyboard focus styles */
.mega-item-{{ section.id }}:focus,
.mega-item-{{ section.id }}:focus-visible {
  outline: 2px solid {{ s.accent_color }};
  outline-offset: -2px;
  background: rgba(0,0,0,0.08);
}

.mega-cat-title-{{ section.id }}:focus,
.mega-cat-title-{{ section.id }}:focus-visible,
.mega-sub-item-{{ section.id }}:focus,
.mega-sub-item-{{ section.id }}:focus-visible {
  outline: 2px solid {{ s.accent_color }};
  outline-offset: 2px;
}

</style>

<nav class="mega-menu-bar-{{ section.id }}" aria-label="Main menu">
  <ul role="menubar" style="display:contents;list-style:none;margin:0;padding:0;">
  {% for l in menu.links %}
    <li role="none" style="display:contents;">
    {% if l.links.size > 0 %}
      <div class="mega-item-{{ section.id }}"
           role="menuitem"
           aria-haspopup="true"
           aria-expanded="false"
           tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
           data-dropdown="dropdown-{{ section.id }}-{{ forloop.index }}">
        {{ l.title }}
        <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="6 9 12 15 18 9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>
      </div>
    {% else %}
      <a class="mega-item-{{ section.id }}"
         href="{{ l.url }}"
         role="menuitem"
         tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
         data-dropdown="dropdown-{{ section.id }}-{{ forloop.index }}">
        {{ l.title }}
      </a>
    {% endif %}
    </li>
  {% endfor %}
  </ul>
</nav>

{% for l in menu.links %}
  {% if l.links.size > 0 %}
  <div id="dropdown-{{ section.id }}-{{ forloop.index }}"
       class="mega-dropdown-{{ section.id }}"
       role="menu"
       aria-label="{{ l.title }}">

    <div class="mega-grid-{{ section.id }}">
      {% for child in l.links %}
        <div role="group" aria-label="{{ child.title }}">
          {%- comment -%}
            CATEGORY TITLE — Now a clickable link
            Links to the collection/page URL assigned in the menu
          {%- endcomment -%}
          <a href="{{ child.url }}" class="mega-cat-title-{{ section.id }}" role="menuitem">
            {{ child.title }}
          </a>

          {% for sub in child.links %}
            <a href="{{ sub.url }}" class="mega-sub-item-{{ section.id }}" role="menuitem">
              {{ sub.title }}
            </a>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

  </div>
  {% endif %}
{% endfor %}


<script>
document.addEventListener('DOMContentLoaded', () => {

  const menubar = document.querySelector('.mega-menu-bar-{{ section.id }} [role="menubar"]');
  if (!menubar) return;

  const items = Array.from(menubar.querySelectorAll('[role="menuitem"]'));
  const allDropdowns = document.querySelectorAll('.mega-dropdown-{{ section.id }}');

  /* ========= MOUSE BEHAVIOUR (preserved) ========= */

  items.forEach(item => {
    const id = item.dataset.dropdown;
    const panel = document.getElementById(id);

    if (!panel) return;

    item.addEventListener('mouseenter', () => {
      closeAll();
      openDropdown(item, panel, false);
    });

    item.addEventListener('mouseleave', () => {
      setTimeout(() => {
        if (!panel.matches(':hover') && !item.matches(':hover')) {
          closeDropdown(item, panel);
        }
      }, 80);
    });

    panel.addEventListener('mouseleave', () => {
      closeDropdown(item, panel);
    });
  });

  /* ========= OPEN / CLOSE HELPERS ========= */

  function openDropdown(trigger, panel, moveFocus) {
    closeAll();
    trigger.classList.add('active');
    trigger.setAttribute('aria-expanded', 'true');
    panel.classList.add('open');

    if (moveFocus) {
      const firstLink = panel.querySelector('a[role="menuitem"]');
      if (firstLink) firstLink.focus();
    }
  }

  function closeDropdown(trigger, panel) {
    trigger.classList.remove('active');
    trigger.setAttribute('aria-expanded', 'false');
    panel.classList.remove('open');
  }

  function closeAll(returnFocusTo) {
    items.forEach(x => {
      x.classList.remove('active');
      if (x.hasAttribute('aria-expanded')) {
        x.setAttribute('aria-expanded', 'false');
      }
    });
    allDropdowns.forEach(x => x.classList.remove('open'));
    if (returnFocusTo) returnFocusTo.focus();
  }

  /* ========= MENUBAR KEYBOARD NAVIGATION ========= */

  function focusMenuItem(index) {
    items.forEach((el, i) => el.setAttribute('tabindex', i === index ? '0' : '-1'));
    items[index].focus();
  }

  items.forEach((item, idx) => {
    item.addEventListener('keydown', (e) => {
      const id = item.dataset.dropdown;
      const panel = id ? document.getElementById(id) : null;
      const hasPopup = item.getAttribute('aria-haspopup') === 'true';

      switch (e.key) {
        case 'ArrowRight': {
          e.preventDefault();
          const next = (idx + 1) % items.length;
          closeAll();
          focusMenuItem(next);
          break;
        }
        case 'ArrowLeft': {
          e.preventDefault();
          const prev = (idx - 1 + items.length) % items.length;
          closeAll();
          focusMenuItem(prev);
          break;
        }
        case 'ArrowDown': {
          e.preventDefault();
          if (hasPopup && panel) {
            openDropdown(item, panel, true);
          }
          break;
        }
        case 'Enter':
        case ' ': {
          if (hasPopup && panel) {
            e.preventDefault();
            const isOpen = item.getAttribute('aria-expanded') === 'true';
            if (isOpen) {
              closeDropdown(item, panel);
            } else {
              openDropdown(item, panel, true);
            }
          }
          /* For plain links, let the default action (navigation) happen */
          break;
        }
        case 'Escape': {
          e.preventDefault();
          closeAll();
          focusMenuItem(idx);
          break;
        }
        case 'Home': {
          e.preventDefault();
          closeAll();
          focusMenuItem(0);
          break;
        }
        case 'End': {
          e.preventDefault();
          closeAll();
          focusMenuItem(items.length - 1);
          break;
        }
      }
    });
  });

  /* ========= DROPDOWN KEYBOARD NAVIGATION ========= */

  allDropdowns.forEach(panel => {
    const panelLinks = Array.from(panel.querySelectorAll('a[role="menuitem"]'));
    const triggerItem = items.find(i => i.dataset.dropdown === panel.id);

    panel.addEventListener('keydown', (e) => {
      const currentIndex = panelLinks.indexOf(document.activeElement);

      switch (e.key) {
        case 'ArrowDown': {
          e.preventDefault();
          const next = currentIndex < panelLinks.length - 1 ? currentIndex + 1 : 0;
          panelLinks[next].focus();
          break;
        }
        case 'ArrowUp': {
          e.preventDefault();
          if (currentIndex <= 0) {
            /* Move focus back to the trigger */
            if (triggerItem) {
              closeDropdown(triggerItem, panel);
              triggerItem.focus();
            }
          } else {
            panelLinks[currentIndex - 1].focus();
          }
          break;
        }
        case 'Escape': {
          e.preventDefault();
          if (triggerItem) {
            closeDropdown(triggerItem, panel);
            triggerItem.focus();
          }
          break;
        }
        case 'Tab': {
          /* Close dropdown when tabbing out */
          if (triggerItem) {
            closeDropdown(triggerItem, panel);
          }
          break;
        }
        case 'Home': {
          e.preventDefault();
          if (panelLinks.length) panelLinks[0].focus();
          break;
        }
        case 'End': {
          e.preventDefault();
          if (panelLinks.length) panelLinks[panelLinks.length - 1].focus();
          break;
        }
      }
    });
  });

  /* ========= CLOSE ON OUTSIDE CLICK ========= */

  document.addEventListener('click', (e) => {
    const inMenu = e.target.closest('.mega-menu-bar-{{ section.id }}');
    const inDropdown = e.target.closest('.mega-dropdown-{{ section.id }}');
    if (!inMenu && !inDropdown) {
      closeAll();
    }
  });

});
</script>


{% schema %}
{
  "name": "Mega menu 2",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu source"
    },
    {
      "type": "color",
      "id": "bar_bg",
      "label": "Bar background",
      "default": "#e42d27"
    },
    {
      "type": "color",
      "id": "bar_border",
      "label": "Bar border",
      "default": "#d5d5d5"
    },
    {
      "type": "color",
      "id": "item_color",
      "label": "Top link color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "item_hover_color",
      "label": "Top link hover color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent line",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "bar_height",
      "label": "Top bar height",
      "min": 40,
      "max": 100,
      "step": 5,
      "default": 60
    },
    {
      "type": "color",
      "id": "panel_bg",
      "label": "Dropdown background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "panel_border",
      "label": "Dropdown border",
      "default": "#e0e0e0"
    },
    {
      "type": "color",
      "id": "cat_title_color",
      "label": "Category title",
      "default": "#222222"
    },
    {
      "type": "color",
      "id": "sub_color",
      "label": "Sub link color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "sub_hover_color",
      "label": "Sub link hover",
      "default": "#e42d27"
    },
    {
      "type": "range",
      "id": "column_min_width",
      "label": "Minimum column width",
      "min": 160,
      "max": 300,
      "step": 10,
      "default": 220
    },
    {
      "type": "range",
      "id": "z_index",
      "label": "Z-index (layer order)",
      "min": 100,
      "max": 2000,
      "step": 100,
      "default": 1500
    }
  ],
  "presets": [
    {
      "name": "Mega menu 2"
    }
  ]
}
{% endschema %}