{% comment %}
  ============================================================================
  INVICTA PRODUCT GRID v3.0
  ============================================================================
  AJAX-powered product grid for collection pages.
  
  Features:
  ✓ AJAX sort (no page reload)
  ✓ AJAX pagination (smooth transitions)
  ✓ Correct product count (total filtered, not page count)
  ✓ Skeleton shimmer loading state
  ✓ Works seamlessly with Invicta Filters v4.0
  ✓ Full keyboard accessibility
  ✓ Reduced motion support
  
  Requirements:
  - Pair with invicta-collection-filters.liquid for AJAX filtering
  - Uses invicta-product-card.liquid snippet
  
  Trade 15.4.0 Compatible
  Version: 3.0.0
  ============================================================================
{% endcomment %}

{%- liquid
  # ----------------------------------------
  # SETTINGS
  # ----------------------------------------
  assign products_per_page = section.settings.products_per_page
  assign show_sort = section.settings.show_sort
  assign empty_message = section.settings.empty_message
  
  # Grid columns
  assign cols_desktop = section.settings.columns_desktop
  assign cols_tablet = section.settings.columns_tablet
  assign cols_mobile = section.settings.columns_mobile
  assign grid_gap = section.settings.grid_gap
  
  # Spacing
  assign padding_top = section.settings.padding_top
  assign padding_bottom = section.settings.padding_bottom
  assign padding_top_mobile = padding_top | times: 0.6 | round
  assign padding_bottom_mobile = padding_bottom | times: 0.6 | round
  
  # Card settings
  assign card_radius = section.settings.card_radius
  assign card_padding = section.settings.card_padding
  assign image_ratio = section.settings.image_ratio
  
  # Colours - Section
  assign section_bg = section.settings.section_bg
  
  # Colours - Cards
  assign card_bg = section.settings.card_bg
  assign card_border = section.settings.card_border
  assign image_bg = section.settings.image_bg
  
  # Colours - Badge
  assign badge_bg = section.settings.badge_bg
  assign badge_text = section.settings.badge_text
  
  # Colours - Text
  assign title_color = section.settings.title_color
  assign price_color = section.settings.price_color
  
  # Colours - Buttons
  assign btn_primary_bg = section.settings.btn_primary_bg
  assign btn_primary_text = section.settings.btn_primary_text
  assign btn_secondary_bg = section.settings.btn_secondary_bg
  assign btn_secondary_text = section.settings.btn_secondary_text
  assign btn_secondary_border = section.settings.btn_secondary_border
  
  # ----------------------------------------
  # FULL CATALOGUE LINK (Auto-detect stocked filter)
  # ----------------------------------------
  # If ?filter.p.m.custom.stocked=true is active, show "See all" link
  # Note: JS syncs this on page load, Liquid just provides initial state
  assign full_catalogue_count = collection.all_products_count
  
  # ----------------------------------------
  # DETECT ACTIVE FILTERS
  # ----------------------------------------
  # Check if any filters are active (for empty state)
  assign has_active_filters = false
  
  for filter in collection.filters
    if filter.active_values.size > 0
      assign has_active_filters = true
      break
    endif
  endfor
  
  # Also check legacy tags
  if current_tags.size > 0
    assign has_active_filters = true
  endif
-%}

{%- comment -%} 
  ============================================================================
  MAIN SECTION WRAPPER
  ============================================================================
  ID "invicta-product-grid" is required for AJAX compatibility with filters.
  CSS custom properties passed via inline style for theme editor reactivity.
{%- endcomment -%}

{% render 'invicta-section-header', title: collection.title, description: collection.description, breadcrumbs: true %}

<div 
  id="invicta-product-grid"
  class="inv-grid"
  data-section-id="{{ section.id }}"
  data-section-type="invicta-product-grid"
  data-collection-url="{{ collection.url }}"
  style="
    --inv-grid-columns: {{ cols_desktop }};
    --inv-grid-columns-tablet: {{ cols_tablet }};
    --inv-grid-columns-mobile: {{ cols_mobile }};
    --inv-grid-gap: {{ grid_gap }}px;
    --inv-padding-top: {{ padding_top }}px;
    --inv-padding-bottom: {{ padding_bottom }}px;
    --inv-padding-top-mobile: {{ padding_top_mobile }}px;
    --inv-padding-bottom-mobile: {{ padding_bottom_mobile }}px;
    --inv-section-bg: {{ section_bg }};
    --inv-card-bg: {{ card_bg }};
    --inv-card-border: {{ card_border }};
    --inv-card-radius: {{ card_radius }}px;
    --inv-card-padding: {{ card_padding }}px;
    --inv-image-bg: {{ image_bg }};
    --inv-image-ratio: {{ image_ratio }}%;
    --inv-badge-bg: {{ badge_bg }};
    --inv-badge-text: {{ badge_text }};
    --inv-title-color: {{ title_color }};
    --inv-price-color: {{ price_color }};
    --inv-btn-primary-bg: {{ btn_primary_bg }};
    --inv-btn-primary-text: {{ btn_primary_text }};
    --inv-btn-secondary-bg: {{ btn_secondary_bg }};
    --inv-btn-secondary-text: {{ btn_secondary_text }};
    --inv-btn-secondary-border: {{ btn_secondary_border }};
  "
>
  <div class="inv-grid__container page-width">
    
    {%- comment -%} 
      ========================================
      PAGINATE WRAPPER
      ========================================
      Everything inside here has access to paginate object.
    {%- endcomment -%}
    
    {%- paginate collection.products by products_per_page -%}
    
      {%- comment -%} Toolbar row {%- endcomment -%}
      <div class="inv-grid__toolbar">
        <div class="inv-grid__toolbar-left">
          {%- comment -%} 
            Product count - shows total filtered, with range indicator
            collection.products.size = total matching filters
            paginate.items.size = items on this page
          {%- endcomment -%}
          <p 
            class="inv-grid__count" 
            id="inv-product-count"
            aria-live="polite"
            aria-atomic="true"
          >
            {%- if collection.products.size == 0 -%}
              <strong>0</strong> products
            {%- elsif paginate.pages > 1 -%}
              <strong>{{ collection.products.size }}</strong> 
              {{ collection.products.size | pluralize: 'product', 'products' }}
              <span class="inv-grid__count-range">
                (showing {{ paginate.current_offset | plus: 1 }}–{{ paginate.current_offset | plus: paginate.items.size }})
              </span>
            {%- else -%}
              <strong>{{ collection.products.size }}</strong> 
              {{ collection.products.size | pluralize: 'product', 'products' }}
            {%- endif -%}
          </p>
        </div>
        
        {%- comment -%} Full catalogue link - JS controls visibility based on URL {%- endcomment -%}
        <div class="inv-grid__toolbar-center" id="inv-full-catalogue-link" style="display: none;">
          <a 
            href="{{ collection.url }}" 
            class="inv-grid__full-link"
          >
            See all {{ full_catalogue_count }} products
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M5 12h14"/>
              <path d="m12 5 7 7-7 7"/>
            </svg>
          </a>
        </div>
        
        {%- if show_sort -%}
          <div class="inv-grid__toolbar-right">
            <div class="inv-grid__sort">
              <label for="inv-sort-select" class="inv-grid__sort-label">
                Sort:
              </label>
              <select 
                id="inv-sort-select" 
                class="inv-grid__sort-select" 
                data-inv-sort-select
                aria-describedby="inv-product-count"
              >
                {%- for option in collection.sort_options -%}
                  <option 
                    value="{{ option.value }}"
                    {% if collection.sort_by == option.value %}selected{% endif %}
                  >
                    {{ option.name }}
                  </option>
                {%- endfor -%}
              </select>
            </div>
          </div>
        {%- endif -%}
      </div>
      
      {%- comment -%} 
        ========================================
        PRODUCT GRID
        ========================================
        Semantic list structure for accessibility.
      {%- endcomment -%}
      
      <ul 
        class="inv-grid__products" 
        id="inv-product-list"
        role="list"
        aria-label="Products in {{ collection.title }}"
      >
        {%- for product in collection.products -%}
          <li class="inv-grid__item">
            {%- render 'invicta-product-card', 
                product: product, 
                section_settings: section.settings,
                card_index: forloop.index
            -%}
          </li>
        {%- else -%}
          {%- comment -%} Empty state {%- endcomment -%}
          <li class="inv-grid__empty" role="status">
            <div class="inv-grid__empty-inner">
              <svg class="inv-grid__empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <p class="inv-grid__empty-message">{{ empty_message }}</p>
              
              {%- comment -%} Show clear filters if filters are active {%- endcomment -%}
              {%- if has_active_filters -%}
                <a 
                  href="{{ collection.url }}" 
                  class="inv-grid__empty-link"
                  data-inv-clear-filters
                >
                  Clear all filters
                </a>
              {%- endif -%}
            </div>
          </li>
        {%- endfor -%}
      </ul>
      
      {%- comment -%} 
        ========================================
        PAGINATION
        ========================================
        AJAX-enabled pagination with data attributes.
      {%- endcomment -%}
      
      {%- if paginate.pages > 1 -%}
        <nav 
          class="inv-grid__pagination" 
          aria-label="Collection pagination"
          data-inv-pagination
        >
          <div class="inv-pagination">
            
            {%- comment -%} Previous button {%- endcomment -%}
            {%- if paginate.previous -%}
              <a 
                href="{{ paginate.previous.url }}" 
                class="inv-pagination__btn inv-pagination__btn--prev"
                aria-label="Go to previous page"
                data-inv-page-link
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="15 18 9 12 15 6"/>
                </svg>
                <span>Prev</span>
              </a>
            {%- else -%}
              <span class="inv-pagination__btn inv-pagination__btn--prev inv-pagination__btn--disabled" aria-disabled="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="15 18 9 12 15 6"/>
                </svg>
                <span>Prev</span>
              </span>
            {%- endif -%}
            
            {%- comment -%} Page numbers {%- endcomment -%}
            <div class="inv-pagination__pages" role="list">
              {%- for part in paginate.parts -%}
                {%- if part.is_link -%}
                  <a 
                    href="{{ part.url }}" 
                    class="inv-pagination__page"
                    aria-label="Go to page {{ part.title }}"
                    role="listitem"
                    data-inv-page-link
                  >
                    {{ part.title }}
                  </a>
                {%- else -%}
                  {%- if part.title == paginate.current_page -%}
                    <span 
                      class="inv-pagination__page inv-pagination__page--current" 
                      aria-current="page"
                      aria-label="Page {{ part.title }}, current page"
                      role="listitem"
                    >
                      {{ part.title }}
                    </span>
                  {%- else -%}
                    <span 
                      class="inv-pagination__page inv-pagination__page--gap" 
                      aria-hidden="true"
                      role="listitem"
                    >
                      {{ part.title }}
                    </span>
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            </div>
            
            {%- comment -%} Next button {%- endcomment -%}
            {%- if paginate.next -%}
              <a 
                href="{{ paginate.next.url }}" 
                class="inv-pagination__btn inv-pagination__btn--next"
                aria-label="Go to next page"
                data-inv-page-link
              >
                <span>Next</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </a>
            {%- else -%}
              <span class="inv-pagination__btn inv-pagination__btn--next inv-pagination__btn--disabled" aria-disabled="true">
                <span>Next</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </span>
            {%- endif -%}
            
          </div>
        </nav>
      {%- endif -%}
    
    {%- endpaginate -%}
    
  </div>
  
  {%- comment -%} Screen reader announcements {%- endcomment -%}
  <div class="inv-grid__sr-announce visually-hidden" aria-live="assertive" aria-atomic="true" id="inv-grid-announce"></div>
  
</div>

{%- comment -%} Trust bar below product grid {%- endcomment -%}
{% render 'invicta-trust-bar', style: 'full' %}

{%- comment -%} Collection bottom CTA banner {%- endcomment -%}
{%- if section.settings.show_cta_banner -%}
  {%- liquid
    assign cta_heading = section.settings.cta_heading | default: 'Need Help Choosing?'
    assign cta_subtext = section.settings.cta_text | default: 'Our team of experts are here to help. Call us or visit one of our Kent branches.'
    assign cta_btn_text = section.settings.cta_button_text | default: 'Contact Us'
    assign cta_btn_url = section.settings.cta_button_url | default: '/pages/contact-us'
    assign cta_theme = 'dark'
  -%}
  {% render 'invicta-cta-banner', heading: cta_heading, subtext: cta_subtext, button_text: cta_btn_text, button_url: cta_btn_url, theme: cta_theme %}
{%- endif -%}

<style>
  /* ============================================
     INVICTA PRODUCT GRID v3.0 - STYLES
     ============================================
     Trade 15.4.0 Compatible
     All custom properties defined inline on .inv-grid
     ============================================ */
  
  /* ----------------------------------------
     BASE SECTION
     ---------------------------------------- */
  
  .inv-grid {
    padding-top: var(--inv-padding-top);
    padding-bottom: var(--inv-padding-bottom);
    background-color: var(--inv-section-bg);
  }
  
  .inv-grid__container {
    /* page-width class handles max-width from Trade */
  }
  
  /* ----------------------------------------
     TOOLBAR
     ---------------------------------------- */
  
  .inv-grid__toolbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 12px 24px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--inv-card-border);
  }
  
  .inv-grid__toolbar-left,
  .inv-grid__toolbar-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  /* Toolbar center - full catalogue link */
  .inv-grid__toolbar-center {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    min-width: 0;
  }
  
  .inv-grid__full-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--inv-btn-primary-bg, #2d2d2d);
    text-decoration: none;
    background: rgba(45, 45, 45, 0.06);
    border-radius: 6px;
    transition: background-color 0.15s ease, color 0.15s ease;
  }
  
  .inv-grid__full-link:hover {
    background: var(--inv-btn-primary-bg, #2d2d2d);
    color: #fff;
  }
  
  .inv-grid__full-link svg {
    flex-shrink: 0;
    transition: transform 0.15s ease;
  }
  
  .inv-grid__full-link:hover svg {
    transform: translateX(3px);
  }
  
  /* Product count */
  .inv-grid__count {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--inv-title-color);
  }
  
  .inv-grid__count strong {
    font-weight: 700;
  }
  
  .inv-grid__count-range {
    color: #666;
    font-weight: 400;
    font-size: 0.8125rem;
  }
  
  /* Sort dropdown */
  .inv-grid__sort {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .inv-grid__sort-label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--inv-title-color);
  }
  
  .inv-grid__sort-select {
    min-height: 44px;
    padding: 8px 36px 8px 12px;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--inv-title-color);
    background-color: #fff;
    border: 1px solid var(--inv-card-border);
    border-radius: 6px;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    transition: border-color 0.15s ease;
  }
  
  .inv-grid__sort-select:hover {
    border-color: #999;
  }
  
  .inv-grid__sort-select:focus {
    outline: none;
    border-color: var(--inv-btn-primary-bg);
    box-shadow: 0 0 0 3px rgba(26, 26, 46, 0.1);
  }
  
  /* ----------------------------------------
     PRODUCT GRID
     ---------------------------------------- */
  
  .inv-grid__products {
    display: grid;
    grid-template-columns: repeat(var(--inv-grid-columns), 1fr);
    gap: var(--inv-grid-gap);
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  .inv-grid__item {
    display: flex;
  }

  /* ----------------------------------------
     PRODUCT CARD HOVER EFFECTS (Phase 2)
     ---------------------------------------- */
  .inv-grid__item .inv-card {
    transition: transform var(--inv-duration-moderate, 200ms) var(--inv-ease-out, ease-out),
                box-shadow var(--inv-duration-moderate, 200ms) var(--inv-ease-out, ease-out);
  }
  .inv-grid__item .inv-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--inv-shadow-elevated, 0 4px 12px rgba(0, 0, 0, 0.1));
  }
  .inv-grid__item .inv-card:hover .inv-card__img {
    transform: scale(1.03);
  }
  .inv-grid__item .inv-card .inv-card__img {
    transition: transform var(--inv-duration-slow, 300ms) var(--inv-ease-out, ease-out);
  }
  
  /* ----------------------------------------
     LOADING STATE (Shimmer)
     ---------------------------------------- */
  
  .inv-grid--loading {
    pointer-events: none;
  }
  
  .inv-grid--loading .inv-grid__toolbar {
    opacity: 0.5;
  }
  
  .inv-grid--loading .inv-card {
    position: relative;
    overflow: hidden;
  }
  
  .inv-grid--loading .inv-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.6) 50%,
      rgba(255, 255, 255, 0) 100%
    );
    background-size: 200% 100%;
    animation: inv-shimmer 1.2s ease-in-out infinite;
    pointer-events: none;
    z-index: 10;
  }
  
  .inv-grid--loading .inv-card > * {
    opacity: 0.4;
  }
  
  .inv-grid--loading .inv-pagination {
    opacity: 0.5;
  }
  
  @keyframes inv-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  
  /* ----------------------------------------
     EMPTY STATE
     ---------------------------------------- */
  
  .inv-grid__empty {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    padding: 60px 20px;
  }
  
  .inv-grid__empty-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    max-width: 320px;
  }
  
  .inv-grid__empty-icon {
    color: #999;
    margin-bottom: 16px;
  }
  
  .inv-grid__empty-message {
    margin: 0 0 16px;
    font-size: 0.9375rem;
    color: #666;
    line-height: 1.5;
  }
  
  .inv-grid__empty-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--inv-btn-primary-text);
    background-color: var(--inv-btn-primary-bg);
    border-radius: 6px;
    text-decoration: none;
    transition: opacity 0.15s ease;
  }
  
  .inv-grid__empty-link:hover {
    opacity: 0.9;
  }
  
  .inv-grid__empty-link:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(26, 26, 46, 0.2);
  }
  
  /* ----------------------------------------
     PAGINATION
     ---------------------------------------- */
  
  .inv-grid__pagination {
    margin-top: 48px;
    display: flex;
    justify-content: center;
  }
  
  .inv-pagination {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Prev/Next buttons */
  .inv-pagination__btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--inv-btn-secondary-text);
    background-color: var(--inv-btn-secondary-bg);
    border: 1px solid var(--inv-btn-secondary-border);
    border-radius: 6px;
    text-decoration: none;
    transition: border-color 0.15s ease, background-color 0.15s ease;
  }
  
  .inv-pagination__btn:hover:not(.inv-pagination__btn--disabled) {
    border-color: var(--inv-btn-primary-bg);
    background-color: #f8f8f8;
  }
  
  .inv-pagination__btn:focus {
    outline: none;
    border-color: var(--inv-btn-primary-bg);
    box-shadow: 0 0 0 3px rgba(26, 26, 46, 0.1);
  }
  
  .inv-pagination__btn--disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  /* Page numbers container */
  .inv-pagination__pages {
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 0 8px;
    padding: 0;
    list-style: none;
  }
  
  /* Individual page links */
  .inv-pagination__page {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 12px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--inv-btn-secondary-text);
    background-color: #fff;
    border: 1px solid var(--inv-btn-secondary-border);
    border-radius: 6px;
    text-decoration: none;
    transition: border-color 0.15s ease, background-color 0.15s ease;
  }
  
  .inv-pagination__page:hover:not(.inv-pagination__page--current):not(.inv-pagination__page--gap) {
    border-color: var(--inv-btn-primary-bg);
    background-color: #f8f8f8;
  }
  
  .inv-pagination__page:focus {
    outline: none;
    border-color: var(--inv-btn-primary-bg);
    box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
  }
  
  .inv-pagination__page--current {
    background-color: var(--inv-btn-primary-bg);
    border-color: var(--inv-btn-primary-bg);
    color: var(--inv-btn-primary-text);
    font-weight: 700;
  }
  
  .inv-pagination__page--gap {
    border: none;
    background: none;
    min-width: auto;
    padding: 0 4px;
    cursor: default;
  }
  
  /* ----------------------------------------
     RESPONSIVE - TABLET (990px and below)
     ---------------------------------------- */
  
  @media screen and (max-width: 989px) {
    .inv-grid__products {
      grid-template-columns: repeat(var(--inv-grid-columns-tablet), 1fr);
      gap: calc(var(--inv-grid-gap) * 0.8);
    }
    
    /* Hide page numbers on tablet - keep prev/next */
    .inv-pagination__pages {
      display: none;
    }
  }
  
  /* ----------------------------------------
     RESPONSIVE - MOBILE (750px and below)
     ---------------------------------------- */
  
  @media screen and (max-width: 749px) {
    .inv-grid {
      padding-top: var(--inv-padding-top-mobile);
      padding-bottom: var(--inv-padding-bottom-mobile);
    }
    
    .inv-grid__toolbar {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }
    
    .inv-grid__toolbar-left,
    .inv-grid__toolbar-right {
      justify-content: space-between;
    }
    
    /* Full catalogue link - full width on mobile, stays in middle */
    .inv-grid__toolbar-center {
      width: 100%;
    }
    
    .inv-grid__full-link {
      width: 100%;
      justify-content: center;
      padding: 10px 16px;
      font-size: 0.875rem;
    }
    
    .inv-grid__sort {
      flex: 1;
    }
    
    .inv-grid__sort-select {
      flex: 1;
    }
    
    .inv-grid__products {
      grid-template-columns: repeat(var(--inv-grid-columns-mobile), 1fr);
      gap: calc(var(--inv-grid-gap) * 0.6);
    }
    
    .inv-grid__pagination {
      margin-top: 32px;
    }
    
    .inv-pagination__btn {
      padding: 10px 14px;
      font-size: 0.75rem;
    }
  }
  
  /* ----------------------------------------
     REDUCED MOTION
     ---------------------------------------- */
  
  @media (prefers-reduced-motion: reduce) {
    .inv-grid__sort-select,
    .inv-pagination__btn,
    .inv-pagination__page,
    .inv-grid__empty-link {
      transition: none;
    }
    
    .inv-grid--loading .inv-card::after {
      animation: none;
      opacity: 0.3;
    }
  }
  
  /* ----------------------------------------
     VISUALLY HIDDEN (accessibility)
     ---------------------------------------- */
  
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }
</style>

<script>
(function() {
  'use strict';
  
  /**
   * Invicta Product Grid v3.0
   * 
   * AJAX-powered grid with:
   * - Sort dropdown (AJAX, no reload)
   * - Pagination (AJAX, no reload)
   * - Shimmer loading state
   * - Works with Invicta Filters
   * 
   * @class InvictaGrid
   */
  class InvictaGrid {
    
    /**
     * @param {HTMLElement} container - The grid container
     */
    constructor(container) {
      /** @type {HTMLElement} */
      this.container = container;
      
      /** @type {string} */
      this.sectionId = container.dataset.sectionId;
      
      /** @type {string} */
      this.collectionUrl = container.dataset.collectionUrl || window.location.pathname;
      
      /** @type {AbortController|null} */
      this.abortController = null;
      
      /** @type {number|null} */
      this.debounceTimer = null;
      
      /** @type {number} */
      this.debounceDelay = 100;
      
      this.init();
    }
    
    /**
     * Initialise event listeners
     * @returns {void}
     */
    init() {
      // Sort dropdown
      this.container.addEventListener('change', this.handleChange.bind(this));
      
      // Pagination links
      this.container.addEventListener('click', this.handleClick.bind(this));
      
      // Browser back/forward
      window.addEventListener('popstate', this.handlePopState.bind(this));
    }
    
    /**
     * Handle change events (sort dropdown)
     * @param {Event} e
     * @returns {void}
     */
    handleChange(e) {
      const sortSelect = e.target.closest('[data-inv-sort-select]');
      if (sortSelect) {
        e.preventDefault();
        this.handleSortChange(sortSelect.value);
      }
    }
    
    /**
     * Handle click events (pagination)
     * @param {MouseEvent} e
     * @returns {void}
     */
    handleClick(e) {
      // Pagination link
      const pageLink = e.target.closest('[data-inv-page-link]');
      if (pageLink) {
        e.preventDefault();
        this.handlePageClick(pageLink.href);
        return;
      }
      
      // Clear filters (from empty state)
      const clearFilters = e.target.closest('[data-inv-clear-filters]');
      if (clearFilters) {
        e.preventDefault();
        this.handleClearFilters(clearFilters.href);
        return;
      }
    }
    
    /**
     * Handle sort dropdown change
     * @param {string} sortValue
     * @returns {void}
     */
    handleSortChange(sortValue) {
      if (!sortValue) return;
      
      const url = new URL(window.location.href);
      url.searchParams.set('sort_by', sortValue);
      url.searchParams.delete('page'); // Reset to page 1
      
      this.fetchAndUpdate(url.toString());
    }
    
    /**
     * Handle pagination click
     * @param {string} href
     * @returns {void}
     */
    handlePageClick(href) {
      this.fetchAndUpdate(href);
      
      // Scroll to top of grid
      this.scrollToGrid();
    }
    
    /**
     * Handle clear filters
     * @param {string} href
     * @returns {void}
     */
    handleClearFilters(href) {
      // Also need to update filters section
      this.fetchAndUpdate(href, true);
    }
    
    /**
     * Fetch content and update DOM
     * @param {string} url
     * @param {boolean} [updateFilters=false]
     * @returns {Promise<void>}
     */
    async fetchAndUpdate(url, updateFilters = false) {
      // Cancel any in-flight request
      if (this.abortController) {
        this.abortController.abort();
      }
      
      this.abortController = new AbortController();
      
      // Show loading state
      this.setLoadingState(true);
      
      try {
        // Build sections to fetch
        let sections = 'invicta-product-grid';
        if (updateFilters) {
          // Get filter section ID from the page
          const filterSection = document.getElementById('invicta-collection-filters');
          if (filterSection) {
            const filterSectionId = filterSection.dataset.sectionId;
            if (filterSectionId) {
              sections += `,${filterSectionId}`;
            }
          }
        }
        
        const fetchUrl = `${url}${url.includes('?') ? '&' : '?'}sections=${sections}`;
        
        const response = await fetch(fetchUrl, {
          signal: this.abortController.signal
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update URL without reload
        history.pushState({}, '', url);
        
        // Update grid section
        if (data['invicta-product-grid']) {
          this.updateSection(this.container, data['invicta-product-grid']);
        }
        
        // Update filters section if needed
        if (updateFilters) {
          const filterSection = document.getElementById('invicta-collection-filters');
          if (filterSection) {
            const filterSectionId = filterSection.dataset.sectionId;
            if (data[filterSectionId]) {
              this.updateSection(filterSection, data[filterSectionId]);
            }
          }
        }
        
        // Announce to screen readers
        this.announceUpdate();
        
      } catch (err) {
        if (err.name === 'AbortError') {
          return; // Request was cancelled
        }
        
        console.error('[Invicta Grid] Fetch error:', err);
        
        // Fallback to full page reload
        window.location.href = url;
        
      } finally {
        this.setLoadingState(false);
        this.abortController = null;
      }
    }
    
    /**
     * Update a section with new HTML
     * @param {HTMLElement} container
     * @param {string} html
     * @returns {void}
     */
    updateSection(container, html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newContent = doc.body.firstElementChild;
      
      if (newContent) {
        container.replaceWith(newContent);
        
        // Re-init if this is our container
        if (container === this.container) {
          const newContainer = document.getElementById('invicta-product-grid');
          if (newContainer) {
            this.container = newContainer;
            this.init();
          }
        }
      }
    }
    
    /**
     * Set loading state
     * @param {boolean} loading
     * @returns {void}
     */
    setLoadingState(loading) {
      this.container.classList.toggle('inv-grid--loading', loading);
    }
    
    /**
     * Scroll to top of grid
     * @returns {void}
     */
    scrollToGrid() {
      const offset = 100; // Account for fixed headers
      const top = this.container.getBoundingClientRect().top + window.scrollY - offset;
      
      window.scrollTo({
        top: top,
        behavior: 'smooth'
      });
    }
    
    /**
     * Announce update to screen readers
     * @returns {void}
     */
    announceUpdate() {
      const announce = document.getElementById('inv-grid-announce');
      if (!announce) return;
      
      const countEl = this.container.querySelector('.inv-grid__count strong');
      const count = countEl ? countEl.textContent : '0';
      
      announce.textContent = `Products updated. ${count} products found.`;
      
      setTimeout(() => {
        announce.textContent = '';
      }, 1000);
    }
    
    /**
     * Handle browser back/forward
     * @returns {void}
     */
    handlePopState() {
      this.fetchAndUpdate(window.location.href, true);
    }
  }
  
  /**
   * Initialise when DOM is ready
   */
  function init() {
    const container = document.getElementById('invicta-product-grid');
    if (container) {
      new InvictaGrid(container);
    }
    
    // Show/hide "See all" link based on URL
    const fullCatalogueLink = document.getElementById('inv-full-catalogue-link');
    if (fullCatalogueLink) {
      const urlHasStocked = window.location.href.includes('stocked=true');
      fullCatalogueLink.style.display = urlHasStocked ? '' : 'none';
    }
  }
  
  // Also update on URL change (for AJAX navigation)
  window.addEventListener('popstate', () => {
    const fullCatalogueLink = document.getElementById('inv-full-catalogue-link');
    if (fullCatalogueLink) {
      const urlHasStocked = window.location.href.includes('stocked=true');
      fullCatalogueLink.style.display = urlHasStocked ? '' : 'none';
    }
  });
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
})();
</script>

{% schema %}
{
  "name": "Invicta Product Grid",
  "tag": "section",
  "class": "inv-product-grid-section",
  "limit": 1,
  "enabled_on": {
    "templates": ["collection"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Grid Layout"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns (desktop)",
      "info": "Number of products per row on large screens",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_tablet",
      "label": "Columns (tablet)",
      "info": "Number of products per row on medium screens",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "info": "Number of products per row on small screens",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Gap between cards",
      "min": 12,
      "max": 32,
      "step": 4,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "info": "How many products to show before pagination",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24
    },
    {
      "type": "header",
      "content": "Toolbar"
    },
    {
      "type": "checkbox",
      "id": "show_sort",
      "label": "Show sort dropdown",
      "default": true
    },
    {
      "type": "text",
      "id": "empty_message",
      "label": "Empty collection message",
      "default": "No products found. Try adjusting your filters."
    },
    {
      "type": "header",
      "content": "CTA Banner"
    },
    {
      "type": "checkbox",
      "id": "show_cta_banner",
      "label": "Show CTA banner below grid",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_heading",
      "label": "CTA heading",
      "default": "Need Help Choosing?"
    },
    {
      "type": "textarea",
      "id": "cta_text",
      "label": "CTA text",
      "default": "Our team of experts are here to help. Call us or visit one of our Kent branches."
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "CTA button text",
      "default": "Contact Us"
    },
    {
      "type": "url",
      "id": "cta_button_url",
      "label": "CTA button link",
      "default": "/pages/contact-us"
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 60,
      "step": 4,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 20,
      "max": 80,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Card Settings"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "Card corner radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_padding",
      "label": "Card body padding",
      "min": 12,
      "max": 24,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "image_ratio",
      "label": "Image aspect ratio",
      "info": "100% = square, 80% = landscape, 120% = portrait",
      "min": 80,
      "max": 120,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Colours — Section"
    },
    {
      "type": "color",
      "id": "section_bg",
      "label": "Section background",
      "default": "#f5f5f5"
    },
    {
      "type": "header",
      "content": "Colours — Cards"
    },
    {
      "type": "color",
      "id": "card_bg",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border",
      "label": "Card border",
      "default": "#e5e5e5"
    },
    {
      "type": "color",
      "id": "image_bg",
      "label": "Image placeholder background",
      "default": "#f8f8f8"
    },
    {
      "type": "header",
      "content": "Colours — Badge"
    },
    {
      "type": "color",
      "id": "badge_bg",
      "label": "Brand badge background",
      "default": "#2d2d2d"
    },
    {
      "type": "color",
      "id": "badge_text",
      "label": "Brand badge text",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Colours — Text"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title colour",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price colour",
      "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Colours — Buttons"
    },
    {
      "type": "color",
      "id": "btn_primary_bg",
      "label": "Add button background",
      "default": "#2d2d2d"
    },
    {
      "type": "color",
      "id": "btn_primary_text",
      "label": "Add button text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "btn_secondary_bg",
      "label": "See More background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "btn_secondary_text",
      "label": "See More text",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "btn_secondary_border",
      "label": "See More border",
      "default": "#e5e5e5"
    }
  ],
  "presets": [
    {
      "name": "Invicta Product Grid",
      "settings": {
        "columns_desktop": 4,
        "columns_tablet": 3,
        "columns_mobile": 2,
        "products_per_page": 24,
        "show_sort": true
      }
    }
  ]
}
{% endschema %}

