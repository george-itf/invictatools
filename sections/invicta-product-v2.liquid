{% comment %}
  ============================================
  INVICTA PRODUCT V2 — SECTION TEMPLATE
  Version: 3.0.0 — Full rebuild with fixes
  
  Changelog from 2.4.0:
  - FIXED: VAT toggle data attributes aligned
  - FIXED: Buy Now goes to checkout (not cart)
  - FIXED: Cart drawer opens after add
  - FIXED: Single description with CSS reorder
  - FIXED: Removed inline onclick handlers
  - FIXED: Buy Now disabled when out of stock
  - FIXED: Keyboard navigation for gallery
  - FIXED: aria-live for price announcements
  - ADDED: More schema settings
  - ADDED: Focus-visible states throughout
  - CLEANED: Removed unnecessary code
  
  Uses .inv-pdp__* prefix to avoid conflicts
  ============================================
{% endcomment %}

{{ 'invicta-product-v2.css' | asset_url | stylesheet_tag }}
<style>
  /* Phase 3: Trust Panel & Delivery Estimate Integration */
  .inv-pdp__trust-panel {
    background: var(--inv-bg, #f5f5f6);
    border-radius: var(--inv-radius-card, 12px);
    padding: 14px 16px;
    margin-top: 12px;
  }
  .inv-pdp__trust-panel-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .inv-pdp__trust-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--inv-fg, #0f172a);
    background: var(--inv-bg-elevated, #fff);
    border: 1px solid var(--inv-border, #e5e7eb);
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s;
  }
  .inv-pdp__trust-chip:hover {
    border-color: var(--inv-accent, #e11d26);
    color: var(--inv-accent, #e11d26);
    box-shadow: 0 2px 8px rgba(225, 29, 38, 0.12);
  }
  .inv-pdp__trust-chip svg {
    color: var(--inv-accent, #e11d26);
    flex-shrink: 0;
  }
  .inv-pdp__trust-panel-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 14px;
    padding-top: 10px;
    border-top: 1px solid var(--inv-border, #e5e7eb);
  }
  .inv-pdp__mini-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--inv-fg-muted, #6b7280);
    font-weight: 500;
    white-space: nowrap;
  }
  .inv-pdp__mini-badge svg {
    flex-shrink: 0;
  }
  @media (max-width: 749px) {
    .inv-pdp__trust-panel-row {
      gap: 6px;
    }
    .inv-pdp__trust-chip {
      font-size: 12px;
      padding: 5px 10px;
    }
    .inv-pdp__trust-panel-badges {
      gap: 4px 10px;
    }
    .inv-pdp__mini-badge {
      font-size: 11px;
    }
  }
</style>


{% liquid
  comment
    ============================
    CORE PRODUCT DATA
    ============================
  endcomment
  assign current_variant = product.selected_or_first_available_variant
  assign featured_image = current_variant.featured_image | default: product.featured_image
  
  comment
    Compare price logic
  endcomment
  assign has_compare_price = false
  if current_variant.compare_at_price > current_variant.price
    assign has_compare_price = true
  endif
  
  comment
    Price ex VAT calculation (P0.4 FIX)
    Shopify prices are in pence, divide by 1.2 for ex VAT
    Using integer-safe rounding: times: 100 | plus: 60 | divided_by: 120
    (adds half of 120 to round to nearest penny, not truncate)
  endcomment
  assign price_ex_vat = current_variant.price | times: 100 | plus: 60 | divided_by: 120
  assign compare_ex_vat = current_variant.compare_at_price | times: 100 | plus: 60 | divided_by: 120
  
  comment
    Discount percentage
  endcomment
  assign discount_percent = 0
  if has_compare_price
    assign discount_amount = current_variant.compare_at_price | minus: current_variant.price
    assign discount_percent = discount_amount | times: 100.0 | divided_by: current_variant.compare_at_price | round
  endif
  
  comment
    Stock status
  endcomment
  assign is_in_stock = current_variant.available
  
  comment
    Gallery logic
  endcomment
  assign has_multiple_images = false
  if product.images.size > 1
    assign has_multiple_images = true
  endif
  
  comment
    Section settings shortcuts
  endcomment
  assign show_breadcrumb = section.settings.show_breadcrumb
  assign show_sku = section.settings.show_sku
  assign show_trust_badges = section.settings.show_trust_badges
  assign show_kit_builder = section.settings.show_kit_builder
  assign show_key_specs = section.settings.show_key_specs
  assign show_buy_now = section.settings.show_buy_now
  assign delivery_title = section.settings.delivery_title
  assign delivery_text = section.settings.delivery_text
%}

<div 
  class="inv-pdp" 
  data-section-id="{{ section.id }}" 
  data-product-id="{{ product.id }}"
  data-product-url="{{ product.url }}"
  data-product-handle="{{ product.handle }}"
>
  
  {%- comment -%} ========== BREADCRUMB BAR ========== {%- endcomment -%}
  {% if show_breadcrumb %}
    <div class="inv-pdp__breadcrumb-bar">
      <nav class="inv-pdp__breadcrumb" aria-label="Breadcrumb">
        <ol itemscope itemtype="https://schema.org/BreadcrumbList">
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/"><span itemprop="name">Home</span></a>
            <meta itemprop="position" content="1">
          </li>
          <li aria-hidden="true"><span class="inv-pdp__breadcrumb-sep">/</span></li>
          {% if product.collections.size > 0 %}
            {% assign primary_collection = product.collections | first %}
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <a itemprop="item" href="{{ primary_collection.url }}"><span itemprop="name">{{ primary_collection.title }}</span></a>
              <meta itemprop="position" content="2">
            </li>
            <li aria-hidden="true"><span class="inv-pdp__breadcrumb-sep">/</span></li>
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <span class="inv-pdp__breadcrumb-current" itemprop="name">{{ product.title | truncate: 50 }}</span>
              <meta itemprop="position" content="3">
            </li>
          {% else %}
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <span class="inv-pdp__breadcrumb-current" itemprop="name">{{ product.title | truncate: 50 }}</span>
              <meta itemprop="position" content="2">
            </li>
          {% endif %}
        </ol>
      </nav>
      
      {% if show_sku %}
        <span class="inv-pdp__sku" data-sku>
          {{ current_variant.sku | default: product.handle | upcase }}
        </span>
      {% endif %}
    </div>
  {% endif %}

  {%- comment -%} ========== MAIN GRID ========== {%- endcomment -%}
  <div class="inv-pdp__grid">
    
    {%- comment -%} ========== LEFT COLUMN ========== {%- endcomment -%}
    <div class="inv-pdp__left">
      
      {%- comment -%} PRODUCT TITLE {%- endcomment -%}
      <h1 class="inv-pdp__title">{{ product.title | escape }}</h1>
      
      {%- comment -%} GALLERY {%- endcomment -%}
      <div 
        class="inv-pdp__gallery{% unless has_multiple_images %} inv-pdp__gallery--single{% endunless %}"
        data-gallery
      >
        {% if has_multiple_images %}
          <div 
            class="inv-pdp__gallery-thumbs" 
            role="listbox" 
            aria-label="Product images"
            tabindex="0"
            data-gallery-thumbs
          >
            {% for image in product.images limit: 6 %}
              <button 
                type="button"
                class="inv-pdp__gallery-thumb{% if forloop.first %} inv-pdp__gallery-thumb--active{% endif %}"
                data-image-id="{{ image.id }}"
                data-image-src="{{ image | image_url: width: 800 }}"
                data-index="{{ forloop.index0 }}"
                aria-label="View image {{ forloop.index }} of {{ product.images.size }}"
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                role="option"
              >
                <img 
                  src="{{ image | image_url: width: 150 }}" 
                  alt="{{ image.alt | escape | default: product.title }}"
                  loading="lazy"
                  width="64"
                  height="64"
                >
              </button>
            {% endfor %}
          </div>
        {% endif %}
        
        <div class="inv-pdp__gallery-main">
          {% if discount_percent > 0 %}
            <span class="inv-pdp__gallery-badge" aria-label="Save {{ discount_percent }} percent">
              SAVE {{ discount_percent }}%
            </span>
          {% endif %}
          
          <div class="inv-pdp__gallery-image-wrap">
            <img 
              id="inv-pdp-main-image-{{ section.id }}"
              class="inv-pdp__gallery-image"
              src="{{ featured_image | image_url: width: 800 }}"
              alt="{{ featured_image.alt | escape | default: product.title }}"
              width="800"
              height="800"
              data-main-image
            >
          </div>
          
          <button 
            type="button" 
            class="inv-pdp__gallery-zoom" 
            aria-label="Zoom image"
            data-zoom-trigger
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
              <path d="M11 8v6M8 11h6"></path>
            </svg>
            Zoom
          </button>
        </div>
      </div>
      
      {%- comment -%} KEY SPECS CHIPS {%- endcomment -%}
      {% if show_key_specs %}
        {% liquid
          assign has_key_specs = false
          if product.metafields.custom.voltage != blank or product.metafields.custom.max_torque != blank or product.metafields.custom.motor_type != blank
            assign has_key_specs = true
          endif
        %}
        {% if has_key_specs %}
          <div class="inv-pdp__key-specs" role="list" aria-label="Key specifications">
            {% if product.metafields.custom.voltage != blank %}
              <span class="inv-pdp__key-spec" role="listitem">
                <svg class="inv-pdp__key-spec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                {{ product.metafields.custom.voltage }}
              </span>
            {% endif %}
            {% if product.metafields.custom.max_torque != blank %}
              <span class="inv-pdp__key-spec" role="listitem">
                <svg class="inv-pdp__key-spec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
                {{ product.metafields.custom.max_torque }}
              </span>
            {% endif %}
            {% if product.metafields.custom.motor_type != blank %}
              <span class="inv-pdp__key-spec" role="listitem">
                <svg class="inv-pdp__key-spec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                {{ product.metafields.custom.motor_type }}
              </span>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
      
      {%- comment -%} FEATURE CHIPS {%- endcomment -%}
      {% if product.metafields.custom.features != blank %}
        <div class="inv-pdp__features" role="list" aria-label="Product features">
          {% assign features = product.metafields.custom.features | split: ',' %}
          {% for feature in features limit: 5 %}
            <span class="inv-pdp__feature-chip" role="listitem">
              <span class="inv-pdp__feature-chip-icon" aria-hidden="true">✓</span>
              {{ feature | strip }}
            </span>
          {% endfor %}
        </div>
      {% endif %}
      
      {%- comment -%} PRODUCT INFO — Table rows {%- endcomment -%}
      <div class="inv-pdp__info" data-product-info>
        <h2 class="inv-pdp__info-title">Product Info</h2>
        
        {%- comment -%} Specs Table — All sections as rows {%- endcomment -%}
        <div class="inv-pdp__info-table">
          
          {%- comment -%} Brand {%- endcomment -%}
          {% if product.vendor != blank %}
            <div class="inv-pdp__info-row">
              <span class="inv-pdp__info-label">Brand</span>
              <span class="inv-pdp__info-value">{{ product.vendor }}</span>
            </div>
          {% endif %}
          
          {%- comment -%} Part Number {%- endcomment -%}
          {% if show_sku %}
            <div class="inv-pdp__info-row">
              <span class="inv-pdp__info-label">Part Number</span>
              <span class="inv-pdp__info-value" data-sku-display>{{ current_variant.sku | default: product.handle | upcase }}</span>
            </div>
          {% endif %}
          
          {%- comment -%} 
            Description content - will be parsed by JS into separate rows
          {%- endcomment -%}
          {% if product.description != blank %}
            <div class="inv-pdp__info-row inv-pdp__info-row--hidden" data-description-source>
              {{ product.description }}
            </div>
            
            {%- comment -%} JS will populate these rows {%- endcomment -%}
            <div class="inv-pdp__info-row inv-pdp__info-row--full" data-row="description" style="display:none;">
              <span class="inv-pdp__info-label">Description</span>
              <div class="inv-pdp__info-content" data-content></div>
            </div>
            <div class="inv-pdp__info-row inv-pdp__info-row--full" data-row="why-buy" style="display:none;">
              <span class="inv-pdp__info-label">Why Buy?</span>
              <ul class="inv-pdp__info-list" data-content></ul>
            </div>
            <div class="inv-pdp__info-row inv-pdp__info-row--full" data-row="used-for" style="display:none;">
              <span class="inv-pdp__info-label">Used For</span>
              <ul class="inv-pdp__info-list" data-content></ul>
            </div>
            <div class="inv-pdp__info-row inv-pdp__info-row--full" data-row="specifications" style="display:none;">
              <span class="inv-pdp__info-label">Specifications</span>
              <div class="inv-pdp__info-specs" data-content></div>
            </div>
            <div class="inv-pdp__info-row inv-pdp__info-row--full" data-row="whats-included" style="display:none;">
              <span class="inv-pdp__info-label">What's Included</span>
              <ul class="inv-pdp__info-list inv-pdp__info-list--included" data-content></ul>
            </div>
            
            {%- comment -%} Fallback if JS fails {%- endcomment -%}
            <noscript>
              <div class="inv-pdp__info-row inv-pdp__info-row--full">
                <span class="inv-pdp__info-label">Description</span>
                <div class="inv-pdp__info-content">{{ product.description }}</div>
              </div>
            </noscript>
          {% endif %}
          
        </div>
      </div>
      
    </div>
    
    {%- comment -%} ========== RIGHT COLUMN — BUY BOX ========== {%- endcomment -%}
    <div class="inv-pdp__right">
      <div class="inv-pdp__buybox">
        
        {%- comment -%} STOCK BANNER {%- endcomment -%}
        <div 
          class="inv-pdp__stock-banner{% if is_in_stock %} inv-pdp__stock-banner--in-stock{% else %} inv-pdp__stock-banner--out-of-stock{% endif %}"
          role="status"
          aria-live="polite"
          data-stock-banner
        >
          <span class="inv-pdp__stock-dot" aria-hidden="true"></span>
          <span data-stock-text>
            {% if is_in_stock %}
              In Stock — Ready to Ship
            {% else %}
              Out of Stock
            {% endif %}
          </span>
        </div>
        
        <div class="inv-pdp__buybox-body">
          
          {%- comment -%} DEALER BADGE + BRAND PILL {%- endcomment -%}
          {% liquid
            assign dealer_vendor = product.vendor | downcase
            assign dealer_bg = '#2d2d2d'
            assign dealer_text = '#ffffff'
            
            if dealer_vendor contains 'makita'
              assign dealer_bg = '#00a0aa'
              assign dealer_text = '#ffffff'
            elsif dealer_vendor contains 'dewalt'
              assign dealer_bg = '#febd17'
              assign dealer_text = '#111111'
            elsif dealer_vendor contains 'hikoki'
              assign dealer_bg = '#006b3f'
              assign dealer_text = '#ffffff'
            elsif dealer_vendor contains 'milwaukee'
              assign dealer_bg = '#db0032'
              assign dealer_text = '#ffffff'
            endif
          %}
          <div class="inv-pdp__dealer-row">
            <div class="inv-pdp__dealer-badge" style="--dealer-bg: {{ dealer_bg }}; --dealer-text: {{ dealer_text }};">
              <svg class="inv-pdp__dealer-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <path d="m9 12 2 2 4-4"/>
              </svg>
              <span class="inv-pdp__dealer-badge-text">Authorised Dealer</span>
            </div>
            {% render 'invicta-brand-pill', product: product %}
          </div>
          
          {%- comment -%} 
            PRICE BLOCK — FIXED DATA ATTRIBUTES
            Aligned with VAT toggle expectations
          {%- endcomment -%}
          <div 
            class="inv-pdp__price" 
            data-price-wrapper
            aria-live="polite"
            aria-atomic="true"
          >
            {%- comment -%} INC VAT VIEW (default) {%- endcomment -%}
            <div class="inv-pdp__price-view" data-vat-view="inc">
              <div class="inv-pdp__price-row">
                <span class="inv-pdp__price-current" data-price-inc>
                  {{ current_variant.price | money }}
                </span>
                <span class="inv-pdp__price-label">inc VAT</span>
                {% if has_compare_price %}
                  <span class="inv-pdp__price-was" data-compare-inc>
                    {{ current_variant.compare_at_price | money }}
                  </span>
                {% endif %}
              </div>
              <div class="inv-pdp__price-alt" data-vat-alt="inc">
                <span data-price-ex-alt>{{ price_ex_vat | money }}</span> ex VAT
              </div>
            </div>
            
            {%- comment -%} EX VAT VIEW (toggled) {%- endcomment -%}
            <div class="inv-pdp__price-view inv-pdp__price-view--hidden" data-vat-view="ex">
              <div class="inv-pdp__price-row">
                <span class="inv-pdp__price-current" data-price-ex>
                  {{ price_ex_vat | money }}
                </span>
                <span class="inv-pdp__price-label">ex VAT</span>
                {% if has_compare_price %}
                  <span class="inv-pdp__price-was" data-compare-ex>
                    {{ compare_ex_vat | money }}
                  </span>
                {% endif %}
              </div>
              <div class="inv-pdp__price-alt" data-vat-alt="ex">
                <span data-price-inc-alt>{{ current_variant.price | money }}</span> inc VAT
              </div>
            </div>
            
            {%- comment -%} SAVINGS (visible in both views) {%- endcomment -%}
            {% if has_compare_price %}
              <div class="inv-pdp__price-savings" data-savings-wrap>
                <span class="inv-pdp__price-save" data-savings>
                  You save {{ current_variant.compare_at_price | minus: current_variant.price | money }} ({{ discount_percent }}% off)
                </span>
              </div>
            {% endif %}
          </div>
          
          {%- comment -%} VARIANTS {%- endcomment -%}
          {% if product.has_only_default_variant == false %}
            <div class="inv-pdp__variants">
              {% for option in product.options_with_values %}
                <div class="inv-pdp__variant-group">
                  <label 
                    class="inv-pdp__variant-group-label" 
                    for="inv-pdp-option-{{ section.id }}-{{ forloop.index0 }}"
                  >
                    {{ option.name }}
                  </label>
                  <select 
                    id="inv-pdp-option-{{ section.id }}-{{ forloop.index0 }}"
                    class="inv-pdp__variant-select"
                    data-option-index="{{ forloop.index0 }}"
                  >
                    {% for value in option.values %}
                      <option 
                        value="{{ value | escape }}"
                        {% if option.selected_value == value %}selected{% endif %}
                      >
                        {{ value }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              {% endfor %}
            </div>
          {% endif %}
          
          {%- comment -%} KIT BUILDER — Collapsible {%- endcomment -%}
          {% if show_kit_builder %}
            <div class="inv-pdp__kit-wrapper" data-kit-wrapper>
              <button 
                type="button" 
                class="inv-pdp__kit-toggle" 
                aria-expanded="false" 
                aria-controls="inv-pdp-kit-content-{{ section.id }}"
                data-kit-toggle
              >
                <span class="inv-pdp__kit-toggle-icon" aria-hidden="true">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                </span>
                <span class="inv-pdp__kit-toggle-text">
                  <strong>Build &amp; Save</strong>
                  <span>Bundle batteries, charger &amp; case</span>
                </span>
                <span class="inv-pdp__kit-toggle-chevron" aria-hidden="true">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </span>
              </button>
              
              <div 
                id="inv-pdp-kit-content-{{ section.id }}" 
                class="inv-pdp__kit-content" 
                data-kit-content
                hidden
              >
                {% render 'kit-builder', product: product %}
              </div>
            </div>
          {% endif %}
          
          {%- comment -%} DELIVERY ESTIMATE (reusable snippet) {%- endcomment -%}
          {% render 'invicta-delivery-estimate' %}
          
          {%- comment -%} ADD TO CART FORM {%- endcomment -%}
          <form 
            class="inv-pdp__form" 
            action="/cart/add" 
            method="post" 
            data-product-form
            id="inv-pdp-form-{{ section.id }}"
          >
            <input type="hidden" name="id" value="{{ current_variant.id }}" data-variant-id>
            
            <div class="inv-pdp__atc-row">
              <div class="inv-pdp__qty">
                <button 
                  type="button" 
                  class="inv-pdp__qty-btn" 
                  data-qty-decrease 
                  aria-label="Decrease quantity"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
                <input 
                  type="number" 
                  name="quantity" 
                  class="inv-pdp__qty-input" 
                  value="1" 
                  min="1" 
                  max="99"
                  aria-label="Quantity"
                  data-qty-input
                >
                <button 
                  type="button" 
                  class="inv-pdp__qty-btn" 
                  data-qty-increase 
                  aria-label="Increase quantity"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
              
              <button 
                type="submit" 
                class="inv-pdp__atc-btn"
                data-atc-btn
                {% unless is_in_stock %}disabled{% endunless %}
              >
                <span class="inv-pdp__atc-text" data-atc-text>
                  {% if is_in_stock %}Add to Cart{% else %}Out of Stock{% endif %}
                </span>
                <span class="inv-pdp__atc-loading" aria-hidden="true">
                  <svg class="inv-pdp__spinner" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"></circle>
                  </svg>
                  Adding...
                </span>
                <span class="inv-pdp__atc-success" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"></path>
                  </svg>
                  Added!
                </span>
              </button>
            </div>
            
            {%- comment -%} BUY NOW — FIXED: Goes to checkout, disabled when OOS {%- endcomment -%}
            {% if show_buy_now %}
              <div class="inv-pdp__buy-now">
                <button 
                  type="button" 
                  class="inv-pdp__buy-now-btn"
                  data-buy-now
                  data-variant-id="{{ current_variant.id }}"
                  {% unless is_in_stock %}disabled{% endunless %}
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                  </svg>
                  Buy Now — Skip the Cart
                </button>
              </div>
            {% endif %}
          </form>
          
          {%- comment -%} INTEGRATED TRUST & SUPPORT BAR {%- endcomment -%}
          <div class="inv-pdp__trust-panel">
            <div class="inv-pdp__trust-panel-row">
              <a href="/pages/warranty" class="inv-pdp__trust-chip">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Warranty
              </a>
              <a href="/pages/returns" class="inv-pdp__trust-chip">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                30-Day Returns
              </a>
              <button type="button" class="inv-pdp__trust-chip" data-open-chat>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                Trade Support
              </button>
            </div>
            <div class="inv-pdp__trust-panel-badges">
              <span class="inv-pdp__mini-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--inv-accent)" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
                Authorised Dealer
              </span>
              <span class="inv-pdp__mini-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--inv-accent)" stroke-width="2.5"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                Free Delivery over £30
              </span>
              <span class="inv-pdp__mini-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--inv-accent)" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Full Warranty
              </span>
              <span class="inv-pdp__mini-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--inv-accent)" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                2 Kent Branches
              </span>
              <span class="inv-pdp__mini-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--inv-accent)" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                30+ Years Trading
              </span>
            </div>
          </div>
          
        </div>
      </div>
    </div>
    
  </div>
</div>

{%- comment -%} ========== LIGHTBOX ========== {%- endcomment -%}
<div 
  id="inv-pdp-lightbox-{{ section.id }}" 
  class="inv-pdp__lightbox" 
  role="dialog"
  aria-modal="true"
  aria-label="Image zoom"
  data-lightbox
  hidden
>
  <div class="inv-pdp__lightbox-backdrop" data-lightbox-close></div>
  <div class="inv-pdp__lightbox-content">
    <button 
      type="button" 
      class="inv-pdp__lightbox-close" 
      aria-label="Close zoom" 
      data-lightbox-close
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <img 
      id="inv-pdp-lightbox-img-{{ section.id }}" 
      src="" 
      alt="" 
      width="1200" 
      height="1200" 
      data-lightbox-img
    >
  </div>
</div>

{%- comment -%} ========== VARIANT JSON ========== {%- endcomment -%}
<script type="application/json" data-variants-json>
  {{ product.variants | json }}
</script>

{%- comment -%} ========== PRODUCT IMAGES JSON ========== {%- endcomment -%}
<script type="application/json" data-images-json>
  {
    {% for image in product.images %}
      "{{ image.id }}": "{{ image | image_url: width: 800 }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  }
</script>

{%- comment -%} ========== JAVASCRIPT ========== {%- endcomment -%}
<script>
(function() {
  'use strict';
  
  /**
   * Invicta Product V2 — Main Controller
   * @version 3.0.0
   */
  
  /** @type {HTMLElement|null} */
  var section = document.querySelector('.inv-pdp[data-section-id="{{ section.id }}"]');
  if (!section) return;
  
  /* ========================================
     UTILITIES
     ======================================== */
  
  /**
   * Format money in GBP
   * @param {number} cents - Price in pence
   * @returns {string} Formatted price
   */
  function formatMoney(cents) {
    if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
      return Shopify.formatMoney(cents);
    }
    return '£' + (cents / 100).toFixed(2);
  }
  
  /**
   * Get current VAT mode from localStorage
   * @returns {string} 'inc' or 'ex'
   */
  function getVatMode() {
    try {
      return localStorage.getItem('invicta-vat-mode') || 'inc';
    } catch (e) {
      return 'inc';
    }
  }
  
  /* ========================================
     ELEMENTS
     ======================================== */
  
  var mainImage = section.querySelector('[data-main-image]');
  var thumbs = section.querySelectorAll('.inv-pdp__gallery-thumb');
  var thumbsContainer = section.querySelector('[data-gallery-thumbs]');
  var variantSelects = section.querySelectorAll('.inv-pdp__variant-select');
  var productForm = section.querySelector('[data-product-form]');
  var atcBtn = section.querySelector('[data-atc-btn]');
  var atcText = section.querySelector('[data-atc-text]');
  var buyNowBtn = section.querySelector('[data-buy-now]');
  var variantInput = section.querySelector('[data-variant-id]');
  var qtyInput = section.querySelector('[data-qty-input]');
  var priceWrapper = section.querySelector('[data-price-wrapper]');
  var lightbox = document.getElementById('inv-pdp-lightbox-{{ section.id }}');
  var lightboxImg = lightbox ? lightbox.querySelector('[data-lightbox-img]') : null;
  var chatBtn = section.querySelector('[data-open-chat]');
  
  /** @type {Array<Object>} */
  var variants = [];
  
  /** @type {Object<string, string>} */
  var imageMap = {};
  
  /* ========================================
     DESCRIPTION PARSER
     Parse product description into separate table rows
     ======================================== */
  
  /**
   * Parse description HTML and split into sections
   */
  function parseDescription() {
    var source = section.querySelector('[data-description-source]');
    if (!source) {
      console.warn('[Invicta PDP] Description source not found');
      return;
    }
    
    var html = source.innerHTML.trim();
    if (!html) {
      console.warn('[Invicta PDP] Description is empty');
      return;
    }
    
    /**
     * Check if text matches a section type
     * @param {string} text - Header text to check
     * @returns {string|null} - Section key or null
     */
    function matchSection(text) {
      var t = text.toLowerCase().trim();
      
      /* What's Included / In the Box */
      if (t.indexOf('what') === 0 && (t.indexOf('included') > -1 || t.indexOf('in the box') > -1)) return 'whats-included';
      if (t.indexOf('in the box') > -1) return 'whats-included';
      if (t === 'includes' || t === 'included') return 'whats-included';
      
      /* Specifications */
      if (t === 'specifications' || t === 'specification' || t === 'specs' || t === 'technical data' || t === 'technical specifications') return 'specifications';
      
      /* Used For / Ideal For */
      if (t.indexOf('ideal for') > -1 || t.indexOf('used for') > -1 || t.indexOf('perfect for') > -1 || t.indexOf('great for') > -1 || t.indexOf('suitable for') > -1) return 'used-for';
      
      /* Why Buy - matches "Why [anything]" */
      if (t.indexOf('why ') === 0) return 'why-buy';
      if (t === 'key features' || t === 'features') return 'why-buy';
      
      return null;
    }
    
    /* Create temp container to parse HTML */
    var temp = document.createElement('div');
    temp.innerHTML = html;
    
    var foundSections = {};
    var currentSection = 'description';
    var currentContent = [];
    
    /**
     * Save current content to section
     */
    function saveSection() {
      if (currentContent.length > 0) {
        var content = currentContent.join('');
        if (content.trim()) {
          if (!foundSections[currentSection]) {
            foundSections[currentSection] = '';
          }
          foundSections[currentSection] += content;
        }
        currentContent = [];
      }
    }
    
    /* Process all child nodes */
    var children = Array.from(temp.childNodes);
    
    children.forEach(function(node) {
      if (node.nodeType !== 1 && node.nodeType !== 3) return; /* Only elements and text */
      
      var isHeader = false;
      var headerText = '';
      
      if (node.nodeType === 1) { /* Element node */
        var tagName = node.tagName.toLowerCase();
        
        /* Direct header tags */
        if (['h1','h2','h3','h4','h5','h6'].indexOf(tagName) > -1) {
          isHeader = true;
          headerText = node.textContent.trim();
        }
        /* Paragraph or div with only a strong/b as content */
        else if (tagName === 'p' || tagName === 'div') {
          var firstChild = node.firstElementChild;
          if (firstChild && (firstChild.tagName === 'STRONG' || firstChild.tagName === 'B')) {
            if (node.textContent.trim() === firstChild.textContent.trim()) {
              isHeader = true;
              headerText = firstChild.textContent.trim();
            }
          }
        }
      }
      
      if (isHeader && headerText) {
        /* Save previous section */
        saveSection();
        
        /* Determine which section this header belongs to */
        var sectionKey = matchSection(headerText);
        
        if (sectionKey) {
          currentSection = sectionKey;
        } else {
          /* Unknown header - include it in description */
          currentSection = 'description';
          currentContent.push(node.outerHTML || node.textContent);
        }
      } else {
        /* Regular content */
        if (node.nodeType === 1) {
          /* Skip tables - they're usually spec tables handled separately */
          if (node.tagName.toLowerCase() !== 'table') {
            currentContent.push(node.outerHTML);
          } else {
            /* For tables, extract as specs if we're in specifications section */
            if (currentSection === 'specifications') {
              var rows = node.querySelectorAll('tr');
              var specTexts = [];
              rows.forEach(function(row) {
                var cells = row.querySelectorAll('td, th');
                if (cells.length >= 2) {
                  specTexts.push(cells[0].textContent.trim() + ': ' + cells[1].textContent.trim());
                }
              });
              if (specTexts.length > 0) {
                currentContent.push('<p>' + specTexts.join(' \u2022 ') + '</p>');
              }
            }
          }
        } else if (node.nodeType === 3 && node.textContent.trim()) {
          currentContent.push('<p>' + node.textContent.trim() + '</p>');
        }
      }
    });
    
    /* Save final section */
    saveSection();
    
    /* Populate rows */
    var rowOrder = ['description', 'why-buy', 'used-for', 'specifications', 'whats-included'];
    var anyRowShown = false;
    
    rowOrder.forEach(function(key) {
      var row = section.querySelector('[data-row="' + key + '"]');
      if (!row) return;
      
      var content = foundSections[key];
      if (!content || !content.trim()) return;
      
      var contentEl = row.querySelector('[data-content]');
      if (!contentEl) return;
      
      /* Parse content */
      var tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      
      var items = tempDiv.querySelectorAll('li');
      var paras = tempDiv.querySelectorAll('p');
      var tables = tempDiv.querySelectorAll('table');
      
      /* Handle different content types */
      if (key === 'description') {
        /* Description — paragraphs */
        if (paras.length > 0) {
          paras.forEach(function(p) {
            var text = p.textContent.trim();
            if (text) {
              var newP = document.createElement('p');
              newP.textContent = text;
              contentEl.appendChild(newP);
            }
          });
        } else {
          var text = tempDiv.textContent.trim();
          if (text) {
            var newP = document.createElement('p');
            newP.textContent = text;
            contentEl.appendChild(newP);
          }
        }
      } 
      else if (key === 'why-buy' || key === 'used-for') {
        /* Why Buy / Used For — bullet list */
        if (items.length > 0) {
          items.forEach(function(li) {
            var text = li.textContent.trim();
            if (text) {
              var newLi = document.createElement('li');
              newLi.textContent = text;
              contentEl.appendChild(newLi);
            }
          });
        } else if (paras.length > 0) {
          paras.forEach(function(p) {
            var text = p.textContent.trim();
            if (text) {
              var newLi = document.createElement('li');
              newLi.textContent = text;
              contentEl.appendChild(newLi);
            }
          });
        } else {
          /* Split by sentences or bullet chars */
          var text = tempDiv.textContent.trim();
          var parts = text.split(/[\u2022\u2023\u25E6\u2043\u2219]|\n/).filter(function(s) { return s.trim(); });
          parts.forEach(function(part) {
            var newLi = document.createElement('li');
            newLi.textContent = part.trim();
            contentEl.appendChild(newLi);
          });
        }
      } 
      else if (key === 'specifications') {
        /* Specifications — grid */
        var specs = [];
        
        /* Extract from tables */
        if (tables.length > 0) {
          tables.forEach(function(table) {
            var rows = table.querySelectorAll('tr');
            rows.forEach(function(tr) {
              var cells = tr.querySelectorAll('td, th');
              if (cells.length >= 2) {
                var label = cells[0].textContent.trim();
                var value = cells[1].textContent.trim();
                if (label && value) {
                  specs.push({ label: label, value: value });
                }
              }
            });
          });
        }
        
        /* Extract from list items */
        if (items.length > 0 && specs.length === 0) {
          items.forEach(function(li) {
            var text = li.textContent.trim();
            var colonPos = text.indexOf(':');
            if (colonPos > 0) {
              specs.push({
                label: text.substring(0, colonPos).trim(),
                value: text.substring(colonPos + 1).trim()
              });
            }
          });
        }
        
        /* Extract from text with colons */
        if (specs.length === 0) {
          var text = tempDiv.textContent.trim();
          /* Split by bullet or newline */
          var parts = text.split(/[\u2022\u2023\n]/).filter(function(s) { return s.trim(); });
          parts.forEach(function(part) {
            var colonPos = part.indexOf(':');
            if (colonPos > 0) {
              specs.push({
                label: part.substring(0, colonPos).trim(),
                value: part.substring(colonPos + 1).trim()
              });
            }
          });
        }
        
        /* Build grid */
        specs.forEach(function(spec) {
          var item = document.createElement('div');
          item.className = 'inv-pdp__info-specs-item';
          
          var label = document.createElement('span');
          label.className = 'inv-pdp__info-specs-label';
          label.textContent = spec.label;
          
          var value = document.createElement('span');
          value.className = 'inv-pdp__info-specs-value';
          value.textContent = spec.value;
          
          item.appendChild(label);
          item.appendChild(value);
          contentEl.appendChild(item);
        });
      } 
      else if (key === 'whats-included') {
        /* What's Included — checklist */
        var listItems = [];
        
        if (items.length > 0) {
          items.forEach(function(li) {
            listItems.push(li.textContent.trim());
          });
        } else {
          var text = tempDiv.textContent.trim();
          /* Split by bullet, newline, or comma */
          var parts = text.split(/[\u2022\u2023\n,\u00d7\xd7]/).filter(function(s) { return s.trim(); });
          listItems = parts.map(function(p) { return p.trim(); });
        }
        
        listItems.forEach(function(text) {
          if (!text) return;
          var newLi = document.createElement('li');
          newLi.textContent = text;
          
          /* Check if it's a "NOT included" item */
          var lowerText = text.toLowerCase();
          if (lowerText.indexOf('not included') > -1 || 
              lowerText.indexOf('not supplied') > -1 ||
              lowerText.indexOf('sold separately') > -1 ||
              lowerText.indexOf('excludes') > -1) {
            newLi.className = 'not-included';
          }
          
          contentEl.appendChild(newLi);
        });
      }
      
      /* Show row if it has content */
      if (contentEl.children.length > 0 || contentEl.textContent.trim()) {
        row.style.display = '';
        anyRowShown = true;
      }
    });
    
    /* Fallback: if nothing was parsed, show full description */
    if (!anyRowShown) {
      var descRow = section.querySelector('[data-row="description"]');
      if (descRow) {
        var contentEl = descRow.querySelector('[data-content]');
        if (contentEl) {
          var tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          var plainText = tempDiv.textContent.trim();
          var newP = document.createElement('p');
          newP.textContent = plainText.length > 500 ? plainText.substring(0, 500) + '...' : plainText;
          contentEl.appendChild(newP);
          descRow.style.display = '';
        }
      }
    }
    
    console.log('[Invicta PDP] Parsed sections:', Object.keys(foundSections));
  }
  
  /* Run description parser */
  parseDescription();
  
  /* ========================================
     PARSE JSON DATA
     ======================================== */
  
  var variantsJson = section.querySelector('[data-variants-json]');
  var imagesJson = section.querySelector('[data-images-json]');
  
  if (variantsJson) {
    try {
      variants = JSON.parse(variantsJson.textContent);
    } catch (e) {
      console.warn('[Invicta PDP] Failed to parse variants JSON');
    }
  }
  
  if (imagesJson) {
    try {
      imageMap = JSON.parse(imagesJson.textContent);
    } catch (e) {
      console.warn('[Invicta PDP] Failed to parse images JSON');
    }
  }
  
  /* ========================================
     THUMBNAIL GALLERY
     ======================================== */
  
  /**
   * Set active thumbnail and update main image
   * @param {HTMLElement} thumb - Thumbnail button to activate
   */
  function setActiveThumb(thumb) {
    if (!thumb || !mainImage) return;
    
    // Update active states
    thumbs.forEach(function(t) {
      t.classList.remove('inv-pdp__gallery-thumb--active');
      t.setAttribute('aria-selected', 'false');
    });
    
    thumb.classList.add('inv-pdp__gallery-thumb--active');
    thumb.setAttribute('aria-selected', 'true');
    
    // Update main image
    if (thumb.dataset.imageSrc) {
      mainImage.src = thumb.dataset.imageSrc;
    }
  }
  
  // Click handler for thumbnails
  thumbs.forEach(function(thumb) {
    thumb.addEventListener('click', function() {
      setActiveThumb(thumb);
    });
  });
  
  // Keyboard navigation for thumbnails
  if (thumbsContainer) {
    thumbsContainer.addEventListener('keydown', function(e) {
      var currentIndex = -1;
      var thumbArray = Array.prototype.slice.call(thumbs);
      
      thumbArray.forEach(function(t, i) {
        if (t.classList.contains('inv-pdp__gallery-thumb--active')) {
          currentIndex = i;
        }
      });
      
      var nextIndex = currentIndex;
      
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        nextIndex = (currentIndex + 1) % thumbArray.length;
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        nextIndex = (currentIndex - 1 + thumbArray.length) % thumbArray.length;
      } else if (e.key === 'Home') {
        e.preventDefault();
        nextIndex = 0;
      } else if (e.key === 'End') {
        e.preventDefault();
        nextIndex = thumbArray.length - 1;
      }
      
      if (nextIndex !== currentIndex && thumbArray[nextIndex]) {
        setActiveThumb(thumbArray[nextIndex]);
        thumbArray[nextIndex].focus();
      }
    });
  }
  
  /* ========================================
     QUANTITY SELECTOR
     ======================================== */
  
  var qtyDecrease = section.querySelector('[data-qty-decrease]');
  var qtyIncrease = section.querySelector('[data-qty-increase]');
  
  if (qtyDecrease && qtyInput) {
    qtyDecrease.addEventListener('click', function() {
      var val = parseInt(qtyInput.value, 10) || 1;
      var min = parseInt(qtyInput.min, 10) || 1;
      if (val > min) {
        qtyInput.value = val - 1;
        qtyInput.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  }
  
  if (qtyIncrease && qtyInput) {
    qtyIncrease.addEventListener('click', function() {
      var val = parseInt(qtyInput.value, 10) || 1;
      var max = parseInt(qtyInput.max, 10) || 99;
      if (val < max) {
        qtyInput.value = val + 1;
        qtyInput.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  }
  
  /* ========================================
     VARIANT SELECTOR
     ======================================== */
  
  /**
   * Find and apply matching variant
   */
  function updateVariant() {
    var selectedOptions = [];
    variantSelects.forEach(function(select) {
      selectedOptions.push(select.value);
    });
    
    // Find matching variant
    var matchingVariant = variants.find(function(v) {
      return v.options.every(function(opt, idx) {
        return opt === selectedOptions[idx];
      });
    });
    
    if (!matchingVariant) return;
    
    // Update hidden input
    if (variantInput) {
      variantInput.value = matchingVariant.id;
    }
    
    // Update prices
    updatePrices(matchingVariant);
    
    // Update stock status
    updateStockStatus(matchingVariant.available);
    
    // Update variant image
    if (matchingVariant.featured_image && mainImage) {
      var imgId = matchingVariant.featured_image.id;
      if (imageMap[imgId]) {
        mainImage.src = imageMap[imgId];
        
        // Update active thumbnail
        thumbs.forEach(function(t) {
          if (t.dataset.imageId == imgId) {
            setActiveThumb(t);
          }
        });
      }
    }
    
    // Update SKU displays
    section.querySelectorAll('[data-sku], [data-sku-display]').forEach(function(el) {
      el.textContent = matchingVariant.sku || '{{ product.handle | upcase }}';
    });
    
    // Update Buy Now button
    if (buyNowBtn) {
      buyNowBtn.dataset.variantId = matchingVariant.id;
      buyNowBtn.disabled = !matchingVariant.available;
    }
    
    // Update URL
    var url = new URL(window.location);
    url.searchParams.set('variant', matchingVariant.id);
    window.history.replaceState({}, '', url);
  }
  
  /**
   * Update price display for variant
   * @param {Object} variant - Variant object
   */
  function updatePrices(variant) {
    if (!priceWrapper) return;
    
    var priceInc = priceWrapper.querySelector('[data-price-inc]');
    var priceEx = priceWrapper.querySelector('[data-price-ex]');
    var priceExAlt = priceWrapper.querySelector('[data-price-ex-alt]');
    var priceIncAlt = priceWrapper.querySelector('[data-price-inc-alt]');
    var compareInc = priceWrapper.querySelector('[data-compare-inc]');
    var compareEx = priceWrapper.querySelector('[data-compare-ex]');
    var savingsWrap = priceWrapper.querySelector('[data-savings-wrap]');
    var savingsEl = priceWrapper.querySelector('[data-savings]');
    
    var exVat = Math.round(variant.price * 100 / 120);
    
    if (priceInc) priceInc.textContent = formatMoney(variant.price);
    if (priceEx) priceEx.textContent = formatMoney(exVat);
    if (priceExAlt) priceExAlt.textContent = formatMoney(exVat);
    if (priceIncAlt) priceIncAlt.textContent = formatMoney(variant.price);
    
    // Compare prices
    var hasCompare = variant.compare_at_price && variant.compare_at_price > variant.price;
    
    if (compareInc) {
      if (hasCompare) {
        compareInc.textContent = formatMoney(variant.compare_at_price);
        compareInc.style.display = '';
      } else {
        compareInc.style.display = 'none';
      }
    }
    
    if (compareEx) {
      if (hasCompare) {
        var compareExVat = Math.round(variant.compare_at_price * 100 / 120);
        compareEx.textContent = formatMoney(compareExVat);
        compareEx.style.display = '';
      } else {
        compareEx.style.display = 'none';
      }
    }
    
    // Savings
    if (savingsWrap && savingsEl) {
      if (hasCompare) {
        var saving = variant.compare_at_price - variant.price;
        var percent = Math.round((saving / variant.compare_at_price) * 100);
        savingsEl.textContent = 'You save ' + formatMoney(saving) + ' (' + percent + '% off)';
        savingsWrap.style.display = '';
      } else {
        savingsWrap.style.display = 'none';
      }
    }
  }
  
  /**
   * Update stock status UI
   * @param {boolean} available - Is variant in stock
   */
  function updateStockStatus(available) {
    var stockBanner = section.querySelector('[data-stock-banner]');
    var stockText = section.querySelector('[data-stock-text]');
    
    if (stockBanner && stockText) {
      if (available) {
        stockBanner.classList.remove('inv-pdp__stock-banner--out-of-stock');
        stockBanner.classList.add('inv-pdp__stock-banner--in-stock');
        stockText.textContent = 'In Stock — Ready to Ship';
      } else {
        stockBanner.classList.remove('inv-pdp__stock-banner--in-stock');
        stockBanner.classList.add('inv-pdp__stock-banner--out-of-stock');
        stockText.textContent = 'Out of Stock';
      }
    }
    
    if (atcBtn && atcText) {
      atcBtn.disabled = !available;
      atcText.textContent = available ? 'Add to Cart' : 'Out of Stock';
    }
    
    if (buyNowBtn) {
      buyNowBtn.disabled = !available;
    }
  }
  
  // Attach variant change listeners
  variantSelects.forEach(function(select) {
    select.addEventListener('change', updateVariant);
  });
  
  /* ========================================
     VAT TOGGLE INTEGRATION
     ======================================== */
  
  /**
   * Update price display based on VAT mode
   * @param {string} mode - 'inc' or 'ex'
   */
  function updateVatDisplay(mode) {
    if (!priceWrapper) return;
    
    var incView = priceWrapper.querySelector('[data-vat-view="inc"]');
    var exView = priceWrapper.querySelector('[data-vat-view="ex"]');
    
    if (incView && exView) {
      if (mode === 'ex') {
        incView.classList.add('inv-pdp__price-view--hidden');
        exView.classList.remove('inv-pdp__price-view--hidden');
      } else {
        incView.classList.remove('inv-pdp__price-view--hidden');
        exView.classList.add('inv-pdp__price-view--hidden');
      }
    }
  }
  
  // Listen for VAT toggle events
  document.addEventListener('invicta:vat-toggle', function(e) {
    var mode = e.detail && e.detail.mode ? e.detail.mode : 'inc';
    updateVatDisplay(mode);
  });
  
  // Apply initial VAT state
  updateVatDisplay(getVatMode());
  
  /* ========================================
     ADD TO CART — AJAX WITH CART DRAWER
     ======================================== */
  
  if (productForm && atcBtn) {
    productForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (atcBtn.disabled || atcBtn.classList.contains('is-loading')) {
        return;
      }
      
      var formData = new FormData(productForm);
      var variantId = formData.get('id');
      var quantity = parseInt(formData.get('quantity'), 10) || 1;
      
      // Set loading state
      atcBtn.classList.add('is-loading');
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          id: variantId,
          quantity: quantity
        })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Failed to add to cart');
        }
        return response.json();
      })
      .then(function(item) {
        // Success state
        atcBtn.classList.remove('is-loading');
        atcBtn.classList.add('is-success');
        
        // Open cart drawer (Trade 15.4.0)
        openCartDrawer();
        
        // Dispatch event for theme integration
        document.dispatchEvent(new CustomEvent('cart:item-added', {
          detail: { item: item, variantId: variantId, quantity: quantity }
        }));
        
        // Reset after delay
        setTimeout(function() {
          atcBtn.classList.remove('is-success');
        }, 2000);
      })
      .catch(function(error) {
        console.error('[Invicta PDP] Add to cart error:', error);
        
        atcBtn.classList.remove('is-loading');
        atcBtn.classList.add('is-error');
        
        setTimeout(function() {
          atcBtn.classList.remove('is-error');
        }, 2500);
      });
    });
  }
  
  /**
   * Open Trade 15.4.0 cart drawer
   */
  function openCartDrawer() {
    // Method 1: Trade theme cart drawer
    var cartDrawer = document.querySelector('cart-drawer');
    if (cartDrawer && typeof cartDrawer.open === 'function') {
      // Refresh cart contents first
      fetch('/cart.js')
        .then(function(r) { return r.json(); })
        .then(function(cart) {
          // Dispatch cart update event
          document.dispatchEvent(new CustomEvent('cart:refresh', { detail: { cart: cart } }));
          // Open drawer
          cartDrawer.open();
        });
      return;
    }
    
    // Method 2: Click cart icon to trigger drawer
    var cartIcon = document.querySelector('[data-cart-toggle], .header__icon--cart button, #cart-icon-bubble');
    if (cartIcon) {
      cartIcon.click();
      return;
    }
    
    // Method 3: Dispatch Trade theme event
    document.dispatchEvent(new CustomEvent('cart:open'));
  }
  
  /* ========================================
     BUY NOW — DIRECT TO CHECKOUT
     ======================================== */
  
  if (buyNowBtn) {
    buyNowBtn.addEventListener('click', function() {
      if (buyNowBtn.disabled) return;
      
      var variantId = buyNowBtn.dataset.variantId;
      var quantity = qtyInput ? parseInt(qtyInput.value, 10) || 1 : 1;
      
      // Show loading state
      buyNowBtn.classList.add('is-loading');
      buyNowBtn.disabled = true;
      
      // Add to cart then redirect to checkout
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          id: variantId,
          quantity: quantity
        })
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Failed to add to cart');
        }
        // Redirect to checkout
        window.location.href = '/checkout';
      })
      .catch(function(error) {
        console.error('[Invicta PDP] Buy now error:', error);
        buyNowBtn.classList.remove('is-loading');
        buyNowBtn.disabled = false;
      });
    });
  }
  
  /* ========================================
     KIT BUILDER TOGGLE
     ======================================== */
  
  var kitToggle = section.querySelector('[data-kit-toggle]');
  var kitContent = section.querySelector('[data-kit-content]');
  
  if (kitToggle && kitContent) {
    kitToggle.addEventListener('click', function() {
      var isExpanded = kitToggle.getAttribute('aria-expanded') === 'true';
      kitToggle.setAttribute('aria-expanded', String(!isExpanded));
      kitContent.hidden = isExpanded;
    });
  }
  
  /* ========================================
     CHAT BUTTON
     ======================================== */
  
  if (chatBtn) {
    chatBtn.addEventListener('click', function() {
      // Try common chat widgets
      if (typeof window.ShopifyChat !== 'undefined' && window.ShopifyChat.open) {
        window.ShopifyChat.open();
      } else if (typeof window.Gorgias !== 'undefined' && window.Gorgias.open) {
        window.Gorgias.open();
      } else if (typeof window.$crisp !== 'undefined') {
        window.$crisp.push(['do', 'chat:open']);
      } else if (typeof window.Intercom !== 'undefined') {
        window.Intercom('show');
      } else {
        // Fallback: try clicking Shopify Inbox button
        var inboxBtn = document.querySelector('#shopify-chat button, .shopify-chat-button');
        if (inboxBtn) inboxBtn.click();
      }
    });
  }
  
  /* ========================================
     LIGHTBOX
     ======================================== */
  
  var zoomBtn = section.querySelector('[data-zoom-trigger]');
  var lightboxCloseEls = lightbox ? lightbox.querySelectorAll('[data-lightbox-close]') : [];
  var previouslyFocused = null;
  
  /**
   * Open lightbox
   */
  function openLightbox() {
    if (!lightbox || !lightboxImg || !mainImage) return;
    
    previouslyFocused = document.activeElement;
    lightboxImg.src = mainImage.src.replace('width=800', 'width=1200');
    lightboxImg.alt = mainImage.alt;
    lightbox.hidden = false;
    document.body.style.overflow = 'hidden';
    
    // Focus close button
    var closeBtn = lightbox.querySelector('.inv-pdp__lightbox-close');
    if (closeBtn) closeBtn.focus();
  }
  
  /**
   * Close lightbox
   */
  function closeLightbox() {
    if (!lightbox) return;
    
    lightbox.hidden = true;
    document.body.style.overflow = '';
    
    if (previouslyFocused) {
      previouslyFocused.focus();
      previouslyFocused = null;
    }
  }
  
  if (zoomBtn) {
    zoomBtn.addEventListener('click', openLightbox);
  }
  
  lightboxCloseEls.forEach(function(el) {
    el.addEventListener('click', closeLightbox);
  });
  
  // Close on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && lightbox && !lightbox.hidden) {
      closeLightbox();
    }
  });
  
  // Focus trap in lightbox
  if (lightbox) {
    lightbox.addEventListener('keydown', function(e) {
      if (e.key !== 'Tab') return;
      
      var focusable = lightbox.querySelectorAll('button, [tabindex="0"]');
      var first = focusable[0];
      var last = focusable[focusable.length - 1];
      
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    });
  }
  
})();
</script>

{% schema %}
{
  "name": "Invicta Product V2",
  "tag": "section",
  "class": "section-invicta-product-v2",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumb",
      "label": "Show breadcrumb navigation",
      "default": true,
      "info": "Displays Home > Collection > Product path"
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "label": "Show SKU / Part Number",
      "default": true,
      "info": "Displays in breadcrumb bar and specs table"
    },
    {
      "type": "checkbox",
      "id": "show_key_specs",
      "label": "Show key specs chips",
      "default": true,
      "info": "Voltage, torque, motor type below image"
    },
    {
      "type": "header",
      "content": "Buy Box"
    },
    {
      "type": "checkbox",
      "id": "show_kit_builder",
      "label": "Show kit builder",
      "default": true,
      "info": "Bundle batteries, charger & case"
    },
    {
      "type": "checkbox",
      "id": "show_buy_now",
      "label": "Show Buy Now button",
      "default": true,
      "info": "Skip cart and go direct to checkout"
    },
    {
      "type": "checkbox",
      "id": "show_trust_badges",
      "label": "Show full trust badges",
      "default": false,
      "info": "Extended badges below compact version"
    },
    {
      "type": "header",
      "content": "Delivery"
    },
    {
      "type": "text",
      "id": "delivery_title",
      "label": "Delivery title",
      "default": "FREE Next Day Delivery"
    },
    {
      "type": "text",
      "id": "delivery_text",
      "label": "Delivery text",
      "default": "Order before 2pm for next working day delivery"
    }
  ]
}
{% endschema %}

