{% comment %}
  ============================================================================
  INVICTA COLLECTION FILTERS v4.0
  ============================================================================
  Production-grade multi-select filters for collection pages.
  
  Features:
  ✓ AJAX filtering (Section Rendering API) — no page reload
  ✓ pushState URL updates — back button works
  ✓ Skeleton loading state on product grid
  ✓ Debounced requests with AbortController
  ✓ Active filters appear first in each row
  ✓ Smooth CSS animations
  ✓ Full accessibility (aria-live, focus management)
  ✓ Mobile responsive
  
  Filter Logic:
  - Multiple brands = OR (Bosch OR DeWalt)

  Trade 15.4.0 Compatible
  ============================================================================
{% endcomment %}

{%- liquid
  # ========================================
  # GET ACTIVE FILTERS FROM SHOPIFY
  # ========================================
  # Use Shopify's built-in filter.active_values — reliable for multi-select
  
  assign active_brands_param = ''
  
  # Build arrays for data attributes (used by JS)
  for filter in collection.filters
    if filter.param_name == 'filter.p.vendor'
      for value in filter.active_values
        if active_brands_param == ''
          assign active_brands_param = value.label
        else
          assign active_brands_param = active_brands_param | append: '|||' | append: value.label
        endif
      endfor
    endif
    
  endfor

  assign active_brands = active_brands_param | split: '|||'
  
  # ========================================
  # BUILD SORTED FILTER DATA
  # ========================================
  # Active filters first, then sorted by count (descending)
  
  assign brand_data_active = ''
  assign brand_data_inactive = ''
  
  for filter in collection.filters
    
    # ----- BRAND FILTER (vendor) -----
    if filter.param_name == 'filter.p.vendor'
      for value in filter.values
        if value.count > 0
          assign sort_key = 99999 | minus: value.count
          assign sort_key_padded = sort_key | prepend: '00000' | slice: -5, 5
          assign brand_entry = sort_key_padded | append: '|' | append: value.label | append: '|' | append: value.count | append: '|' | append: value.param_name
          
          if value.active
            if brand_data_active == ''
              assign brand_data_active = brand_entry
            else
              assign brand_data_active = brand_data_active | append: '|||' | append: brand_entry
            endif
          else
            if brand_data_inactive == ''
              assign brand_data_inactive = brand_entry
            else
              assign brand_data_inactive = brand_data_inactive | append: '|||' | append: brand_entry
            endif
          endif
        endif
      endfor
    endif
    
  endfor
  
  # Sort each group by count
  assign brand_entries_active = brand_data_active | split: '|||' | sort
  assign brand_entries_inactive = brand_data_inactive | split: '|||' | sort
  # Check if we have filters to show
  assign has_brands = false

  if brand_entries_active.size > 0 or brand_entries_inactive.size > 0
    assign has_brands = true
  endif

  # Calculate active filter counts
  assign active_brand_count = active_brands | size
  assign total_active = active_brand_count
-%}

{%- if has_brands -%}
<div 
  id="invicta-collection-filters"
  class="inv-filters"
  data-section-id="{{ section.id }}"
  data-collection-url="{{ collection.url }}"
  data-active-brands="{{ active_brands_param | escape }}"
  data-product-grid-id="invicta-product-grid"
  role="search"
  aria-label="Product filters"
>
  
  {%- comment -%} ========== BRAND FILTER ROW ========== {%- endcomment -%}
  {%- if has_brands and section.settings.show_brand_filters -%}
  <div class="inv-filters__row inv-filters__row--brands">
    <div class="inv-filters__container page-width">
      
      <div class="inv-filters__header">
        <span class="inv-filters__label" id="brand-filter-label">
          {{ section.settings.brand_label | default: 'Filter by Brand' }}
        </span>
        {%- if active_brand_count > 0 -%}
        <span class="inv-filters__count">({{ active_brand_count }} selected)</span>
        {%- endif -%}
      </div>
      
      <div class="inv-filters__scroll-container">
        <button type="button" class="inv-filters__scroll-btn inv-filters__scroll-btn--left" aria-label="Scroll left" hidden>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        
        <div class="inv-filters__scroll-wrapper">
          <div 
            class="inv-filters__buttons" 
            data-filter-group="brand"
            role="group"
            aria-labelledby="brand-filter-label"
          >
            
            {%- comment -%} Active brands first {%- endcomment -%}
            {%- for entry in brand_entries_active -%}
              {%- if entry != blank -%}
                {%- assign entry_parts = entry | split: '|' -%}
                {%- assign brand_label = entry_parts[1] -%}
                {%- assign brand_count = entry_parts[2] -%}
                
                <button
                  type="button"
                  class="inv-filters__btn inv-filters__btn--active"
                  data-filter-value="{{ brand_label | escape }}"
                  data-filter-type="brand"
                  data-filter-param="filter.p.vendor"
                  aria-pressed="true"
                >
                  <span class="inv-filters__btn-text">{{ brand_label }}</span>
                  {%- if section.settings.show_counts -%}
                  <span class="inv-filters__btn-count">({{ brand_count }})</span>
                  {%- endif -%}
                </button>
              {%- endif -%}
            {%- endfor -%}
            
            {%- comment -%} Inactive brands {%- endcomment -%}
            {%- for entry in brand_entries_inactive -%}
              {%- if entry != blank -%}
                {%- assign entry_parts = entry | split: '|' -%}
                {%- assign brand_label = entry_parts[1] -%}
                {%- assign brand_count = entry_parts[2] -%}
                
                <button
                  type="button"
                  class="inv-filters__btn"
                  data-filter-value="{{ brand_label | escape }}"
                  data-filter-type="brand"
                  data-filter-param="filter.p.vendor"
                  aria-pressed="false"
                >
                  <span class="inv-filters__btn-text">{{ brand_label }}</span>
                  {%- if section.settings.show_counts -%}
                  <span class="inv-filters__btn-count">({{ brand_count }})</span>
                  {%- endif -%}
                </button>
              {%- endif -%}
            {%- endfor -%}
            
          </div>
        </div>
        
        <button type="button" class="inv-filters__scroll-btn inv-filters__scroll-btn--right" aria-label="Scroll right" hidden>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      </div>
      
    </div>
  </div>
  {%- endif -%}
  
  {%- comment -%} ========== ACTIVE FILTERS BAR ========== {%- endcomment -%}
  <div 
    class="inv-filters__active-bar{% if total_active == 0 %} inv-filters__active-bar--hidden{% endif %}"
    id="inv-active-filters"
    aria-live="polite"
    aria-atomic="true"
  >
    <div class="inv-filters__container page-width">
      <div class="inv-filters__active-content">
        
        <div class="inv-filters__active-left">
          <span class="inv-filters__active-label">Active filters:</span>
          
          <div class="inv-filters__active-tags" id="inv-active-tags">
            {%- for brand in active_brands -%}
              {%- if brand != blank -%}
              <span class="inv-filters__tag inv-filters__tag--brand" data-filter-value="{{ brand | escape }}" data-filter-type="brand">
                <span class="inv-filters__tag-text">{{ brand }}</span>
                <button type="button" class="inv-filters__tag-remove" aria-label="Remove {{ brand }} filter">
                  <svg width="10" height="10" viewBox="0 0 10 10" aria-hidden="true">
                    <path d="M1 1l8 8M9 1l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
              </span>
              {%- endif -%}
            {%- endfor -%}
            
          </div>
        </div>
        
        <button type="button" class="inv-filters__clear-all" id="inv-clear-all" aria-label="Clear all filters">
          Clear All
        </button>
        
      </div>
    </div>
  </div>
  
  {%- comment -%} Screen reader announcements {%- endcomment -%}
  <div class="inv-filters__sr-announce visually-hidden" aria-live="assertive" aria-atomic="true" id="inv-filters-announce"></div>
  
</div>
{%- endif -%}

{%- comment -%} ========== STYLES ========== {%- endcomment -%}
{{ 'section-invicta-collection-filters.css' | asset_url | stylesheet_tag }}

{%- comment -%} Dynamic styles that depend on Liquid section settings — must remain inline {%- endcomment -%}
<style>
  .inv-filters {
    --inv-filter-bg: {{ section.settings.background_color }};
    --inv-filter-text: {{ section.settings.text_color }};
    --inv-filter-btn-bg: {{ section.settings.button_bg }};
    --inv-filter-btn-text: {{ section.settings.button_text }};
    --inv-filter-btn-border: {{ section.settings.button_border }};
    --inv-filter-btn-active-bg: {{ section.settings.button_active_bg }};
    --inv-filter-btn-active-text: {{ section.settings.button_active_text }};
    --inv-filter-btn-hover-bg: {{ section.settings.button_hover_bg }};
    --inv-filter-tag-brand-bg: {{ section.settings.tag_brand_bg }};
    --inv-filter-active-bar-bg: {{ section.settings.active_bar_bg }};
    --inv-filter-active-bar-border: {{ section.settings.active_bar_border }};
  }
  .inv-filters__row--brands {
    background: {{ section.settings.brand_row_bg }};
  }
</style>

<script src="{{ 'invicta-collection-filters.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Invicta Filters",
  "tag": "section",
  "class": "inv-collection-filters-section",
  "limit": 1,
  "enabled_on": {
    "templates": ["collection"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Filter Visibility"
    },
    {
      "type": "checkbox",
      "id": "show_brand_filters",
      "label": "Show brand filters",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_counts",
      "label": "Show product counts",
      "default": true,
      "info": "Shows (42) next to each filter"
    },
    {
      "type": "header",
      "content": "Labels"
    },
    {
      "type": "text",
      "id": "brand_label",
      "label": "Brand filter label",
      "default": "Filter by Brand"
    },
    {
      "type": "header",
      "content": "Colours — Rows"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Default background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "brand_row_bg",
      "label": "Brand row background",
      "default": "#f9fafb"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text colour",
      "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Colours — Buttons"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_text",
      "label": "Button text",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_border",
      "label": "Button border",
      "default": "#e5e5e5"
    },
    {
      "type": "color",
      "id": "button_hover_bg",
      "label": "Button hover",
      "default": "#f5f5f5"
    },
    {
      "type": "color",
      "id": "button_active_bg",
      "label": "Active button background",
      "default": "#e11d26"
    },
    {
      "type": "color",
      "id": "button_active_text",
      "label": "Active button text",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Colours — Active Bar"
    },
    {
      "type": "color",
      "id": "active_bar_bg",
      "label": "Bar background",
      "default": "#fef2f2"
    },
    {
      "type": "color",
      "id": "active_bar_border",
      "label": "Bar border",
      "default": "#fecaca"
    },
    {
      "type": "color",
      "id": "tag_brand_bg",
      "label": "Brand tag",
      "default": "#e11d26"
    }
  ],
  "presets": [
    {
      "name": "Invicta Filters",
      "settings": {
        "show_brand_filters": true,
        "show_counts": true
      }
    }
  ]
}
{% endschema %}