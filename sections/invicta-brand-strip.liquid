{% comment %}
  ============================================================================
  INVICTA BRAND PILL STRIP v2.5 — WITH PAGE SUPPORT
  Supports both collection and page links per brand block
  ============================================================================
{% endcomment %}

{{ 'invicta-brand-pill.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign bg_color = section.settings.background_color | default: '#ffffff'
  assign pad_top = section.settings.padding_top | default: 48
  assign pad_bottom = section.settings.padding_bottom | default: 48
  assign container_width = section.settings.container_width | default: 1600
  assign container_padding = section.settings.container_padding | default: 48
  assign heading_text = section.settings.heading
  assign heading_size = section.settings.heading_size | default: 28
  assign heading_color = section.settings.heading_color | default: '#111827'
  assign heading_spacing = section.settings.heading_spacing | default: 24
  assign pill_height = section.settings.pill_height | default: 64
  assign logo_height = section.settings.logo_height | default: 42
  assign pill_padding = section.settings.pill_padding | default: 32
  assign pill_gap = section.settings.pill_gap | default: 24
  
  # Count valid blocks (must have either collection OR page)
  assign valid_block_count = 0
  for block in section.blocks
    if block.settings.brand_collection != blank or block.settings.brand_page != blank
      assign valid_block_count = valid_block_count | plus: 1
    endif
  endfor
  
  assign grid_cols = valid_block_count | at_least: 1
-%}

<style>
  /* ============================================================================
     BRAND PILL STRIP — SECTION SCOPED STYLES
     ============================================================================ */

  #shopify-section-{{ section.id }} {
    display: block !important;
    visibility: visible !important;
  }
  
  #shopify-section-{{ section.id }}::before {
    display: none !important;
    content: none !important;
  }

  #shopify-section-{{ section.id }} .invicta-brand-strip {
    display: block !important;
    visibility: visible !important;
    padding-top: clamp(20px, 3vw, {{ pad_top }}px);
    padding-bottom: clamp(16px, 2.5vw, {{ pad_bottom }}px);
    background-color: {{ bg_color }};
    width: 100%;
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__container {
    width: 100%;
    max-width: var(--inv-container, 1400px);
    margin: 0 auto;
    padding: 0 var(--inv-gutter, 24px);
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__heading {
    display: block !important;
    visibility: visible !important;
    text-align: center;
    margin-bottom: clamp(16px, 2vw, {{ heading_spacing }}px);
    font-size: clamp(20px, 2.5vw, {{ heading_size }}px);
    font-weight: 900;
    color: {{ heading_color }};
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__grid {
    display: flex !important;
    visibility: visible !important;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    width: 100%;
    gap: clamp(10px, 1.8vw, {{ pill_gap }}px);
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__item {
    display: flex !important;
    visibility: visible !important;
    flex: 1 1 auto;
    justify-content: center;
    align-items: center;
    min-width: clamp(110px, 12vw, 160px);
    max-width: clamp(160px, 18vw, 260px);
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__item .invicta-brand-pill-wrapper {
    margin: 0;
    width: 100%;
    justify-content: center;
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__item .invicta-brand-pill {
    --pill-height: clamp(44px, 5vw, {{ pill_height }}px);
    --pill-logo-height: clamp(30px, 3.5vw, {{ logo_height }}px);
    padding-inline: clamp(16px, 2.5vw, {{ pill_padding }}px);
    width: 100%;
    justify-content: center;
  }
  
  #shopify-section-{{ section.id }} .invicta-brand-strip__item .invicta-brand-pill:hover {
    transform: translateY(-3px);
  }
  
  /* DESKTOP — Grid layout */
  @media (min-width: 1200px) {
    #shopify-section-{{ section.id }} .invicta-brand-strip__grid {
      display: grid !important;
      grid-template-columns: repeat({{ grid_cols }}, 1fr) !important;
      gap: {{ pill_gap }}px !important;
      width: 100% !important;
    }
    
    #shopify-section-{{ section.id }} .invicta-brand-strip__item {
      width: 100% !important;
      max-width: none !important;
      min-width: 0 !important;
    }
    
    #shopify-section-{{ section.id }} .invicta-brand-strip__item .invicta-brand-pill-wrapper,
    #shopify-section-{{ section.id }} .invicta-brand-strip__item .invicta-brand-pill {
      width: 100% !important;
      max-width: none !important;
    }
  }
  
  /* TABLET */
  @media (min-width: 750px) and (max-width: 989px) {
    #shopify-section-{{ section.id }} .invicta-brand-strip__grid {
      justify-content: center;
    }
    
    #shopify-section-{{ section.id }} .invicta-brand-strip__item {
      flex: 0 1 calc(20% - 12px);
      min-width: 130px;
      max-width: 200px;
    }
  }
  
  /* MOBILE */
  @media (max-width: 749px) {
    #shopify-section-{{ section.id }} .invicta-brand-strip__grid {
      gap: clamp(8px, 2.5vw, 14px);
    }
    
    #shopify-section-{{ section.id }} .invicta-brand-strip__item {
      flex: 0 1 calc(33.333% - 10px);
      min-width: 100px;
      max-width: 140px;
    }
    
    #shopify-section-{{ section.id }} .invicta-brand-strip__item .invicta-brand-pill {
      --pill-height: clamp(38px, 10vw, 52px);
      --pill-logo-height: clamp(24px, 6vw, 34px);
      padding-inline: clamp(12px, 4vw, 20px);
    }
  }
  
  /* VERY SMALL SCREENS */
  @media (max-width: 420px) {
    #shopify-section-{{ section.id }} .invicta-brand-strip__item {
      flex: 0 1 calc(50% - 6px);
      min-width: 0;
      max-width: none;
    }
  }
</style>


<section class="invicta-brand-strip" data-section-id="{{ section.id }}">
  <div class="invicta-brand-strip__container">
    
    {%- if heading_text != blank -%}
      <h2 class="invicta-brand-strip__heading">{{ heading_text }}</h2>
    {%- endif -%}
    
    {%- if valid_block_count > 0 -%}
      <div class="invicta-brand-strip__grid">
        {%- for block in section.blocks -%}
          
          {%- liquid
            # ================================================================
            # BULLETPROOF LINK RESOLUTION
            # Priority: Page > Collection (page wins if both set)
            # ================================================================
            assign brand_page_setting = block.settings.brand_page
            assign brand_collection_setting = block.settings.brand_collection
            assign brand_handle = ''
            assign brand_url = ''
            
            # ----------------------------------------------------------------
            # METHOD A: Page is set — use page handle and URL
            # ----------------------------------------------------------------
            if brand_page_setting != blank
              # Page object with .handle
              if brand_page_setting.handle != blank
                assign brand_handle = brand_page_setting.handle
                assign brand_url = brand_page_setting.url
              # String handle fallback
              elsif brand_page_setting != ''
                assign brand_handle = brand_page_setting
                assign lookup_page = pages[brand_page_setting]
                if lookup_page.url != blank
                  assign brand_url = lookup_page.url
                else
                  assign brand_url = '/pages/' | append: brand_page_setting
                endif
              endif
            
            # ----------------------------------------------------------------
            # METHOD B: No page — fall back to collection
            # ----------------------------------------------------------------
            elsif brand_collection_setting != blank
              # Collection object with .handle
              if brand_collection_setting.handle != blank
                assign brand_handle = brand_collection_setting.handle
                assign brand_url = brand_collection_setting.url
              # String handle fallback
              elsif brand_collection_setting != ''
                assign brand_handle = brand_collection_setting
                assign lookup_collection = collections[brand_collection_setting]
                if lookup_collection.url != blank
                  assign brand_url = lookup_collection.url
                else
                  assign brand_url = '/collections/' | append: brand_collection_setting
                endif
              endif
            endif
          -%}
          
          {%- if brand_handle != blank -%}
            <div class="invicta-brand-strip__item" {{ block.shopify_attributes }}>
              {%- render 'invicta-brand-pill',
                vendor: brand_handle,
                url: brand_url,
                pill_context: 'strip',
                pill_size: 'lg'
              -%}
            </div>
          {%- endif -%}
          
        {%- endfor -%}
      </div>
    {%- else -%}
      <p style="text-align:center;padding:40px 20px;color:#6b7280;">Add brand blocks and select a collection or page using the section settings below.</p>
    {%- endif -%}
    
  </div>
</section>


{% schema %}
{
  "name": "Brand Pill Strip",
  "tag": "section",
  "class": "section-invicta-brand-strip",
  "max_blocks": 12,
  "settings": [
    {
      "type": "header",
      "content": "Heading"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "info": "Leave blank for no heading",
      "default": "Shop by Brand"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Max heading size",
      "min": 18,
      "max": 48,
      "step": 2,
      "default": 28,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading colour",
      "default": "#111827"
    },
    {
      "type": "range",
      "id": "heading_spacing",
      "label": "Max heading spacing",
      "min": 8,
      "max": 60,
      "step": 4,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Pill sizing (max values)"
    },
    {
      "type": "range",
      "id": "pill_height",
      "label": "Max pill height",
      "min": 44,
      "max": 80,
      "step": 2,
      "default": 64,
      "unit": "px",
      "info": "Pills auto-scale smaller on mobile"
    },
    {
      "type": "range",
      "id": "logo_height",
      "label": "Max logo height",
      "min": 28,
      "max": 56,
      "step": 2,
      "default": 42,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "pill_padding",
      "label": "Max pill padding",
      "min": 16,
      "max": 56,
      "step": 2,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "pill_gap",
      "label": "Max gap between pills",
      "min": 12,
      "max": 48,
      "step": 4,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "container_width",
      "label": "Maximum container width",
      "min": 800,
      "max": 1800,
      "step": 50,
      "default": 1600,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "container_padding",
      "label": "Max container padding",
      "min": 0,
      "max": 80,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background colour",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Max padding top",
      "min": 0,
      "max": 80,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Max padding bottom",
      "min": 0,
      "max": 80,
      "step": 4,
      "default": 48,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "brand",
      "name": "Brand",
      "settings": [
        {
          "type": "collection",
          "id": "brand_collection",
          "label": "Brand collection",
          "info": "Select a collection (ignored if page is set)"
        },
        {
          "type": "page",
          "id": "brand_page",
          "label": "Or link to page",
          "info": "Overrides collection if set — use for brands like Lamello with custom landing pages"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Brand Pill Strip",
      "blocks": [
        { "type": "brand" },
        { "type": "brand" },
        { "type": "brand" },
        { "type": "brand" },
        { "type": "brand" },
        { "type": "brand" }
      ]
    }
  ]
}
{% endschema %}