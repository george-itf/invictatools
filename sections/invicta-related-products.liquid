{% comment %}
  ============================================================================
  INVICTA RELATED PRODUCTS v1.1
  ============================================================================

  Standalone section for product recommendations on product pages.
  Uses Shopify's Product Recommendations API with section rendering.

  How it works:
    1. Initial page load shows a loading skeleton
    2. JS fetches /recommendations/products?section_id=<this-section>&product_id=X
    3. Shopify re-renders THIS section with recommendations.products populated
    4. JS swaps the skeleton for the rendered product cards

  Cards:  snippets/invicta-product-card.liquid
  Styles: assets/invicta-related-products.css

  Manual assignment:
    Merchants assign related products via the Search & Discovery app
    in Shopify admin. The API returns manual picks merged with
    auto-generated recommendations (intent=related).
  ============================================================================
{% endcomment %}

{{ 'invicta-related-products.css' | asset_url | stylesheet_tag }}

{%- style -%}
  #shopify-section-{{ section.id }} .inv-related {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media screen and (min-width: 750px) {
    #shopify-section-{{ section.id }} .inv-related {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

{%- if recommendations.performed and recommendations.products_count > 0 -%}
  {%- comment -%} === AJAX RE-RENDER: Shopify populated recommendations === {%- endcomment -%}
  <div class="inv-related" data-related-products data-product-id="{{ product.id }}">
    <div class="inv-related__container">
      <div class="inv-related__header">
        <h2 class="inv-related__title">{{ section.settings.heading }}</h2>
      </div>
      <ul class="inv-related__grid" role="list">
        {%- for product in recommendations.products limit: section.settings.products_to_show -%}
          <li class="inv-related__item">
            {% render 'invicta-product-card', product: product, card_index: forloop.index, brand_pill_type: 'text-only' %}
          </li>
        {%- endfor -%}
      </ul>
    </div>
  </div>

{%- else -%}
  {%- comment -%} === INITIAL PAGE LOAD: Show skeleton, JS will fetch === {%- endcomment -%}
  <div
    class="inv-related inv-related--hidden"
    data-related-products
    data-product-id="{{ product.id }}"
    data-limit="{{ section.settings.products_to_show }}"
  >
    <div class="inv-related__container">
      <div class="inv-related__header">
        <h2 class="inv-related__title">{{ section.settings.heading }}</h2>
      </div>
      <div class="inv-related__skeleton" data-related-skeleton>
        {%- for i in (1..4) -%}
          <div class="inv-related__skeleton-card">
            <div class="inv-related__skeleton-img"></div>
            <div class="inv-related__skeleton-body">
              <div class="inv-related__skeleton-line"></div>
              <div class="inv-related__skeleton-line"></div>
              <div class="inv-related__skeleton-price"></div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </div>

  <script>
  (function() {
    var container = document.querySelector('#shopify-section-{{ section.id }} [data-related-products]');
    if (!container) return;

    var productId = container.dataset.productId;
    var limit = container.dataset.limit || {{ section.settings.products_to_show }};
    if (!productId) return;

    var sectionId = '{{ section.id }}';
    var url = '/recommendations/products?section_id=' + sectionId + '&product_id=' + productId + '&limit=' + limit + '&intent=related';

    fetch(url)
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var temp = document.createElement('div');
        temp.innerHTML = html;
        var freshSection = temp.querySelector('[data-related-products]');

        if (freshSection && freshSection.querySelector('.inv-related__item')) {
          container.parentNode.replaceChild(freshSection, container);
        } else {
          container.remove();
        }
      })
      .catch(function() {
        container.remove();
      });
  })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Related Products",
  "tag": "section",
  "class": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "You May Also Like"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Related Products"
    }
  ]
}
{% endschema %}
