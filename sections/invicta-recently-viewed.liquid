{% comment %}
  ============================================================================
  INVICTA RECENTLY VIEWED v3.0
  ============================================================================
  Rebuilt to fix:
  - £NaN price display (was reading wrong JSON structure)
  - Broken images (was storing incomplete URLs)
  - Inconsistent card design (now matches invicta-product-card)
  
  Features:
  ✓ Tracks products on PDP via meta tags (reliable fallback)
  ✓ Fetches fresh product data via AJAX for accurate pricing
  ✓ Card design matches invicta-product-card snippet
  ✓ Works for ALL visitors via localStorage
  ✓ Logged out CTA shown below products when grid is empty
  
  Trade 15.4.0 Compatible
  ============================================================================
{% endcomment %}

{%- liquid
  # Check if customer is logged in
  assign is_logged_in = false
  if customer
    assign is_logged_in = true
  endif
-%}

<div 
  class="inv-recent"
  data-section-id="{{ section.id }}"
  data-logged-in="{{ is_logged_in }}"
  data-max-products="{{ section.settings.max_products }}"
  data-money-format="{{ shop.money_format | escape }}"
  style="
    --inv-recent-bg: {{ section.settings.background_color }};
    --inv-recent-text: {{ section.settings.text_color }};
    --inv-recent-text-muted: {{ section.settings.text_muted_color }};
    --inv-recent-accent: {{ section.settings.accent_color }};
    --inv-recent-card-bg: {{ section.settings.card_bg_color }};
    --inv-recent-card-border: {{ section.settings.card_border_color }};
  "
>
  <div class="inv-recent__container page-width">
    
    {%- comment -%} ========== RECENTLY VIEWED PRODUCTS — All visitors ========== {%- endcomment -%}
    <div class="inv-recent__logged-in" id="inv-recent-logged-in">

      <div class="inv-recent__header">
        <h2 class="inv-recent__title">{{ section.settings.title_logged_in }}</h2>
        {%- if section.settings.show_view_all -%}
        <a href="{{ section.settings.view_all_link }}" class="inv-recent__view-all">
          View All
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </a>
        {%- endif -%}
      </div>

      {%- comment -%} Product grid - populated by JavaScript from localStorage {%- endcomment -%}
      <div class="inv-recent__grid" id="inv-recent-products">
        {%- comment -%} Loading skeleton {%- endcomment -%}
        <div class="inv-recent__loading" id="inv-recent-loading">
          {%- for i in (1..4) -%}
          <div class="inv-recent__skeleton">
            <div class="inv-recent__skeleton-image"></div>
            <div class="inv-recent__skeleton-body">
              <div class="inv-recent__skeleton-line inv-recent__skeleton-line--short"></div>
              <div class="inv-recent__skeleton-line"></div>
              <div class="inv-recent__skeleton-line inv-recent__skeleton-line--medium"></div>
            </div>
          </div>
          {%- endfor -%}
        </div>

        {%- comment -%} Empty state — shown when no browsing history {%- endcomment -%}
        <div class="inv-recent__empty hidden" id="inv-recent-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <p>{{ section.settings.empty_message }}</p>
        </div>
      </div>

    </div>

    {%- comment -%} Account CTA — shown below products for logged-out visitors {%- endcomment -%}
    {%- unless is_logged_in -%}
    <div class="inv-recent__account-cta">
      <div class="inv-recent__account-cta-inner">
        <span class="inv-recent__account-cta-text">
          <strong>Create an account</strong> for trade pricing, faster checkout &amp; order tracking
        </span>
        <div class="inv-recent__account-cta-buttons">
          <a href="{{ routes.account_login_url }}" class="inv-recent__btn inv-recent__btn--primary inv-recent__btn--sm">
            {{ section.settings.login_button_text }}
          </a>
          <a href="{{ routes.account_register_url }}" class="inv-recent__btn inv-recent__btn--secondary inv-recent__btn--sm">
            {{ section.settings.register_button_text }}
          </a>
        </div>
      </div>
    </div>
    {%- endunless -%}
    
  </div>
</div>

<style>
  /* ============================================
     INVICTA RECENTLY VIEWED v3.0 — STYLES
     ============================================ */
  
  .inv-recent {
    background-color: var(--inv-recent-bg);
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
    border-top: 1px solid var(--inv-recent-card-border);
  }
  
  .inv-recent__container {
    max-width: var(--page-width, 1200px);
    margin: 0 auto;
    padding: 0 1.5rem;
  }
  
  /* ============================================
     LOGGED IN STATE
     ============================================ */
  
  .inv-recent__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .inv-recent__title {
    font-size: {{ section.settings.title_size }}px;
    font-weight: 700;
    color: var(--inv-recent-text);
    margin: 0;
  }
  
  .inv-recent__view-all {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    font-weight: 600;
    color: var(--inv-recent-accent);
    text-decoration: none;
    transition: gap 0.15s ease;
  }
  
  .inv-recent__view-all:hover {
    gap: 8px;
  }
  
  /* ============================================
     PRODUCT GRID — Horizontal scroll
     ============================================ */
  
  .inv-recent__grid {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 12px;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
    scroll-snap-type: x mandatory;
  }
  
  .inv-recent__grid::-webkit-scrollbar {
    height: 6px;
  }
  
  .inv-recent__grid::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .inv-recent__grid::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 3px;
  }
  
  /* ============================================
     LOADING SKELETON
     ============================================ */
  
  .inv-recent__loading {
    display: contents;
  }
  
  .inv-recent__loading.hidden {
    display: none;
  }
  
  .inv-recent__skeleton {
    flex-shrink: 0;
    width: {{ section.settings.card_width }}px;
    background-color: var(--inv-recent-card-bg);
    border: 1px solid var(--inv-recent-card-border);
    border-radius: {{ section.settings.card_radius }}px;
    overflow: hidden;
  }
  
  .inv-recent__skeleton-image {
    aspect-ratio: 1 / 1;
    background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: inv-shimmer 1.5s infinite;
  }
  
  .inv-recent__skeleton-body {
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .inv-recent__skeleton-line {
    height: 12px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: inv-shimmer 1.5s infinite;
    border-radius: 4px;
  }
  
  .inv-recent__skeleton-line--short {
    width: 40%;
  }
  
  .inv-recent__skeleton-line--medium {
    width: 60%;
  }
  
  @keyframes inv-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  
  /* ============================================
     PRODUCT CARD — Matches invicta-product-card
     ============================================ */
  
  .inv-recent__card {
    flex-shrink: 0;
    width: {{ section.settings.card_width }}px;
    display: flex;
    flex-direction: column;
    background-color: var(--inv-recent-card-bg);
    border: 1px solid var(--inv-recent-card-border);
    border-radius: {{ section.settings.card_radius }}px;
    overflow: hidden;
    text-decoration: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
    scroll-snap-align: start;
  }
  
  .inv-recent__card:hover {
    border-color: #ccc;
  }
  
  .inv-recent__card:focus {
    outline: 2px solid var(--inv-recent-accent);
    outline-offset: 2px;
  }
  
  /* Image */
  .inv-recent__card-image {
    position: relative;
    aspect-ratio: 1 / 1;
    background-color: #f9fafb;
    overflow: hidden;
  }
  
  .inv-recent__card-image img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 12px;
    transition: transform 0.3s ease;
  }
  
  .inv-recent__card:hover .inv-recent__card-image img {
    transform: scale(1.03);
  }
  
  /* Placeholder when no image */
  .inv-recent__card-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #d1d5db;
  }
  
  /* Sale badge */
  .inv-recent__card-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    display: inline-block;
    padding: 4px 8px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    line-height: 1.2;
    border-radius: 4px;
    background-color: #e11d26;
    color: #fff;
    z-index: 2;
  }
  
  /* Body */
  .inv-recent__card-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 14px;
    gap: 6px;
  }
  
  /* Vendor pill */
  .inv-recent__card-vendor {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background-color: #f3f4f6;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 600;
    color: #374151;
    width: fit-content;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  
  .inv-recent__card-vendor img {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }
  
  /* Title */
  .inv-recent__card-title {
    margin: 0;
    min-height: 40px;
    font-size: 13px;
    font-weight: 600;
    line-height: 1.4;
    color: var(--inv-recent-text);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Price */
  .inv-recent__card-price {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: auto;
    padding-top: 4px;
  }
  
  .inv-recent__card-price-current {
    font-size: 16px;
    font-weight: 700;
    color: var(--inv-recent-text);
  }
  
  .inv-recent__card-price-current--sale {
    color: #e11d26;
  }
  
  .inv-recent__card-price-compare {
    font-size: 12px;
    font-weight: 400;
    color: #888;
    text-decoration: line-through;
  }
  
  /* ============================================
     EMPTY STATE
     ============================================ */
  
  .inv-recent__empty {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 48px 20px;
    color: var(--inv-recent-text-muted);
  }
  
  .inv-recent__empty svg {
    margin-bottom: 16px;
    opacity: 0.5;
  }
  
  .inv-recent__empty p {
    font-size: 14px;
    margin: 0;
  }
  
  .inv-recent__empty.hidden {
    display: none;
  }
  
  /* ============================================
     LOGGED OUT STATE
     ============================================ */
  
  .inv-recent__logged-out {
    display: flex;
    justify-content: center;
  }
  
  .inv-recent__cta {
    text-align: center;
    max-width: 480px;
    padding: 20px;
  }
  
  .inv-recent__cta-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    background-color: {{ section.settings.cta_icon_bg }};
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: {{ section.settings.cta_icon_color }};
  }
  
  .inv-recent__cta-title {
    font-size: {{ section.settings.cta_title_size }}px;
    font-weight: 700;
    color: var(--inv-recent-text);
    margin: 0 0 12px;
  }
  
  .inv-recent__cta-text {
    font-size: 15px;
    color: var(--inv-recent-text-muted);
    line-height: 1.6;
    margin: 0 0 24px;
  }
  
  .inv-recent__cta-buttons {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
  }
  
  .inv-recent__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 14px 28px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    border-radius: {{ section.settings.button_radius }}px;
    transition: all 0.15s ease;
  }
  
  .inv-recent__btn--primary {
    background-color: var(--inv-recent-accent);
    color: #fff;
  }
  
  .inv-recent__btn--primary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }
  
  .inv-recent__btn--secondary {
    background-color: transparent;
    color: var(--inv-recent-text);
    border: 2px solid var(--inv-recent-card-border);
  }
  
  .inv-recent__btn--secondary:hover {
    border-color: var(--inv-recent-text);
  }
  
  /* Benefits list */
  .inv-recent__benefits {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 16px 24px;
  }
  
  .inv-recent__benefit {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--inv-recent-text-muted);
  }
  
  .inv-recent__benefit svg {
    color: {{ section.settings.benefit_check_color }};
    flex-shrink: 0;
  }
  
  /* ============================================
     ACCOUNT CTA (logged-out inline bar)
     ============================================ */

  .inv-recent__account-cta {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--inv-recent-card-border);
  }

  .inv-recent__account-cta-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .inv-recent__account-cta-text {
    font-size: 14px;
    color: var(--inv-recent-text-muted);
  }

  .inv-recent__account-cta-text strong {
    color: var(--inv-recent-text);
  }

  .inv-recent__account-cta-buttons {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .inv-recent__btn--sm {
    padding: 8px 16px;
    font-size: 13px;
  }

  /* ============================================
     RESPONSIVE
     ============================================ */
  
  @media screen and (max-width: 749px) {
    .inv-recent {
      padding: {{ section.settings.padding_top | times: 0.7 | round }}px 0 {{ section.settings.padding_bottom | times: 0.7 | round }}px;
    }
    
    .inv-recent__container {
      padding: 0 1rem;
    }
    
    .inv-recent__header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    
    .inv-recent__title {
      font-size: {{ section.settings.title_size | times: 0.85 | round }}px;
    }
    
    .inv-recent__card,
    .inv-recent__skeleton {
      width: {{ section.settings.card_width | times: 0.8 | round }}px;
    }
    
    .inv-recent__card-title {
      font-size: 12px;
      min-height: 34px;
    }
    
    .inv-recent__card-price-current {
      font-size: 14px;
    }
    
    .inv-recent__cta-buttons {
      flex-direction: column;
    }
    
    .inv-recent__btn {
      width: 100%;
    }
    
    .inv-recent__account-cta-inner {
      flex-direction: column;
      text-align: center;
    }

    .inv-recent__account-cta-buttons {
      width: 100%;
      justify-content: center;
    }
  }
  
  /* ============================================
     REDUCED MOTION
     ============================================ */
  
  @media (prefers-reduced-motion: reduce) {
    .inv-recent__card,
    .inv-recent__card-image img,
    .inv-recent__view-all {
      transition: none;
    }
    
    .inv-recent__card:hover .inv-recent__card-image img {
      transform: none;
    }
    
    .inv-recent__skeleton-image,
    .inv-recent__skeleton-line {
      animation: none;
      background: #f0f0f0;
    }
  }
</style>

<script src="{{ 'invicta-recently-viewed.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Recently Viewed",
  "tag": "section",
  "class": "inv-recently-viewed-section",
  "limit": 1,
  "settings": [
    {
      "type": "header",
      "content": "Logged In State"
    },
    {
      "type": "text",
      "id": "title_logged_in",
      "label": "Title",
      "default": "Recently Viewed"
    },
    {
      "type": "text",
      "id": "empty_message",
      "label": "Empty state message",
      "default": "You haven't viewed any products yet. Start browsing to see your history here."
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View All' link",
      "default": false
    },
    {
      "type": "url",
      "id": "view_all_link",
      "label": "'View All' link URL"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum products to show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8
    },
    {
      "type": "header",
      "content": "Logged Out State"
    },
    {
      "type": "text",
      "id": "title_logged_out",
      "label": "Title",
      "default": "See Your Recommendations"
    },
    {
      "type": "textarea",
      "id": "description_logged_out",
      "label": "Description",
      "default": "Log in or create an account to see personalised product recommendations based on your browsing history."
    },
    {
      "type": "select",
      "id": "cta_icon",
      "label": "Icon",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "user", "label": "User" },
        { "value": "history", "label": "History" },
        { "value": "star", "label": "Star" },
        { "value": "heart", "label": "Heart" }
      ],
      "default": "user"
    },
    {
      "type": "text",
      "id": "login_button_text",
      "label": "Login button text",
      "default": "Log In"
    },
    {
      "type": "text",
      "id": "register_button_text",
      "label": "Register button text",
      "default": "Create Account"
    },
    {
      "type": "checkbox",
      "id": "show_benefits",
      "label": "Show account benefits",
      "default": true
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 20,
      "max": 80,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 20,
      "max": 80,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Product Cards"
    },
    {
      "type": "range",
      "id": "card_width",
      "label": "Card width",
      "min": 140,
      "max": 220,
      "step": 10,
      "default": 180,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_image_height",
      "label": "Card image height",
      "min": 100,
      "max": 180,
      "step": 10,
      "default": 140,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "Card border radius",
      "min": 0,
      "max": 16,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Title font size",
      "min": 16,
      "max": 28,
      "step": 2,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "cta_title_size",
      "label": "CTA title font size",
      "min": 18,
      "max": 32,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Colours"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_muted_color",
      "label": "Muted text",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent / buttons",
      "default": "#e11d26"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card border",
      "default": "#e5e5e5"
    },
    {
      "type": "header",
      "content": "CTA Styling"
    },
    {
      "type": "color",
      "id": "cta_icon_bg",
      "label": "Icon background",
      "default": "#f5f5f5"
    },
    {
      "type": "color",
      "id": "cta_icon_color",
      "label": "Icon colour",
      "default": "#1a1a1a"
    },
    {
      "type": "range",
      "id": "button_radius",
      "label": "Button border radius",
      "min": 0,
      "max": 12,
      "step": 2,
      "default": 6,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "benefit_check_color",
      "label": "Benefit checkmark colour",
      "default": "#10b981"
    }
  ],
  "blocks": [
    {
      "type": "benefit",
      "name": "Account Benefit",
      "limit": 6,
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Track your orders"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed",
      "blocks": [
        {
          "type": "benefit",
          "settings": {
            "text": "Track your orders"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "text": "Save favourite products"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "text": "Faster checkout"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "text": "Exclusive trade pricing"
          }
        }
      ]
    }
  ]
}
{% endschema %}